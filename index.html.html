<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ระบบสต็อกสินค้า บริษัท เดอะ ซัพพอร์ต จำกัด</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Chart.js for Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script>
    // ตั้งค่าธีม Tailwind CSS
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Kanit', 'sans-serif'], // ใช้ Kanit เป็นฟอนต์หลัก
          },
          colors: {
            base: { bg: '#0a0b12', card: '#121326', line: '#1f2140' },
            neon: { blue: '#4cc1ff', violet: '#a78b45', fuchsia: '#ff6bff', cyan: '#3fe3ff' }
          },
          boxShadow: {
            neonBlue: '0 0 22px rgba(76,193,255,.35)',
            neonViolet: '0 0 22px rgba(167,139,250,.35)',
          }
        }
      }
    }
  </script>
  <style>
    /* Ensure HTML and Body take full height and width, and set background */
    html {
      height: 100%;
      width: 100%;
    }
    body {
      font-family: 'Kanit', sans-serif;
      background-color: #0a0b12; /* Explicit background from base.bg */
      min-height: 100vh; /* Use viewport height */
      width: 100vw; /* Use viewport width */
      display: flex; /* Make body a flex container */
      margin: 0;
      padding: 0;
      overflow-x: hidden; /* Prevent horizontal scroll on body */
    }

    /* Neon Gradient for buttons and progress bar from user's code */
    .neon-gradient {
      background: linear-gradient(135deg, #3b82f6, #8b5cf6, #06b6d4);
      background-size: 200% 200%;
      animation: gradientShift 3s ease infinite;
    }

    /* Neon Glow for main elements/buttons from user's code */
    .neon-glow {
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.5), 0 0 40px rgba(139, 92, 246, 0.3);
    }

    /* Pulse Ring animation for refresh button from user's code */
    .pulse-ring {
      position: absolute;
      border: 2px solid rgba(59, 130, 246, 0.6);
      border-radius: 50%;
      animation: pulseRing 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
    }

    /* Refresh Spin animation for icon from user's code */
    .refresh-spin {
      animation: refreshSpin 1s linear infinite;
    }

    /* Progress Bar styles from user's code */
    .progress-bar {
      width: 0%;
      transition: width 2s ease-in-out;
    }
    .progress-active {
      width: 100%;
    }

    /* Ripple effect for refresh button from user's code */
    .ripple {
      position: absolute;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.6);
      transform: scale(0);
      animation: rippleEffect 0.6s linear;
      pointer-events: none;
    }

    /* Keyframes from user's provided code */
    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    @keyframes pulseRing {
      0% {
        transform: scale(0.33);
        opacity: 1;
      }
      80%, 100% {
        transform: scale(2.5);
        opacity: 0;
      }
    }

    @keyframes refreshSpin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    @keyframes rippleEffect {
      to {
        transform: scale(4);
        opacity: 0;
      }
    }

    /* Menu item styles from user's provided code */
    .menu-item {
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      display: flex; /* Added for consistency with current layout */
      align-items: center; /* Added for consistency with current layout */
      padding: 1rem 1.5rem; /* px-6 py-4 */
      cursor: pointer;
      color: #D1D5DB; /* text-gray-300 default */
      gap: 0.75rem; /* space-x-3 equivalent for flex gap */
    }

    .menu-item:hover {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
      transform: translateX(8px);
      color: white; /* Ensure text is white on hover */
    }

    .menu-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 3px;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      transform: scaleY(0);
      transition: transform 0.3s ease;
    }

    .menu-item:hover::before {
      transform: scaleY(1);
    }

    /* Active tab style */
    .menu-item.tab-active { 
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
      color: white; /* Active text color */
    }
    .menu-item.tab-active::before {
      transform: scaleY(1); /* Active indicator */
    }

    .glow-border {
      box-shadow: inset 0 0 0 1px rgba(167,139,250,.45), 0 0 16px rgba(76,193,255,.18);
    }
    .glow-focus:focus { outline: none; box-shadow: 0 0 0 3px rgba(76,193,255,.35); }
    
    /* Original spin animation - kept for general use */
    .spin { animation: spin 0.9s linear infinite; } 
    @keyframes spin { to { transform: rotate(360deg); } }

    .table th { background: rgba(76,193,255,.10); font-weight: 600; }
    .table tr:hover { background: rgba(167,139,250,.10); }
    /* Make select options text black as requested */
    select option { color: #111827; }
    /* Datalist input style */
    input[list] {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
    }
    
    /* === Sidebar & Main Content - Responsive adjustments === */
    /* Base styles for sidebar and main content */
    .sidebar-wrapper {
        position: fixed; /* Changed to fixed for mobile slide-out effect */
        top: 0;
        left: 0;
        height: 100vh;
        width: 16rem; /* w-64 */
        background-color: #1f2937; /* bg-gray-800 */
        overflow-y: auto;
        transform: translateX(0%); /* Default to visible on desktop */
        transition: transform 0.3s ease-in-out; /* Add transition */
        z-index: 50; /* Ensure sidebar is above other content on mobile */
    }

    .main-content-wrapper {
        flex: 1;
        min-width: 0;
        overflow-y: auto;
        margin-left: 0; /* Default for desktop */
        transition: margin-left 0.3s ease-in-out; /* Add transition */
    }

    /* Mobile-specific styles */
    @media (max-width: 767px) { /* md:hidden equivalent */
        .sidebar-wrapper {
            transform: translateX(-100%); /* Hidden by default on mobile */
        }
        .sidebar-wrapper.sidebar-open { /* Class added by JS when sidebar is open */
            transform: translateX(0%);
        }
        .main-content-wrapper {
            margin-left: 0; /* No margin on mobile */
            padding-top: 5rem; /* Space for fixed mobile header */
        }
        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40; /* Between mobile header and sidebar */
            display: none; /* Hidden by default */
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
        }
        .sidebar-overlay.overlay-active {
            display: block;
            opacity: 1;
        }
    }

    /* Custom modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background-color: #1f2937; /* bg-gray-800 */
      padding: 2rem;
      border-radius: 0.75rem; /* rounded-xl */
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); /* neon-glow effect */
      max-width: 700px;
      width: 95%;
      text-align: center;
    }
    #outOfStockModal .modal-content {
      max-height: 80vh;
      overflow-y: auto;
    }


    /* Specific modal style for lot details to allow more content */
    #lotDetailModal .modal-content {
      max-width: 600px; /* Wider for lot details */
      text-align: left; /* Align text left for readability */
    }
        /* เพิ่มใน <style> เดิมของคุณ (แนะนำวางไว้ท้ายสุดใน <head>) */
    
    /* --- ปรับ sidebar ไม่ให้ทับ main-content บน desktop --- */
    @media (min-width: 768px) {
      .sidebar-wrapper {
        left: 0;
        top: 0;
        height: 100vh;
        width: 16rem;
        position: fixed;
        z-index: 50;
      }
      .main-content-wrapper {
        margin-left: 16rem; /* ขยับเนื้อหาออกจาก sidebar */
      }
    }
    
    /* บนมือถือ (max-width: 767px) ให้ sidebar ซ้อนทับและ main-content ไม่มี margin */
    @media (max-width: 767px) {
      .main-content-wrapper {
        margin-left: 0 !important;
      }
    }
        /* --- Force text color to white for form controls and table --- */
    select, input, textarea, option, table, th, td {
      color: #fff !important;
      background-color: inherit;
    }
    
    /* Option in dropdown (for most browsers) */
    select option {
      color: #fff !important;
      background: #1f2937 !important; /* ให้ dropdown list เป็นพื้นเข้ม */
    }
    
    /* Table header and cell text */
    .table th, .table td {
      color: #fff !important;
    }
    
    /* For autofill background in Chrome */
    input:-webkit-autofill, textarea:-webkit-autofill, select:-webkit-autofill {
      -webkit-text-fill-color: #fff !important;
      box-shadow: 0 0 0px 1000px #1f2937 inset;
    }
  </style>
</head>
<body class="bg-gray-900 text-white">
  <!-- Mobile Header - แสดงเฉพาะมือถือ -->
  <header class="md:hidden bg-blue-600 text-white shadow-lg fixed top-0 left-0 right-0 z-40">
    <div class="px-4 py-4 flex justify-between items-center">
        <h1 class="text-xl font-bold">📦 ระบบคลังวัสดุก่อสร้าง</h1>
        <button id="sidebarToggle" class="p-2 rounded-lg hover:bg-blue-700 transition-colors">
            <!-- ปุ่ม Hamburger -->
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>
    </div>
  </header>

  <!-- Overlay สำหรับมือถือ -->
  <div id="sidebarOverlay" class="sidebar-overlay"></div>

  <!-- Sidebar -->
  <div id="sidebar" class="sidebar-wrapper">
    <div class="p-6 border-b border-gray-700 flex items-center justify-between">
      <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
        The Support
      </h1>
      <!-- Close button for mobile sidebar -->
      <button id="sidebarClose" class="md:hidden p-1 rounded-lg text-gray-400 hover:bg-gray-700">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <nav class="mt-6">
      <div data-tab="dashboard" class="menu-item tab-active">
        <i class="fas fa-tachometer-alt text-blue-400 w-5"></i>
        <span>Dashboard</span>
      </div>
      <div data-tab="add-product" class="menu-item">
        <i class="fas fa-cubes text-green-400 w-5"></i>
        <span>จัดการสินค้า</span>
      </div>
      <div data-tab="add-vendor" class="menu-item">
        <i class="fas fa-handshake text-yellow-400 w-5"></i>
        <span>จัดการผู้ขาย</span>
      </div>
      <div data-tab="add-project" class="menu-item">
        <i class="fas fa-building text-purple-400 w-5"></i>
        <span>จัดการโครงการ</span>
      </div>
      <div data-tab="purchase" class="menu-item">
        <i class="fas fa-shopping-cart text-orange-400 w-5"></i>
        <span>ซื้อสินค้า</span>
      </div>
      <div data-tab="issue" class="menu-item">
        <i class="fas fa-box-open text-pink-400 w-5"></i>
        <span>เบิกสินค้า</span>
      </div>
      
      <!-- Reports Dropdown -->
      <div id="toggleReportsDropdown" class="menu-item justify-between">
        <div class="flex items-center gap-3">
          <i class="fas fa-chart-bar text-cyan-400 w-5"></i>
          <span>รายงาน</span>
        </div>
        <i id="reportsDropdownArrow" class="fas fa-chevron-down transform transition-transform duration-200 text-gray-400"></i>
      </div>
      <div id="reportsDropdown" class="ml-4 mt-1 space-y-1 hidden">
        <div data-tab="report" class="menu-item text-sm">รายงานสต็อก</div>
        <div data-tab="vendors-list" class="menu-item text-sm">รายงานผู้ขาย</div>
        <div data-tab="project-expenditure-report" class="menu-item text-sm">รายงานโครงการ</div>
      </div>
      <div data-tab="budget-estimate" class="menu-item">
        <i class="fas fa-calculator text-cyan-400 w-5"></i>
        <span>คำนวณงบประมาณโครงการ</span>
      </div>
      <!-- End Reports Dropdown -->

      <div data-tab="settings" class="menu-item">
        <i class="fas fa-cogs text-gray-400 w-5"></i>
        <span>ตั้งค่า</span>
      </div>
    </nav>
  </div>

  <!-- Main Content -->
  <div id="mainContentWrapper" class="main-content-wrapper">
    <!-- Inner div for consistent padding on all content -->
    <div class="content-padded-wrapper p-4 sm:p-6 lg:p-8 pb-8">
      <header class="flex items-center justify-between w-full mb-8">
        <h2 class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
          ระบบคลังวัสดุก่อสร้าง
        </h2>

        <!-- Refresh Button and its elements -->
        <div class="flex flex-col items-end">
          <button id="refreshBtn" class="relative neon-gradient neon-glow px-4 py-2 rounded-full font-semibold text-white text-sm transition-all duration-300 hover:scale-105 active:scale-95 overflow-hidden">
            <i id="refreshIcon" class="fas fa-sync-alt mr-2"></i>
            <span id="btnLabel">Refresh</span>
          </button>
          <div class="w-24 bg-gray-700 rounded-full h-1.5 mt-2 overflow-hidden">
            <div id="progressBar" class="progress-bar h-full neon-gradient rounded-full relative">
              <div class="absolute inset-0 bg-white opacity-30 animate-pulse"></div>
            </div>
          </div>
          <div id="statusText" class="text-gray-400 text-xs font-medium mt-1">
            พร้อมรีเฟรช
          </div>
        </div>
      </header>

      <section id="tab-dashboard" class="tab-section">
        <h2 class="text-2xl md:text-3xl font-bold text-white mb-6">ภาพรวม Dashboard</h2>
        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-gray-800 rounded-xl p-6 card-hover border border-gray-700">
            <p class="text-gray-300 text-sm">สต็อกคงเหลือรวม</p>
            <div class="flex items-end gap-2 mt-2">
                <h2 id="kpiTotalQty" class="text-3xl font-bold text-white">-</h2>
                <span class="text-xs text-gray-400">หน่วย</span>
            </div>
            <p id="kpiUpdatedAt" class="text-sm text-gray-400 mt-2">อัปเดตล่าสุด: -</p>
            </div>
            <div class="bg-gray-800 rounded-xl p-6 card-hover border border-gray-700">
            <p class="text-gray-300 text-sm">มูลค่าคลังสินค้า</p>
            <div class="flex items-end gap-2 mt-2">
                <h2 id="kpiStockValue" class="text-3xl font-bold text-white">-</h2>
                <span class="text-xs text-gray-400">บาท</span>
            </div>
            <p class="text-sm text-gray-400 mt-2">มูลค่าปัจจุบัน</p>
            </div>
            <div class="bg-gray-800 rounded-xl p-6 card-hover border border-gray-700">
            <p class="text-gray-300 text-sm">จำนวนสินค้าทั้งหมด</p>
            <div class="flex items-end gap-2 mt-2">
                <h2 id="kpiProductCount" class="text-3xl font-bold text-white">-</h2>
                <span class="text-xs text-gray-400">รายการ</span>
            </div>
            <p class="text-sm text-gray-400 mt-2">Active</p>
            </div>
            <div class="bg-gray-800 rounded-xl p-6 card-hover border border-gray-700">
            <p class="text-gray-300 text-sm">มูลค่า Deadstock</p>
            <div class="flex items-end gap-2 mt-2">
                <h2 id="kpiDeadValue" class="text-3xl font-bold text-red-400">-</h2>
                <span class="text-xs text-gray-400">บาท</span>
            </div>
            <p class="text-sm text-gray-400 mt-2" id="kpiDeadPercent">-</p>
            </div>
        </div>

        <!-- Alerts -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 mb-6">
            <h3 class="font-semibold text-xl mb-4 text-orange-400">🔔 การแจ้งเตือน</h3>
            <div id="alertsContainer" class="space-y-3">
            <div class="text-gray-400 text-sm">กำลังโหลดการแจ้งเตือน...</div>
            </div>
        </div>

        <!-- Top 5 สินค้าเคลื่อนไหวเร็ว -->
        <div class="bg-gray-800 rounded-xl p-6 mb-6 border border-gray-700">
            <h3 class="font-semibold text-green-400 mb-4">Top 5 สินค้าเบิกสูงสุด</h3>
            <div id="topIssuedList" class="space-y-2"></div>
        </div>

        <!-- Top 5 มูลค่าการเบิกสูงสุด -->
        <div class="bg-gray-800 rounded-xl p-6 mb-6 border border-gray-700">
            <h3 class="font-semibold text-blue-400 mb-4">Top 5 มูลค่าการเบิกสูงสุด</h3>
            <div id="topStockValueList" class="space-y-2"></div>
        </div>

        <!-- Chart ตัวอย่าง (ถ้าต้องการ) -->
        <div class="bg-gray-800 rounded-xl p-6 mb-6 border border-gray-700">
            <h3 class="font-semibold text-pink-400 mb-4">มูลค่าการซื้อรายเดือน</h3>
            <div class="chart-container" style="height:300px;">
            <canvas id="purchaseChart"></canvas>
            </div>
        </div>
        </section>

        <!-- ADD/EDIT/DELETE PRODUCT -->
        <section id="tab-add-product" class="tab-section hidden">
          <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 mb-6">
            <h2 id="addProductTitle" class="text-2xl md:text-3xl font-bold text-green-400 mb-6">จัดการสินค้า (เพิ่ม/แก้ไข/ลบ)</h2>
            <form id="addProductForm" class="grid grid-cols-1 gap-y-4">
              <input type="hidden" id="editingProductId" value="">

              <div>
                <label class="block text-sm text-gray-300">ชื่อย่อหมวด</label>
                <input list="abbrevOptions" type="text" id="addAbbrev" name="addAbbrev" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" required/>
                <datalist id="abbrevOptions"></datalist>
              </div>
              <div>
                <label class="block text-sm text-gray-300">รหัส</label>
                <input list="codeOptions" type="text" id="addCode" name="addCode" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" required/>
                <datalist id="codeOptions"></datalist>
              </div>
              <div>
                <label class="block text-sm text-gray-300">ขนาด, สี, จำเพาะอื่นๆ</label>
                <input type="text" id="addSpecs" name="addSpecs" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" required/>
              </div>
              <div>
                <label class="block text-sm text-gray-300">รหัสสินค้า</label>
                <input type="text" id="addSku" name="addSku" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" required readonly/>
              </div>
              <div>
                <label class="block text-sm text-gray-300">ชื่อสินค้า</label>
                <div class="flex items-center gap-2 mt-1">
                  <input type="text" id="addProductName" name="addProductName" class="flex-grow bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" required/>
                </div>
              </div>
              <div>
                <label class="block text-sm text-gray-300">หน่วยนับ</label>
                <input type="text" id="addUnit" name="addUnit" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" required/>
              </div>
              <div>
                <label class="block text-sm text-gray-300">จำนวนขั้นต่ำ</label>
                <input type="number" id="addMinQty" name="minQty" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" value="0"/>
              </div>
              <div class="flex items-center justify-end gap-3 mt-4">
                <span id="aiProductNameStatus" class="text-sm text-gray-300 flex items-center gap-2"></span>
                <button type="submit" id="submitProductBtn" class="px-5 py-2.5 rounded-md bg-green-600 hover:bg-green-700 text-white font-medium transition">บันทึกสินค้า</button>
                <button type="button" id="cancelEditProductBtn" class="hidden px-5 py-2.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white font-medium transition">ยกเลิกแก้ไข</button>
                <span id="addProductStatus" class="text-sm text-gray-300"></span>
              </div>
            </form>
          </div>

          <!-- Current Products List for Management -->
          <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <h3 class="font-semibold text-xl mb-4 text-green-400">รายการสินค้าปัจจุบัน</h3>
            <div class="mb-4">
              <input type="text" id="manageProductsSearch" placeholder="ค้นหา (รหัสสินค้า / ชื่อสินค้า)" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500"/>
            </div>
            <div class="overflow-auto border border-gray-700 rounded-lg">
              <table class="w-full table">
                <thead>
                  <tr class="text-left text-sm text-gray-300">
                    <th class="px-4 py-3">รหัสสินค้า</th>
                    <th class="px-4 py-3">ชื่อสินค้า</th>
                    <th class="px-4 py-3">หน่วย</th>
                    <th class="px-4 py-3 text-right">จำนวนขั้นต่ำ</th>
                    <th class="px-4 py-3 text-center">จัดการ</th>
                  </tr>
                </thead>
                <tbody id="manageProductsTableBody" class="text-sm">
                  <tr><td class="px-4 py-3 text-gray-400" colspan="5">กำลังโหลดรายการสินค้า...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- ADD/EDIT/DELETE VENDOR -->
        <section id="tab-add-vendor" class="tab-section hidden">
          <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 mb-6">
            <h2 id="addVendorTitle" class="text-2xl md:text-3xl font-bold text-yellow-400 mb-6">จัดการผู้ขาย (เพิ่ม/แก้ไข/ลบ)</h2>
            <form id="addVendorForm" class="grid grid-cols-1 gap-y-4">
              <input type="hidden" id="editingVendorId" value="">

              <div>
                <label class="block text-sm text-gray-300">รหัส Vendors</label>
                <input type="text" id="addVendorCode" name="vendorCode" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" required readonly/>
              </div>
              <div>
                <label class="block text-sm text-gray-300">Vender (ชื่อผู้ขาย)</label>
                <input type="text" id="addVendorName" name="vendorName" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" required/>
              </div>
              <div>
                <label class="block text-sm text-gray-300">ที่อยู่</label>
                <textarea id="addVendorAddress" name="vendorAddress" rows="2" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500"></textarea>
              </div>
              <div>
                <label class="block text-sm text-gray-300">เบอร์โทร</label>
                <input type="tel" id="addVendorPhone" name="vendorPhone" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500"/>
              </div>
              <div>
                <label class="block text-sm text-gray-300">ประเภทจดทบ.</label>
                <input list="regTypeOptions" type="text" id="addVendorRegType" name="vendorRegType" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500"/>
                <datalist id="regTypeOptions"></datalist>
              </div>
              <div class="flex items-center justify-end gap-3 mt-4">
                <span id="addVendorStatus" class="text-sm text-gray-300"></span>
                <button type="submit" id="submitVendorBtn" class="px-5 py-2.5 rounded-md bg-yellow-600 hover:bg-yellow-700 text-white font-medium transition">บันทึกผู้ขาย</button>
                <button type="button" id="cancelEditVendorBtn" class="hidden px-5 py-2.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white font-medium transition">ยกเลิกแก้ไข</button>
              </div>
            </form>
          </div>

          <!-- Current Vendors List for Management -->
          <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <h3 class="font-semibold text-xl mb-4 text-yellow-400">รายการผู้ขายปัจจุบัน</h3>
            <div class="mb-4">
              <input type="text" id="manageVendorsSearch" placeholder="ค้นหา (รหัสผู้ขาย / ชื่อผู้ขาย)" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500"/>
            </div>
            <div class="overflow-auto border border-gray-700 rounded-lg">
              <table class="w-full table">
                <thead>
                  <tr class="text-left text-sm text-gray-300">
                    <th class="px-4 py-3">รหัส Vendors</th>
                    <th class="px-4 py-3">Vender</th>
                    <th class="px-4 py-3">ที่อยู่</th>
                    <th class="px-4 py-3">เบอร์โทร</th>
                    <th class="px-4 py-3">ประเภทจดทบ.</th>
                    <th class="px-4 py-3 text-center">จัดการ</th>
                  </tr>
                </thead>
                <tbody id="manageVendorsTableBody" class="text-sm">
                  <tr><td class="px-4 py-3 text-gray-400" colspan="6">กำลังโหลดรายการผู้ขาย...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- ADD/EDIT/DELETE PROJECT -->
        <section id="tab-add-project" class="tab-section hidden">
          <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 mb-6">
            <h2 id="addProjectTitle" class="text-2xl md:text-3xl font-bold text-purple-400 mb-6">จัดการโครงการ (เพิ่ม/แก้ไข/ลบ)</h2>
            <form id="addProjectForm" class="grid grid-cols-1 gap-y-4">
              <input type="hidden" id="editingProjectId" value="">

              <div>
                <label class="block text-sm text-gray-300">Customer</label>
                <input list="projectCustomerOptions" type="text" id="addProjectCustomer" name="projectCustomer" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" required/>
                <datalist id="projectCustomerOptions"></datalist>
              </div>
              <div>
                <label class="block text-sm text-gray-300">โครงการ</label>
                <input type="text" id="addProjectName" name="projectName" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" required/>
              </div>
              <div>
                <label class="block text-sm text-gray-300">ชื่อย่อ</label>
                <input type="text" id="addProjectShortName" name="projectShortName" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"/>
              </div>
              <div>
                <label class="block text-sm text-gray-300">รหัส (เลข)</label>
                <input type="text" id="addProjectCodeNum" name="projectCodeNum" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"/>
              </div>
              <div>
                <label class="block text-sm text-gray-300">ประเภท</label>
                <input list="projectTypeOptions" type="text" id="addProjectType" name="projectType" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"/>
                <datalist id="projectTypeOptions"></datalist>
              </div>
              <div>
                <label class="block text-sm text-gray-300">CODE (Text)</label>
                <input list="projectCodeTextOptions" type="text" id="addProjectCodeText" name="projectCodeText" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"/>
                <datalist id="projectCodeTextOptions"></datalist>
              </div>
              <div>
                <label class="block text-sm text-gray-300">เฟส</label>
                <input list="projectPhaseOptions" type="text" id="addProjectPhase" name="projectPhase" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"/>
                <datalist id="projectPhaseOptions"></datalist>
              </div>
              <div>
                <label class="block text-sm text-gray-300">ซอย</label>
                <input list="projectAlleyOptions" type="text" id="addProjectAlley" name="projectAlley" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"/>
                <datalist id="projectAlleyOptions"></datalist>
              </div>
              <div>
                <label class="block text-sm text-gray-300">บ้านเลขที่</label>
                <input type="text" id="addProjectHouseNo" name="projectHouseNo" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"/>
              </div>
              <div>
                <label class="block text-sm text-gray-300">รายละเอียด</label>
                <div class="flex items-center gap-2 mt-1">
                  <textarea id="addProjectDetail" name="projectDetail" rows="2" class="flex-grow bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                </div>
              </div>
              <div>
                <label class="block text-sm text-gray-300">กำหนดรหัสจุด</label>
                <input type="text" id="addProjectCombinedCode" name="projectCombinedCode" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" readonly/>
              </div>
              <div class="flex items-center justify-end gap-3 mt-4">
                <span id="aiProjectDetailStatus" class="text-sm text-gray-300 flex items-center gap-2"></span>
                <button type="submit" id="submitProjectBtn" class="px-5 py-2.5 rounded-md bg-purple-600 hover:bg-purple-700 text-white font-medium transition">บันทึกโครงการ</button>
                <button type="button" id="cancelEditProjectBtn" class="hidden px-5 py-2.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white font-medium transition">ยกเลิกแก้ไข</button>
                <span id="addProjectStatus" class="text-sm text-gray-300"></span>
              </div>
            </form>
          </div>
          <!-- Current Projects List for Management -->
          <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <h3 class="font-semibold text-xl mb-4 text-purple-400">รายการโครงการปัจจุบัน</h3>
            <div class="mb-4">
              <input type="text" id="manageProjectsSearch" placeholder="ค้นหา (รหัสโครงการ / ชื่อโครงการ)" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"/>
            </div>
            <div class="overflow-auto border border-gray-700 rounded-lg">
              <table class="w-full table">
                <thead>
                  <tr class="text-left text-sm text-gray-300">
                    <th class="px-4 py-3">รหัสจุดเบิก</th>
                    <th class="px-4 py-3">โครงการ</th>
                    <th class="px-4 py-3">ลูกค้า</th>
                    <th class="px-4 py-3">ชื่อย่อ</th>
                    <th class="px-4 py-3">รหัส</th>
                    <th class="px-4 py-3">ประเภท</th>
                    <th class="px-4 py-3">CODE</th>
                    <th class="px-4 py-3">เฟส</th>
                    <th class="px-4 py-3">ซอย</th>
                    <th class="px-4 py-3">บ้านเลขที่</th>
                    <th class="px-4 py-3 text-center">จัดการ</th>
                  </tr>
                </thead>
                <tbody id="manageProjectsTableBody" class="text-sm">
                  <tr><td class="px-4 py-3 text-gray-400" colspan="4">กำลังโหลดรายการโครงการ...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- PURCHASE -->
        <section id="tab-purchase" class="tab-section hidden">
          <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <h3 class="font-semibold text-orange-400 mb-4">บันทึกซื้อสินค้า</h3>
            <!-- โค้ด UI (Canva): ฟอร์มบันทึกซื้อ -->
            <form id="purchaseForm" class="grid grid-cols-1 gap-y-4">
              <div>
                <label class="text-sm text-gray-300">วันที่ซื้อ</label>
                <input type="date" id="purchaseDate" name="purchaseDate" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500"/>
              </div>
              <div>
                <label class="text-sm text-gray-300">สินค้า</label>
                <input id="purchaseProduct" list="purchaseProductOptions" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="ค้นหาสินค้า (รหัส/ชื่อ)">
                <datalist id="purchaseProductOptions"></datalist>
              </div>
              <div>
                <label class="text-sm text-gray-300">ผู้ขาย (Vender)</label>
                <input id="purchaseVendor" list="purchaseVendorOptions" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="ค้นหาผู้ขาย (รหัส/ชื่อ)">
                <datalist id="purchaseVendorOptions"></datalist>    
              </div>
              <div>
                <label class="text-sm text-gray-300">จำนวนที่ซื้อ</label>
                <input id="purchaseQty" type="number" min="0" step="0.01" placeholder="0" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500"/>
              </div>
              <div>
                <label class="text-sm text-gray-300">ราคาต่อหน่วย</label>
                <input id="purchasePrice" type="number" min="0" step="0.01" placeholder="0.00" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500"/>
              </div>
            <div>
              <label class="text-sm text-gray-300">ส่วนลด (บาท)</label>
              <input id="purchaseDiscount" type="number" min="0" step="0.01" placeholder="0.00" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500"/>
            </div>
              <div>
                <label for="purchaseOtherCost" class="block text-sm text-gray-300">ต้นทุนอื่นๆ</label>
                <input type="number" step="0.01" min="0" id="purchaseOtherCost" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0.00"/>
              </div>
              <div id="purchaseTotalPreview" class="text-lg font-bold text-orange-400 mt-2"></div>
              <div>
                <label class="text-sm text-gray-300">หมายเหตุ (ถ้ามี)</label>
                <input id="purchaseNote" type="text" placeholder="ใส่หมายเหตุ" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500"/>
              </div>
              <div class="flex items-center gap-3 mt-4">
                <button type="submit" class="px-5 py-2.5 rounded-md bg-orange-600 hover:bg-orange-700 text-white font-medium transition">บันทึกการซื้อ (สร้าง Lot)</button>
                <span id="purchaseStatus" class="text-sm text-gray-300"></span>
              </div>
            </form>
          </div>
        </section>

        <!-- ISSUE -->
        <section id="tab-issue" class="tab-section hidden">
          <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <h3 class="font-semibold text-pink-400 mb-4">เบิกสินค้า (FIFO)</h3>
            <!-- โค้ด UI (Canva): ฟอร์มเบิกสินค้า -->
            <form id="issueForm" class="grid grid-cols-1 gap-y-4">
              <div>
                <label class="text-sm text-gray-300">วันที่เบิก</label>
                <input type="date" id="issueDate" name="issueDate" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pink-500"/>
              </div>
            <div>
                <label class="text-sm text-gray-300">สินค้า</label>
                <input id="issueProduct" list="issueProductOptions" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="ค้นหาสินค้า (รหัส/ชื่อ)">
                <datalist id="issueProductOptions"></datalist>
            </div>
            <div>
                <label class="text-sm text-gray-300">โครงการ</label>
                <input id="issueProject" list="issueProjectOptions" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="ค้นหาโครงการ (รหัส/ชื่อ)">
                <datalist id="issueProjectOptions"></datalist>
            </div>
              <div>
                <label class="text-sm text-gray-300">จำนวนที่ต้องการเบิก</label>
                <input id="issueQty" type="number" min="0" step="0.01" placeholder="0" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pink-500"/>
              </div>
              <div class="flex items-end">
                <button type="button" id="simulateFIFO" class="w-full px-5 py-2.5 rounded-md bg-pink-600 hover:bg-pink-700 text-white font-medium transition">คลิกเพื่อตรวจสอบ Lot</button>
              </div>
              <div>
                <label class="block text-sm text-gray-300">Lot ที่จะถูกตัด</label>
                <div id="fifoResult" class="text-sm text-gray-200 bg-gray-700 border border-gray-600 rounded-md p-3 min-h-[56px]">
                  — แสดงผลลัพธ์ที่นี่ —
                </div>
                <div>
                  <label class="text-sm text-gray-300" for="issueRemark">หมายเหตุ</label>
                  <input id="issueRemark" name="issueRemark" type="text"
                         class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pink-500"
                         placeholder="ใส่หมายเหตุ (ถ้ามี)"/>
                </div>
              </div>
              <div class="flex items-center gap-3 mt-4">
                <button type="submit" class="px-5 py-2.5 rounded-md bg-pink-600 hover:bg-pink-700 text-white font-medium transition">บันทึกการเบิก</button>
                <span id="issueStatus" class="text-sm text-gray-300"></span>
              </div>
            </form>
          </div>
        </section>

        <!-- REPORT (รายงานสต็อก) -->
        <section id="tab-report" class="tab-section hidden">
          <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <div class="flex items-center justify-between mb-3">
              <h3 class="font-semibold text-blue-400">📊 รายงานสต็อก (StockReport)</h3>
            <button id="exportSelectedStockBtn" class="px-5 py-2 rounded bg-green-600 hover:bg-green-700 text-white font-medium transition hidden">
        ส่งออก Excel
      </button>
            </div>
            <div class="mb-4">
              <input type="text" id="reportSearch" placeholder="ค้นหา (รหัสสินค้า / ชื่อสินค้า)" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"/> 
            </div>
            <div class="overflow-auto border border-gray-700 rounded-lg">
              <table class="w-full table">
                <thead>
                  <tr class="text-left text-sm text-gray-300">
                    <th class="px-4 py-3 text-center"><input type="checkbox" id="selectAllStock"></th>
                    <th class="px-4 py-3">รหัสสินค้า</th>
                    <th class="px-4 py-3">ชื่อสินค้า</th>
                    <th class="px-4 py-3">สินค้าที่ซื้อทั้งหมด</th>
                    <th class="px-4 py-3">เบิกทั้งหมด</th>
                    <th class="px-4 py-3 text-right">คงเหลือ</th>
                    <th class="px-4 py-3 text-right">ขั้นต่ำ</th>
                    <th class="px-4 py-3 text-right">ต้นทุนเฉลี่ย/ชิ้น</th>
                    <th class="px-4 py-3 text-right">ต้นทุนรวม</th>
                    <th class="px-4 py-3 text-center">การเคลื่อนไหว</th>
                    <th class="px-4 py-3 text-center">จัดการ</th>
                  </tr>
                </thead>
                <tbody id="reportBody" class="text-sm">
                  <tr><td class="px-4 py-3 text-gray-400" colspan="8">กดปุ่มรีเฟรชเพื่อโหลดข้อมูล</td></tr>
                </tbody>
              </table>
              <div class="flex justify-end mt-4">
                <button id="exportSelectedStockBtn" class="px-5 py-2 rounded bg-green-600 hover:bg-green-700 text-white font-medium transition hidden">ส่งออก Excel
              </button>
            </div>
            </div>

            <div class="mt-4 text-xs text-gray-400">Fast = เคลื่อนไหวบ่อย • Deadstock = ไม่เคลื่อนไหวนาน</div>
          </div>
        </section>

        <!-- VENDORS LIST (รายงานผู้ขาย) -->
        <section id="tab-vendors-list" class="tab-section hidden">
          <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <div class="flex items-center justify-between mb-3">
              <h3 class="font-semibold text-green-400">🚚 รายงานผู้ขาย (Vendors)</h3>
              <button id="exportSelectedVendorsBtn" class="px-5 py-2 rounded bg-green-600 hover:bg-green-700 text-white font-medium transition hidden">
                    รายละเอียดผู้ขายส่งออก Excel
              </button>
            </div>
            <div class="mb-4">
                <input type="text" id="vendorSearch" placeholder="ค้นหา (รหัสผู้ขาย / ชื่อผู้ขาย)" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500"/>
            </div>
            <div class="overflow-auto border border-gray-700 rounded-lg">
              <table class="w-full table">
                <thead>
                  <tr class="text-left text-sm text-gray-300">
                    <th class="px-4 py-3 text-center"><input type="checkbox" id="selectAllVendors"></th>
                    <th class="px-4 py-3">รหัส Vendors</th>
                    <th class="px-4 py-3">Vender</th>
                    <th class="px-4 py-3">ที่อยู่</th>
                    <th class="px-4 py-3">เบอร์โทร</th>
                    <th class="px-4 py-3">ประเภทจดทบ.</th>
                    <th class="px-4 py-3 text-center">ดูประวัติ/ส่งออก</th>
                  </tr>
                </thead>
                <tbody id="vendorBody" class="text-sm">
                  <tr><td class="px-4 py-3 text-gray-400" colspan="5">กดปุ่มรีเฟรชเพื่อโหลดข้อมูล</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <div>
          <section id="tab-project-expenditure-report" class="tab-section hidden">
            <div>
              <label class="block text-sm text-gray-300">เลือกโครงการ (เลือกได้หลายโครงการ)</label>
                <input type="text" id="projectMultiSearch" placeholder="ค้นหาโครงการ..." class="w-full mb-2 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500"/>
                <div class="flex items-center mb-2">
                  <input type="checkbox" id="selectAllProjects" class="mr-2">
                  <label for="selectAllProjects" class="text-sm">เลือกทั้งหมด</label>
                </div>
                <div id="projectMultiSelect" class="max-h-40 overflow-y-auto bg-gray-700 border border-gray-600 rounded-md px-3 py-2 space-y-1"></div>
              </div>
              <div>
                <label class="block text-sm text-gray-300 mt-4">เลือกสินค้าในโครงการ (เลือกได้หลายสินค้า)</label>
                <input type="text" id="productMultiSearch" placeholder="ค้นหาสินค้า..." class="w-full mb-2 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500"/>
                <div class="flex items-center mb-2">
                  <input type="checkbox" id="selectAllProducts" class="mr-2">
                  <label for="selectAllProducts" class="text-sm">เลือกทั้งหมด</label>
                </div>
                <div id="productMultiSelect" class="max-h-40 overflow-y-auto bg-gray-700 border border-gray-600 rounded-md px-3 py-2 space-y-1"></div>
              </div>
              <div class="flex items-end mt-4">
                <button id="viewProjectExpenditureBtn" class="w-full px-5 py-2.5 rounded-md bg-cyan-600 hover:bg-cyan-700 text-white font-medium transition">ดูค่าใช้จ่ายโครงการ</button>
                <button id="exportProjectExpenditureBtn" class="ml-2 px-4 py-2 rounded bg-green-600 hover:bg-green-700 text-white font-medium transition text-sm">ส่งออก Excel</button>
              </div>
              <div id="projectExpenditureResult" class="text-sm text-gray-200 bg-gray-700 border border-gray-600 rounded-md p-3 min-h-[60px] mt-2">
                เลือกโครงการและกด "ดูค่าใช้จ่ายโครงการ" เพื่อดูรายละเอียด...
              </div>
                </div>
              </section>
                <!-- Section: คำนวณงบประมาณโครงการในอนาคต -->
        <section id="tab-budget-estimate" class="tab-section hidden">
          <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-semibold text-cyan-400 text-xl mb-0">คำนวณงบประมาณโครงการในอนาคต</h3>
              <button id="exportSelectedBudgetEstimateBtn" class="px-5 py-2 rounded bg-green-600 hover:bg-green-700 text-white font-medium transition hidden">
                ส่งออก Excel
              </button>
            </div>
            <div class="mb-4 grid grid-cols-1 md:grid-cols-2 gap-4">
              <input type="text" id="budgetEstimateProductSearch" placeholder="ค้นหาสินค้า (รหัส/ชื่อ)" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500"/>
              <input type="text" id="budgetEstimateVendorSearch" placeholder="ค้นหาผู้ขาย (รหัส/ชื่อ)" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500"/>
            </div>
            <div id="budgetEstimateSummary" class="mb-4 text-sm text-gray-300"></div>
            <div class="overflow-auto border border-gray-700 rounded-lg">
              <table class="w-full table">
                <thead>
                  <tr class="text-left text-sm text-gray-300">
                    <th class="px-4 py-3 text-center"><input type="checkbox" id="selectAllBudgetEstimate"></th>
                    <th class="px-4 py-3">วันที่ซื้อ</th>
                    <th class="px-4 py-3">รหัสสินค้า</th>
                    <th class="px-4 py-3">ชื่อสินค้า</th>
                    <th class="px-4 py-3">จำนวนซื้อ</th>
                    <th class="px-4 py-3">จำนวนคงเหลือ</th>
                    <th class="px-4 py-3">ราคาต่อหน่วย</th>
                    <th class="px-4 py-3">มูลค่ารวม</th>
                    <th class="px-4 py-3">ผู้ขาย</th>
                  </tr>
                </thead>
                <tbody id="budgetEstimateTableBody" class="text-sm">
                  <tr><td class="px-4 py-3 text-gray-400" colspan="5">กรุณาค้นหาสินค้า</td></tr>
                </tbody>
              </table>
              <div class="flex justify-end mt-4">
                <button id="exportSelectedBudgetEstimateBtn" class="px-5 py-2 rounded bg-green-600 hover:bg-green-700 text-white font-medium transition hidden">ส่งออก Excel</button>
              </div>
            </div>
          </div>
        </section>
        <!-- SETTINGS -->
        <section id="tab-settings" class="tab-section hidden">
          <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <h3 class="font-semibold text-xl mb-4 text-gray-400">⚙️ การตั้งค่า</h3>
            <p class="text-gray-400">หน้านี้จะเป็นที่สำหรับตั้งค่าต่างๆ ในอนาคต</p>
          </div>
        </section>
    </div> <!-- End content-padded-wrapper -->
  </div>

  <!-- Custom Confirmation Modal -->
  <div id="customConfirmModal" class="modal-overlay hidden">
    <div class="modal-content">
      <p id="confirmMessage" class="text-lg text-gray-200 mb-6">คุณแน่ใจหรือไม่?</p>
      <div class="flex justify-center gap-4">
        <button id="confirmYes" class="px-6 py-2 rounded-md bg-red-600 hover:bg-red-700 text-white font-medium transition">ใช่</button>
        <button id="confirmNo" class="px-6 py-2 rounded-md bg-gray-600 hover:bg-gray-700 text-white font-medium transition">ยกเลิก</button>
      </div>
    </div>
  </div>

  <!-- New: Lot Detail Modal -->
  <div id="lotDetailModal" class="modal-overlay hidden">
    <div class="modal-content">
      <h3 id="lotDetailModalTitle" class="text-xl font-bold text-blue-400 mb-4"></h3>
      <div id="lotDetailContent" class="space-y-3 text-gray-300">
        <!-- Lot details will be rendered here -->
      </div>
      <button id="closeLotDetailModal" class="mt-6 px-6 py-2 rounded-md bg-gray-600 hover:bg-gray-700 text-white font-medium transition">ปิด</button>
    </div>
  </div>

  <div id="outOfStockModal" class="modal-overlay hidden">
    <div class="modal-content relative">
    <button id="closeOutOfStockModal" class="absolute top-10 right-10 text-gray-400 hover:text-white text-xl font-bold focus:outline-none" title="ปิด">
      &times;
    </button>
      <h3 class="text-xl font-bold text-red-400 mb-4">รายการสินค้าหมดสต็อก</h3>
      <div id="outOfStockList" class="space-y-2 text-gray-300"></div>
      <button id="closeOutOfStockModal" class="mt-6 px-6 py-2 rounded-md bg-gray-600 hover:bg-gray-700 text-white font-medium transition">ปิด</button>
    </div>
  </div>
  <div id="vendorPurchaseModal" class="modal-overlay hidden">
    <div class="modal-content max-w-2xl w-full text-left">
        <button id="closeVendorPurchaseModal" class="absolute top-6 right-8 text-gray-400 hover:text-white text-2xl font-bold focus:outline-none" title="ปิด">&times;</button>
        <h3 id="vendorPurchaseModalTitle" class="text-xl font-bold text-blue-400 mb-4"></h3>
        <div id="vendorPurchaseList" class="space-y-2 text-gray-300 max-h-[60vh] overflow-y-auto"></div>
        <button id="closeVendorPurchaseModal2" class="mt-6 px-6 py-2 rounded-md bg-gray-600 hover:bg-gray-700 text-white font-medium transition">ปิด</button>
    </div>
</div>
  <script>
    // Utilities
    const sleep = (ms)=> new Promise(r=>setTimeout(r, ms));

    // Custom Confirmation Dialog (NOT alert/confirm)
    function showCustomConfirm(message) {
        return new Promise((resolve) => {
            const modal = document.getElementById('customConfirmModal');
            const confirmMessage = document.getElementById('confirmMessage');
            const confirmYes = document.getElementById('confirmYes');
            const confirmNo = document.getElementById('confirmNo');

            confirmMessage.innerHTML = message; // Use innerHTML for potential HTML in message
            modal.classList.remove('hidden');

            const handleYes = () => {
                modal.classList.add('hidden');
                confirmYes.removeEventListener('click', handleYes);
                confirmNo.removeEventListener('click', handleNo);
                resolve(true);
            };

            const handleNo = () => {
                modal.classList.add('hidden');
                confirmYes.removeEventListener('click', handleYes);
                confirmNo.removeEventListener('click', handleNo);
                resolve(false);
            };

            confirmYes.addEventListener('click', handleYes);
            confirmNo.addEventListener('click', handleNo);
        });
    }

    // Gemini API call function (with exponential backoff)
    async function callGeminiAPI(prompt, statusEl) {
        // AI generation is disabled for these buttons
        return Promise.reject(new Error('ฟังก์ชัน AI ถูกปิดใช้งานสำหรับปุ่มนี้'));
    }


    document.addEventListener('DOMContentLoaded', () => {
      // =========================
      // Responsive Design JavaScript Logic - FOR HAMBURGER MENU
      // =========================
      const sidebarToggle = document.getElementById('sidebarToggle');
      const sidebarClose = document.getElementById('sidebarClose');
      const sidebar = document.getElementById('sidebar');
      const sidebarOverlay = document.getElementById('sidebarOverlay');
      const mainContentWrapper = document.getElementById('mainContentWrapper');

      function openSidebar() {
          sidebar.classList.add('sidebar-open');
          sidebarOverlay.classList.add('overlay-active');
          document.body.style.overflow = 'hidden'; // Prevent scrolling on body when sidebar is open
      }

      function closeSidebar() {
          sidebar.classList.remove('sidebar-open');
          sidebarOverlay.classList.remove('overlay-active');
          document.body.style.overflow = ''; // Restore scrolling on body
      }

      // Only attach event listeners if elements exist
      if (sidebarToggle) {
          sidebarToggle.addEventListener('click', openSidebar);
      }
      if (sidebarClose) {
          sidebarClose.addEventListener('click', closeSidebar);
      }
      if (sidebarOverlay) {
          sidebarOverlay.addEventListener('click', closeSidebar);
      }

      // Close sidebar when clicking menu items on mobile
      const menuItems = document.querySelectorAll('.menu-item');
      menuItems.forEach(item => {
          item.addEventListener('click', function() {
              if (window.innerWidth < 768) { // Only on mobile
                  closeSidebar();
              }
          });
      });

      // Adjust layout on resize
      window.addEventListener('resize', () => {
          if (window.innerWidth >= 768) { // If it's desktop size or larger
              sidebar.classList.remove('sidebar-open'); // Ensure sidebar is always visible
              sidebarOverlay.classList.remove('overlay-active'); // Hide overlay
              document.body.style.overflow = ''; // Restore body scrolling
          }
          const qtyEl = document.getElementById('purchaseQty');
        const priceEl = document.getElementById('purchasePrice');
        const otherCostEl = document.getElementById('purchaseOtherCost');
        const discountEl = document.getElementById('purchaseDiscount');
        const totalPreviewEl = document.getElementById('purchaseTotalPreview');
        
        function updateTotalPreview() {
            const qty = parseFloat(qtyEl?.value || '0');
            const price = parseFloat(priceEl?.value || '0');
            const otherCost = parseFloat(otherCostEl?.value || '0');
            const discount = parseFloat(discountEl?.value || '0');
            let total = qty * price + otherCost - discount;
            if (total < 0) total = 0;
            if (totalPreviewEl) {
                totalPreviewEl.textContent = `ยอดรวม: ${total.toLocaleString('th-TH', {minimumFractionDigits:2})} บาท`;
      }
}    
    [qtyEl, priceEl, otherCostEl,discountEl].forEach(el => {
        if (el) el.addEventListener('input', updateTotalPreview);
    });
    updateTotalPreview()
    });
    const tabs = [
      'dashboard','add-product','add-vendor','add-project','purchase','issue',
      'report', 'vendors-list', 'project-expenditure-report', 'budget-estimate', 'settings'
    ];

    const tabButtons = document.querySelectorAll('.menu-item');
      
    const sections = {};
      tabs.forEach(t => {
        const el = document.getElementById('tab-' + t);
          if (el) {
              sections[t] = el;
          }
      
      });
      
      const reportsDropdown = document.getElementById('reportsDropdown');
      const toggleReportsDropdownBtn = document.getElementById('toggleReportsDropdown');
      const reportsDropdownArrow = document.getElementById('reportsDropdownArrow');

      function setActiveTab(name){
        // Hide all sections, then show the active one
        Object.values(sections).forEach(section => section.classList.add('hidden'));
        if (sections[name]) {
            sections[name].classList.remove('hidden');
        }
        
        // Remove active styling from all tab buttons
        tabButtons.forEach(b=>b.classList.remove('tab-active'));
        if (toggleReportsDropdownBtn) { 
          toggleReportsDropdownBtn.classList.remove('tab-active');
        }

        // Add active styling to the clicked tab button
        const clickedTabButton = document.querySelector(`.menu-item[data-tab="${name}"]`);
        if (clickedTabButton) {
          clickedTabButton.classList.add('tab-active');
        } else if (['report', 'vendors-list', 'project-expenditure-report'].includes(name)) {
          // If a report sub-item is clicked, activate the main Reports dropdown button
          if (toggleReportsDropdownBtn) {
            toggleReportsDropdownBtn.classList.add('tab-active');
          }
          const subItem = reportsDropdown.querySelector(`[data-tab="${name}"]`);
          if (subItem) subItem.classList.add('tab-active'); // Also highlight the sub-item
        }


        // Handle reports dropdown visibility and styling
        if (['report', 'vendors-list', 'project-expenditure-report'].includes(name)) {
          if (reportsDropdown) { 
            reportsDropdown.classList.remove('hidden');
          }
          if (reportsDropdownArrow) { 
            reportsDropdownArrow.classList.add('rotate-180'); 
          }
        } else {
          if (reportsDropdown) { 
            reportsDropdown.classList.add('hidden');
          }
          if (reportsDropdownArrow) { 
            reportsDropdownArrow.classList.remove('rotate-180'); 
          }
        }

        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
      
      // Attach click listeners to all menu items for tab switching
      tabButtons.forEach(btn=>{
        if(btn.id !== 'toggleReportsDropdown') {
          btn.addEventListener('click', ()=>setActiveTab(btn.dataset.tab));
        }
      });
      
      // Specific click listener for the main Reports dropdown toggle
      if (toggleReportsDropdownBtn) { 
        toggleReportsDropdownBtn.addEventListener('click', () => {
          if (reportsDropdown) {
            reportsDropdown.classList.toggle('hidden');
          }
          if (reportsDropdownArrow) { 
            reportsDropdownArrow.classList.toggle('rotate-180'); 
          }
        });
      }
      
      // Default active tab
      setActiveTab('dashboard');  

      // =========================
      // Google Apps Script Integration
      // =========================
      // คุณสามารถหา URL เหล่านี้ได้ในโปรเจกต์ Google Apps Script ของคุณที่:
      // Deploy -> New deployment -> เลือกประเภท "Web app" -> คัดลอก URL
      const READ_API = 'https://script.google.com/macros/s/AKfycbwUIOOrpz5OuBTozDFROkA4_Lxfm8P4N2DuY_DeOplhjiLjiXuCYmGGsVPXDJ0aqh4R/exec'; 
      const WRITE_API = 'https://script.google.com/macros/s/AKfycbwUIOOrpz5OuBTozDFROkA4_Lxfm8P4N2DuY_DeOplhjiLjiXuCYmGGsVPXDJ0aqh4R/exec';

      let cache = { 
        products: [], vendors: [], projects: [], stockReport: [], lots: [], 
        // Modified: `recentActivities` now expected to contain a `value` property for each activity
        recentActivities: [], 
        topIssued: [], topStockValue: [], monthlyActivity: { labels: [], purchase: [], issue: [] }, 
        projectExpenditureData: [],
        lastUpdated: null, nextVendorCode: '001', nextProjectNo: 1, nextPurchaseNo: 1 
      };
    function populateProductDatalist() {
        const datalist = document.getElementById('purchaseProductOptions');
        if (!datalist) return;
        datalist.innerHTML = '';
        cache.products.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p['รหัสสินค้า'];
            opt.label = `${p['รหัสสินค้า']} — ${p['ชื่อสินค้า']}`;
            datalist.appendChild(opt);
        });
        }
    
    function populateVendorDatalist() {
        const datalist = document.getElementById('purchaseVendorOptions');
        if (!datalist) return;
        datalist.innerHTML = '';
        cache.vendors.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v['รหัส Vendors'];
            opt.label = `${v['รหัส Vendors']} — ${v['Vender']}`;
            datalist.appendChild(opt);
        });
        }

    function populateIssueProductDatalist() {
      const datalist = document.getElementById('issueProductOptions');
      if (!datalist) return;
      datalist.innerHTML = '';
      cache.products.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p['รหัสสินค้า'];
        opt.label = `${p['รหัสสินค้า']} — ${p['ชื่อสินค้า']}`;
        datalist.appendChild(opt);
      });
    }
    
    function populateIssueProjectDatalist() {
      const datalist = document.getElementById('issueProjectOptions');
      if (!datalist) return;
      datalist.innerHTML = '';
      cache.projects.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p['กำหนดรหัสจุด'];
        opt.label = `${p['กำหนดรหัสจุด']} — ${p['โครงการ']}${p['ชื่อย่อ'] ? ' ('+p['ชื่อย่อ']+')' : ''}`;
        datalist.appendChild(opt);
      });
    }

      // Chart instances - REMOVED
      // let dailyMovementLineChart = null;
      // let dailyMovementDoughnutChart = null;

      // --- Refresh Button UI elements ---
      const refreshBtn = document.getElementById('refreshBtn');
      const refreshIcon = document.getElementById('refreshIcon');
      const btnLabel = document.getElementById('btnLabel');
      const progressBar = document.getElementById('progressBar');
      const statusText = document.getElementById('statusText');
      const dashboardActivityList = document.getElementById('activityList'); // Original recent activities list

      let isRefreshing = false;

      // Function to create ripple effect
      function createRipple(e) {
        const button = e.currentTarget;
        const rect = button.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const x = e.clientX - rect.left - size / 2;
        const y = e.clientY - rect.top - size / 2;

        const ripple = document.createElement('div');
        ripple.classList.add('ripple');
        ripple.style.width = ripple.style.height = size + 'px';
        ripple.style.left = x + 'px';
        ripple.style.top = y + 'px';

        button.appendChild(ripple);

        // Create pulse rings
        for (let i = 0; i < 3; i++) {
          setTimeout(() => {
            const ring = document.createElement('div');
            ring.classList.add('pulse-ring');
            ring.style.width = ring.style.height = '60px';
            ring.style.left = '50%';
            ring.style.top = '50%';
            ring.style.marginLeft = '-30px';
            ring.style.marginTop = '-30px';

            button.appendChild(ring);

            setTimeout(() => ring.remove(), 1500);
          }, i * 200);
        }

        setTimeout(() => ripple.remove(), 600);
      }

      // Function to start refresh process
      async function startRefresh() {
        isRefreshing = true;
        if (refreshIcon) refreshIcon.classList.add('refresh-spin');
        if (btnLabel) btnLabel.textContent = 'กำลังรีเฟรช...';
        if (refreshBtn) refreshBtn.classList.add('opacity-80');
        if (progressBar) {
          progressBar.classList.remove('progress-active');
          progressBar.style.width = '0%';
        }
        setTimeout(() => {
          if (progressBar) progressBar.classList.add('progress-active');
        }, 100);

        // Update status text with animation
        const statuses = [
          'เชื่อมต่อเซิร์ฟเวอร์...',
          'ดาวน์โหลดข้อมูล...',
          'ประมวลผลข้อมูล...',
          'อัพเดทหน้าจอ...',
          'เสร็จสิ้น!'
        ];

        let errorDuringLoad = false;
        try {
        for (let i = 0; i < statuses.length; i++) {
          if (statusText) {
            statusText.textContent = statuses[i];
            statusText.classList.add('text-blue-400');
          }
          if (statuses[i] === 'ดาวน์โหลดข้อมูล...') {
            await loadAll(); // โหลดข้อมูลจริง
          }
          // ลด sleep เหลือ 0 หรือ 100ms
          await sleep(i === statuses.length - 1 ? 0 : 100);
        }
        } catch (error) {
          errorDuringLoad = true;
          console.error("Error during refresh process:", error);
          if (statusText) {
            statusText.textContent = `เกิดข้อผิดพลาด: ${error.message}`;
            statusText.classList.remove('text-blue-400');
            statusText.classList.add('text-red-400');
          }
        } finally {
          completeRefresh(errorDuringLoad);
        }
      }

      // Function to complete refresh process
      function completeRefresh(hadError = false) {
        // Reset button state
        if (refreshIcon) refreshIcon.classList.remove('refresh-spin');
        if (btnLabel) btnLabel.textContent = 'Refresh';
        if (refreshBtn) refreshBtn.classList.remove('opacity-80');

        // Reset progress bar
        setTimeout(() => {
          if (progressBar) {
            progressBar.classList.remove('progress-active');
            progressBar.style.width = '0%';
          }
        }, 500);

        // Update status
        if (!hadError) {
          if (statusText) {
            statusText.textContent = 'รีเฟรชเสร็จสิ้น!';
            statusText.classList.remove('text-blue-400', 'text-red-400');
            statusText.classList.add('text-green-400');
          }
        }
        // If there was an error, statusText is already updated by startRefresh

        // Reset status after 2 seconds
        setTimeout(() => {
          if (statusText) {
            statusText.textContent = 'พร้อมรีเฟรช';
            statusText.classList.remove('text-green-400', 'text-red-400', 'text-blue-400');
          }
          isRefreshing = false;
        }, 2000);

        // Add success pulse to button
        if (refreshBtn) {
          refreshBtn.classList.add('animate-pulse');
          setTimeout(() => {
            refreshBtn.classList.remove('animate-pulse');
          }, 1000);
        }
      }

      // Attach click handler to refresh button
      if (refreshBtn) {
        refreshBtn.addEventListener('click', function(e) {
          if (isRefreshing) return;
          createRipple(e);
          startRefresh();
        });
      }

      // Prepend activity function for Dashboard
      function prependActivity(text){
        if (!dashboardActivityList) return; 
        const li = document.createElement('div');
        li.className = 'flex items-center justify-between bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-sm';
        li.textContent = text;
        dashboardActivityList.prepend(li);

        const items = dashboardActivityList.querySelectorAll('div');
        if (items.length > 6) items[items.length-1].remove();
      }

      // Placeholder setting function
      function setPlaceholders(){
        const minList = document.getElementById('minList');
        if (minList) minList.innerHTML = `<div class="text-gray-400 text-sm">กำลังโหลด...</div>`;
        
        const dashboardActivityList = document.getElementById('activityList');
        if (dashboardActivityList) dashboardActivityList.innerHTML = `<div class="text-gray-400 text-sm">กำลังโหลด...</div>`;
        
        const reportBody = document.getElementById('reportBody');
        if (reportBody) reportBody.innerHTML = `<tr><td class="px-4 py-3 text-gray-400" colspan="8">กำลังโหลด...</td></tr>`;
        
        const kpiTotalQty = document.getElementById('kpiTotalQty');
        if (kpiTotalQty) kpiTotalQty.textContent = '-';
        
        const kpiStockValue = document.getElementById('kpiStockValue');
        if (kpiStockValue) kpiStockValue.textContent = '-';
        
        const kpiDead = document.getElementById('kpiDead');
        if (kpiDead) kpiDead.textContent = '-';
        
        const kpiSlow = document.getElementById('kpiSlow');
        if (kpiSlow) kpiSlow.textContent = '-'; // Set to '-' since the card is hidden
        
        const kpiUpdatedAt = document.getElementById('kpiUpdatedAt');
        if (kpiUpdatedAt) kpiUpdatedAt.textContent = 'อัปเดตล่าสุด: -';
        
        const alertsContainer = document.getElementById('alertsContainer');
        if (alertsContainer) alertsContainer.innerHTML = `<div class="text-gray-400 text-sm">กำลังโหลดการแจ้งเตือน...</div>`; 
        
        const vendorBody = document.getElementById('vendorBody');
        if (vendorBody) vendorBody.innerHTML = `<tr><td class="px-4 py-3 text-gray-400" colspan="5">กำลังโหลด...</td></tr>`;
        
        const projectBody = document.getElementById('projectBody');
        if (projectBody) projectBody.innerHTML = `<tr><td class="px-4 py-3 text-gray-400" colspan="4">กำลังโหลด...</td></tr>`; 
        
        const projectExpenditureResult = document.getElementById('projectExpenditureResult');
        if (projectExpenditureResult) projectExpenditureResult.innerHTML = `เลือกโครงการเพื่อดูค่าใช้จ่ายรวม...`;

        const addProductStatus = document.getElementById('addProductStatus');
        if(addProductStatus) addProductStatus.textContent = '';
        const addVendorStatus = document.getElementById('addVendorStatus');
        if(addVendorStatus) addVendorStatus.textContent = '';
        const addProjectStatus = document.getElementById('addProjectStatus');
        if(addProjectStatus) addProjectStatus.textContent = '';

        // Reset daily activity summary
        const dailyActivityList = document.getElementById('dailyActivityList');
        if (dailyActivityList) dailyActivityList.innerHTML = `<div class="text-gray-400 text-sm">กำลังโหลดกิจกรรมรายวัน...</div>`;
      
        // Clear charts and their related text - REMOVED
      }

      // Error display function
      function showError(msg){
        // Update the main status text with a more prominent error message
        if (statusText) {
          statusText.textContent = `ข้อผิดพลาด: ${msg}`;
          statusText.classList.remove('text-blue-400', 'text-green-400');
          statusText.classList.add('text-red-400');
        }

        const minList = document.getElementById('minList');
        if (minList) minList.innerHTML = `<div class="text-red-400 text-sm">${msg}</div>`;
        
        const dashboardActivityList = document.getElementById('activityList');
        if (dashboardActivityList) dashboardActivityList.innerHTML = `<div class="text-red-400 text-sm">${msg}</div>`;
        
        const reportBody = document.getElementById('reportBody');
        if (reportBody) reportBody.innerHTML = `<tr><td class="px-4 py-3 text-red-400" colspan="8">${msg}</td></tr>`;
        
        const kpiTotalQty = document.getElementById('kpiTotalQty');
        if (kpiTotalQty) kpiTotalQty.textContent = 'Error';
        
        const kpiStockValue = document.getElementById('kpiStockValue');
        if (kpiStockValue) kpiStockValue.textContent = 'Error';
        
        const kpiDead = document.getElementById('kpiDead');
        if (kpiDead) kpiDead.textContent = 'Error';
        
        const kpiSlow = document.getElementById('kpiSlow');
        if (kpiSlow) kpiSlow.textContent = 'Error';
        
        const kpiUpdatedAt = document.getElementById('kpiUpdatedAt');
        if (kpiUpdatedAt) kpiUpdatedAt.textContent = 'Error';
        
        const alertsContainer = document.getElementById('alertsContainer');
        if (alertsContainer) alertsContainer.innerHTML = `<div class="text-red-400 text-sm">${msg}</div>`; 
        
        const vendorBody = document.getElementById('vendorBody');
        if (vendorBody) vendorBody.innerHTML = `<tr><td class="px-4 py-3 text-red-400" colspan="5">${msg}</td></tr>`;
        
        const projectBody = document.getElementById('projectBody');
        if (projectBody) projectBody.innerHTML = `<tr><td class="px-4 py-3 text-red-400" colspan="4">${msg}</td></tr>`; 

        const projectExpenditureResult = document.getElementById('projectExpenditureResult');
        if (projectExpenditureResult) projectExpenditureResult.innerHTML = `<span class="text-red-400">${msg}</span>`;

        const addProductStatus = document.getElementById('addProductStatus');
        if(addProductStatus) addProductStatus.innerHTML = `<span class="text-red-400">${msg}</span>`;
        const addVendorStatus = document.getElementById('addVendorStatus');
        if(addVendorStatus) addVendorStatus.innerHTML = `<span class="text-red-400">${msg}</span>`;
        const addProjectStatus = document.getElementById('addProjectStatus');
        if(addProjectStatus) addProjectStatus.innerHTML = `<span class="text-red-400">${msg}</span>`;

        const dailyActivityList = document.getElementById('dailyActivityList');
        if (dailyActivityList) dailyActivityList.innerHTML = `<div class="text-red-400 text-sm">${msg}</div>`;
      }

      // Load all data function
      async function loadAll(){
        setPlaceholders(); // Call placeholders before fetching
        try{
          // NOTE: The previous check for placeholder URLs has been removed as they are now set.
          // The error "กรุณาอัปเดต URL ของ Apps Script Web App..." should no longer appear.

          const res = await fetch(READ_API, { method: 'GET' });
          if(!res.ok) {
              const errorText = await res.text();
              throw new Error(`โหลดข้อมูลไม่สำเร็จ (Status: ${res.status}, Message: ${errorText.substring(0, 100)}...)`);
          }
          const data = await res.json();
          cache.products = Array.isArray(data.products)?data.products:[];
          cache.vendors = Array.isArray(data.vendors)?data.vendors:[];
          cache.projects = Array.isArray(data.projects)?data.projects:[]; 
          cache.stockReport = Array.isArray(data.stockReport)?data.stockReport:[];
          cache.lots = Array.isArray(data.lots)?data.lots:[];
          
          // Assuming `recentActivities` now contains `value`
          cache.recentActivities = Array.isArray(data.recentActivities)?data.recentActivities:[];
          
          cache.topIssued = Array.isArray(data.topIssued)?data.topIssued:[];
          cache.topStockValue = Array.isArray(data.topStockValue)?data.topStockValue:[]; 
          cache.monthlyActivity = data.monthlyActivity || { labels: [], purchase: [], issue: [] };
          cache.projectExpenditureData = Array.isArray(data.projectExpenditureData)?data.projectExpenditureData:[];

          cache.lastUpdated = new Date();

          cache.nextVendorCode = data.nextVendorCode || '001';
          cache.nextProjectNo = data.nextProjectNo || 1;
          cache.nextPurchaseNo = data.nextPurchaseNo || 1; 

          // Debugging: Log the cache content
          console.log("Cache Products after loadAll:", cache.products);
          console.log("Cache Vendors after loadAll:", cache.vendors);
          console.log("Cache Projects after loadAll:", cache.projects);
          console.log("Cache Lots after loadAll:", cache.lots);
          console.log("Next Project No (Internal, for reference):", cache.nextProjectNo);
          console.log("Recent Activities (expected with value):", cache.recentActivities);

          function padVendorCode(num) {return String(num).padStart(3, '0');}cache.nextVendorCode = padVendorCode(data.nextVendorCode || '1');


          renderDropdowns();

          // New: Populate datalist for product search in Project Expenditure Report
          populateDatalist('productOptionsProjectReport', cache.products, item => item['ชื่อสินค้า']);

          populateDatalist('abbrevOptions', cache.products, item => item['ชื่อย่อหมวด']);
          populateDatalist('codeOptions', cache.products, item => item['รหัส']); 
          populateDatalist('regTypeOptions', cache.vendors, item => item['ประเภทจดทบ.']);
          populateDatalist('projectCustomerOptions', cache.projects, item => item['Customer']);
          populateDatalist('projectTypeOptions', cache.projects, item => item['ประเภท']);
          populateDatalist('projectCodeTextOptions', cache.projects, item => item['CODE']);
          populateDatalist('projectPhaseOptions', cache.projects, item => item['เฟส']);
          populateDatalist('projectAlleyOptions', cache.projects, item => item['ซอย']);

          renderDashboard();
          renderReport();
          renderVendors();
          renderVendorMultiSelect(); 
          renderProjects(); 
          renderManageProducts(document.getElementById('manageProductsSearch').value);
          renderManageVendors(document.getElementById('manageVendorsSearch').value);
          renderManageProjects(document.getElementById('manageProjectsSearch').value);

          resetAddProductForm();
          resetAddVendorForm();
          resetAddProjectForm(); // Call reset to update new project number

        }catch(e){
          showError(`ไม่สามารถดึงข้อมูลจาก READ_API ได้: ${e.message || 'กรุณาตรวจสอบ URL doGet และสิทธิ์การเข้าถึง'}`);
          console.error("Error loading data:", e);
          throw e;
        }
      }

      function fillOptions(selectEl, items, getValue, getLabel){
        if (!selectEl) return; 
        selectEl.innerHTML = '<option value="">— เลือก —</option>';
        items.forEach(it=>{
          const opt = document.createElement('option');
          opt.value = getValue(it);
          opt.textContent = getLabel(it);
          selectEl.appendChild(opt);
        });
      }

      function populateDatalist(datalistId, items, getKey) {
        const datalistEl = document.getElementById(datalistId);
        if (!datalistEl) return; 
        datalistEl.innerHTML = ''; 
        const uniqueItems = new Set();
        items.forEach(item => {
          const value = String(getKey(item) || '').trim();
          if (value && !uniqueItems.has(value)) {
            const option = document.createElement('option');
            option.value = value;
            datalistEl.appendChild(option);
            uniqueItems.add(value);
          }
        });
      }

      // Function to filter product dropdowns based on search query
      function filterProductSelect(selectEl, query){
        if (!selectEl) return; 
        const q = (query||'').toLowerCase().trim();
        selectEl.innerHTML = '<option value="">— เลือก —</option>'; 
        const filtered = cache.products.filter(it => 
            (String(it['รหัสสินค้า'] || '').toLowerCase().includes(q)) || 
            (String(it['ชื่อสินค้า'] || '').toLowerCase().includes(q))
        );
        filtered.forEach(o => {
          const opt = document.createElement('option');
          opt.value = o['รหัสสินค้า'];
          opt.textContent = `${o['รหัสสินค้า']} — ${o['ชื่อสินค้า']}`;
          selectEl.appendChild(opt);
        });
      }

      // Function to filter vendor dropdowns based on search query
      function filterVendorSelect(selectEl, query){
        if (!selectEl) return;
        const q = (query||'').toLowerCase().trim();
        selectEl.innerHTML = '<option value="">— เลือก —</option>';
        const filtered = cache.vendors.filter(it =>
            (String(it['รหัส Vendors'] || '').toLowerCase().includes(q)) ||
            (String(it['Vender'] || '').toLowerCase().includes(q))
        );
        filtered.forEach(o => {
            const opt = document.createElement('option');
            opt.value = o['รหัส Vendors'];
            opt.textContent = `${o['รหัส Vendors']} — ${o['Vender']}`;
            selectEl.appendChild(opt);
        });
      }


      function formatDateToDDMMMYYYY(dateString) {
          if (!dateString) return '';
          const date = new Date(dateString);
          if (isNaN(date)) return ''; 
          const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          const day = String(date.getDate()).padStart(2, '0');
          const month = months[date.getMonth()];
          const year = date.getFullYear();
          return `${day}-${month}-${year}`;
      }

      function renderDropdowns(){
        fillOptions(
          document.getElementById('purchaseVendor'),
          cache.vendors,
          it=>String(it['รหัส Vendors'] || it['รหัสVendors'] || '').trim(),
          it=>`${String(it['รหัส Vendors']||it['รหัสVendors'] || '').trim()} — ${String(it['Vender'] || '').trim()}`
        );
        
        fillOptions(
          document.getElementById('issueProject'),
          cache.projects,
          it=>String(it['กำหนดรหัสจุด'] || '').trim(),
          it=>`${String(it['กำหนดรหัสจุด'] || '').trim()} — ${String(it['โครงการ'] || '').trim()}${it['ชื่อย่อ']?' ('+String(it['ชื่อย่อ'] || '').trim()+')':''}`
        );
        
        fillOptions(
          document.getElementById('dashboardProjectExpenditureSelect'),
          cache.projects,
          it=>String(it['กำหนดรหัสจุด'] || '').trim(),
          it=>`${String(it['กำหนดรหัสจุด'] || '').trim()} — ${String(it['โครงการ'] || '').trim()}${it['ชื่อย่อ']?' ('+String(it['ชื่อย่อ'] || '').trim()+')':''}`
        );

        const purchaseSearchInput = document.getElementById('purchaseSearch');
        const purchaseProductSelect = document.getElementById('purchaseProduct');
        if (purchaseSearchInput && purchaseProductSelect) {
            purchaseSearchInput.addEventListener('input', (e) => filterProductSelect(purchaseProductSelect, e.target.value));
        }
        const issueSearchInput = document.getElementById('issueSearch');
        const issueProductSelect = document.getElementById('issueProduct');
        if (issueSearchInput && issueProductSelect) {
            issueSearchInput.addEventListener('input', (e) => filterProductSelect(issueProductSelect, e.target.value));
        }
      }

    function renderDashboard() {
      // 1. KPI Cards
      const totalQty = cache.stockReport.reduce((s, r) => s + (+r['คงเหลือ'] || 0), 0);
      const totalStockValue = cache.stockReport.reduce((s, r) => s + (+r['ต้นทุนรวมปัจจุบัน'] || 0), 0);
      const productCount = cache.stockReport.length;
      const deadValue = cache.stockReport
        .filter(r => (String(r['ประเภทการเคลื่อนไหวสินค้า'] || '').toLowerCase() === 'deadstock'))
        .reduce((s, r) => s + (+r['ต้นทุนรวมปัจจุบัน'] || 0), 0);
      const deadPercent = totalStockValue > 0 ? (deadValue / totalStockValue) * 100 : 0;
    
      document.getElementById('kpiTotalQty').textContent = totalQty.toLocaleString('th-TH');
      document.getElementById('kpiStockValue').textContent = totalStockValue.toLocaleString('th-TH', { minimumFractionDigits: 2 });
      document.getElementById('kpiProductCount').textContent = productCount.toLocaleString('th-TH');
      document.getElementById('kpiDeadValue').textContent = deadValue.toLocaleString('th-TH', { minimumFractionDigits: 2 });
      document.getElementById('kpiDeadPercent').textContent = `${deadPercent.toFixed(1)}% ของสต็อกทั้งหมด`;
      document.getElementById('kpiUpdatedAt').textContent = `อัปเดตล่าสุด: ${cache.lastUpdated ? formatDateToDDMMMYYYY(cache.lastUpdated.toISOString()) : '-'}`;
          // ...ในฟังก์ชัน renderDashboard()...
    
    // 5. การแจ้งเตือน (Alerts)
    const alerts = [];
    // 1. สินค้าหมดสต็อก
    const outOfStock = cache.stockReport.filter(r => (+r['คงเหลือ']||0) === 0);
    if (outOfStock.length) {
        const moreId = `outOfStockMore-${Date.now()}`;
        alerts.push(`<div class="text-red-400 font-semibold mb-1">❌ สินค้าหมดสต็อก (${outOfStock.length} รายการ)</div>`);
        alerts.push(...outOfStock.slice(0, 5).map(r =>
        `<div class="ml-4 text-sm">• ${r['รหัสสินค้า']} - ${r['ชื่อสินค้า']}</div>`
        ));
        if (outOfStock.length > 5) {
        alerts.push(`
            <a href="#" class="ml-4 text-xs text-blue-400 underline cursor-pointer alert-toggle" data-target="${moreId}">...และอีก ${outOfStock.length-5} รายการ</a>
            <div id="${moreId}" class="ml-4 mt-1 hidden">
            ${outOfStock.slice(5).map(r => `<div class="text-sm">• ${r['รหัสสินค้า']} - ${r['ชื่อสินค้า']}</div>`).join('')}
            <a href="#" class="text-xs text-blue-400 underline cursor-pointer alert-toggle" data-target="${moreId}">ซ่อน</a>
            </div>
        `);
        }
    }
    // 2. สินค้าใกล้ถึงจุดสั่งซื้อขั้นต่ำ (คงเหลือ <= ขั้นต่ำ และ คงเหลือ > 0)
    const lowStock = cache.stockReport.filter(r => {
        const remain = +r['คงเหลือ']||0;
        const min = +r['จำนวนขั้นต่ำ']||0;
        return remain > 0 && remain <= min;
    });
    if (lowStock.length) {
        const moreId = `lowStockMore-${Date.now()}`;
        alerts.push(`<div class="text-yellow-400 font-semibold mt-2 mb-1">⚠️ สินค้าใกล้ถึงจุดสั่งซื้อขั้นต่ำ (${lowStock.length} รายการ)</div>`);
        alerts.push(...lowStock.slice(0, 5).map(r =>
        `<div class="ml-4 text-sm">• ${r['รหัสสินค้า']} - ${r['ชื่อสินค้า']} (คงเหลือ ${Number(r['คงเหลือ']||0).toLocaleString('th-TH')})</div>`
        ));
        if (lowStock.length > 5) {
        alerts.push(`
            <a href="#" class="ml-4 text-xs text-blue-400 underline cursor-pointer alert-toggle" data-target="${moreId}">...และอีก ${lowStock.length-5} รายการ</a>
            <div id="${moreId}" class="ml-4 mt-1 hidden">
            ${lowStock.slice(5).map(r => `<div class="text-sm">• ${r['รหัสสินค้า']} - ${r['ชื่อสินค้า']} (คงเหลือ ${Number(r['คงเหลือ']||0).toLocaleString('th-TH')})</div>`).join('')}
            <a href="#" class="text-xs text-blue-400 underline cursor-pointer alert-toggle" data-target="${moreId}">ซ่อน</a>
            </div>
        `);
        }
    }
        
    // 3. สินค้า Deadstock
    const deadStock = cache.stockReport.filter(r => String(r['ประเภทการเคลื่อนไหวสินค้า']||'').toLowerCase() === 'deadstock');
    if (deadStock.length) {
        const moreId = `deadStockMore-${Date.now()}`;
        alerts.push(`<div class="text-pink-400 font-semibold mt-2 mb-1">🛑 สินค้า Deadstock (${deadStock.length} รายการ)</div>`);
        alerts.push(...deadStock.slice(0, 5).map(r =>
        `<div class="ml-4 text-sm">• ${r['รหัสสินค้า']} - ${r['ชื่อสินค้า']}</div>`
        ));
        if (deadStock.length > 5) {
        alerts.push(`
            <a href="#" class="ml-4 text-xs text-blue-400 underline cursor-pointer alert-toggle" data-target="${moreId}">...และอีก ${deadStock.length-5} รายการ</a>
            <div id="${moreId}" class="ml-4 mt-1 hidden">
            ${deadStock.slice(5).map(r => `<div class="text-sm">• ${r['รหัสสินค้า']} - ${r['ชื่อสินค้า']}</div>`).join('')}
            <a href="#" class="text-xs text-blue-400 underline cursor-pointer alert-toggle" data-target="${moreId}">ซ่อน</a>
            </div>
        `);
        }
    }
    
    // 4. สินค้า Slow Moving
    const slowStock = cache.stockReport.filter(r => String(r['ประเภทการเคลื่อนไหวสินค้า']||'').toLowerCase() === 'slow');
    if (slowStock.length) {
      alerts.push(`<div class="text-yellow-300 font-semibold mt-2 mb-1">🐢 สินค้า Slow Moving (${slowStock.length} รายการ)</div>`);
      alerts.push(...slowStock.slice(0, 5).map(r =>
        `<div class="ml-4 text-sm">• ${r['รหัสสินค้า']} - ${r['ชื่อสินค้า']}</div>`
      ));
      if (slowStock.length > 5) alerts.push(`<div class="ml-4 text-xs text-gray-400">...และอีก ${slowStock.length-5} รายการ</div>`);
    }
    
    // ถ้าไม่มีแจ้งเตือน
    if (!alerts.length) {
      alerts.push('<div class="text-green-400">✅ ไม่มีแจ้งเตือนสำคัญ</div>');
    }
    
    const alertsContainer = document.getElementById('alertsContainer');
    if (alertsContainer) alertsContainer.innerHTML = alerts.join('');
    
    console.log('topIssued', cache.topIssued);
    console.log('topStockValue', cache.topStockValue);
      // 2. Top 5 สินค้าเคลื่อนไหวเร็ว
      const topIssued = (cache.topIssued || []).slice(0, 5);
      document.getElementById('topIssuedList').innerHTML = topIssued.length
        ? topIssued.map((item, i) => `
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center text-sm font-bold">${i + 1}</div>
              <span class="text-sm">${item.productName || '-'}</span>
            </div>
            <span class="text-green-400 font-semibold">${(+item.totalQtyIssued || 0).toLocaleString('th-TH')} หน่วย</span>
            </div>
        `).join('')
        : '<div class="text-gray-400">ไม่มีข้อมูล</div>';
    
      // 3. Top 5 มูลค่าการเบิกสูงสุด
      const topStockValue = (cache.topStockValue || []).slice(0, 5);
      document.getElementById('topStockValueList').innerHTML = topStockValue.length
        ? topStockValue.map((item, i) => `
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-sm font-bold">${i + 1}</div>
              <span class="text-sm">${item.productName || '-'}</span>
            </div>
            <span class="text-blue-400 font-semibold">${(+item.totalStockValue || 0).toLocaleString('th-TH', { minimumFractionDigits: 2 })} บาท</span>
            </div>
        `).join('')
        : '<div class="text-gray-400">ไม่มีข้อมูล</div>';
    
      // 4. Chart.js ตัวอย่าง (มูลค่าการซื้อรายเดือน)
      if (window.purchaseChartInstance) window.purchaseChartInstance.destroy();
      const ctx = document.getElementById('purchaseChart').getContext('2d');
      window.purchaseChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: cache.monthlyActivity.labels || [],
          datasets: [{
            label: 'มูลค่าการซื้อ',
            data: cache.monthlyActivity.purchase || [],
            backgroundColor: '#8b5cf6',
            borderRadius: 8,
            borderSkipped: false,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: '#9ca3af',
                callback: value => value.toLocaleString('th-TH', { minimumFractionDigits: 0 }) + ' บาท'
              },
              grid: { color: '#374151' }
            },
            x: {
              ticks: { color: '#9ca3af' },
              grid: { display: false }
            }
          }
        }
      });
    }
    
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('alert-toggle')) {
        e.preventDefault();
        const targetId = e.target.getAttribute('data-target');
        const el = document.getElementById(targetId);
        if (el) el.classList.toggle('hidden');
      }
    });
    function toggleAlertMore(id) {
        const el = document.getElementById(id);
        if (el) el.classList.toggle('hidden');
        }
            // ...existing code...
      function parseSheetDate(dateStr) {
        // แปลง dd-MMM-yyyy เป็น YYYY-MM-DD
        if (!dateStr) return '';
        const parts = String(dateStr).split('-');
        if (parts.length === 3) {
          const day = parts[0].padStart(2, '0');
          const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
          const month = (monthNames.indexOf(parts[1]) + 1).toString().padStart(2, '0');
          const year = parts[2];
          return `${year}-${month}-${day}`;
        }
        return '';
      }
      
      const today = new Date();
      const todayStr = today.toISOString().slice(0,10); // YYYY-MM-DD
      
      // ยอดซื้อวันนี้
      const purchasesToday = cache.lots.filter(lot => !!lot['วันที่']);
      const issuesToday = (cache.issues || []).filter(issue => !!issue['วันที่'])

      document.addEventListener('click', function(e) {
        if (e.target && e.target.id === 'viewOutOfStockBtn') {
          const modal = document.getElementById('outOfStockModal');
          const list = document.getElementById('outOfStockList');
          if (modal && list) {
            list.innerHTML = cache.stockReport
              .filter(r => (+r['คงเหลือ']||0) === 0)
              .map(item => `<div class="bg-gray-700 border border-gray-600 rounded-md px-3 py-2">${String(item['รหัสสินค้า']||'').trim()} - ${String(item['ชื่อสินค้า']||'').trim()}</div>`)
              .join('');
            modal.classList.remove('hidden');
          }
        }
        if (e.target && e.target.id === 'closeOutOfStockModal') {
          const modal = document.getElementById('outOfStockModal');
          if (modal) modal.classList.add('hidden');
        }
      });
            // เพิ่ม event สำหรับช่องค้นหา
      const stockSearchInput = document.getElementById('reportSearch');
      if (stockSearchInput) {
        stockSearchInput.addEventListener('input', (e) => {
          renderReport(e.target.value);
        });
      }
      
      function renderReport(searchQuery = '') {
        const body = document.getElementById('reportBody');
        if (!body) return; 
        body.innerHTML = '';
        const lowerCaseQuery = (searchQuery || '').toLowerCase().trim();
        const filteredStock = cache.stockReport.filter(item => {
          const sku = (String(item['รหัสสินค้า'] || '')).toLowerCase();
          const name = (String(item['ชื่อสินค้า'] || '')).toLowerCase();
          return sku.includes(lowerCaseQuery) || name.includes(lowerCaseQuery);
        });
        if(filteredStock.length===0){
          body.innerHTML = '<tr><td class="px-4 py-3 text-gray-400" colspan="9">ไม่พบรายการสินค้า</td></tr>';
          return;
        }
        filteredStock.forEach(r=>{
          let badgeClass = 'bg-gray-600/20 text-gray-300';
          let displayText = String(r['ประเภทการเคลื่อนไหวสินค้า']||'').trim();
          const movementTypeLower = displayText.toLowerCase();
          if (movementTypeLower === 'fast') {
            badgeClass = 'bg-emerald-600/20 text-emerald-300';
            displayText = 'Fast';
          } else if (movementTypeLower === 'deadstock') {
            badgeClass = 'bg-red-600/20 text-red-300';
            displayText = 'Deadstock';
          } else if (movementTypeLower === 'slow') {
            badgeClass = 'bg-yellow-600/20 text-yellow-300';
            displayText = 'Slow';
          } else if (displayText === '') {
            displayText = 'ไม่ระบุ';
          } else {
            displayText = displayText.charAt(0).toUpperCase() + displayText.slice(1);
            badgeClass = 'bg-indigo-600/20 text-indigo-300';
          }
      
          const tr = document.createElement('tr');
          tr.className = 'border-t border-gray-700/60';
          tr.innerHTML = `
            <td class="px-4 py-3 text-center">
              <input type="checkbox" class="stock-checkbox" value="${String(r['รหัสสินค้า'] || '').trim()}">
            </td>
            <td class="px-4 py-3">${String(r['รหัสสินค้า']||'').trim()}</td>
            <td class="px-4 py-3">${String(r['ชื่อสินค้า']||'').trim()}</td>
            <td class="px-4 py-3">${Number(r['สินค้าที่ซื้อทั้งหมด'] || 0).toLocaleString('th-TH')}</td>
            <td class="px-4 py-3">${Number(r['เบิกทั้งหมด'] || 0).toLocaleString('th-TH')}</td>
            <td class="px-4 py-3 text-right">${Number(r['คงเหลือ']||0).toLocaleString('th-TH')}</td>
            <td class="px-4 py-3 text-right">${Number(r['จำนวนขั้นต่ำ']||0).toLocaleString('th-TH')}</td>
            <td class="px-4 py-3 text-right">${Number(r['ต้นทุนเฉลี่ยต่อชิ้น']||0).toLocaleString('th-TH',{minimumFractionDigits:2})}</td>
            <td class="px-4 py-3 text-right">${Number(r['ต้นทุนรวมปัจจุบัน']||0).toLocaleString('th-TH',{minimumFractionDigits:2})}</td>
            <td class="px-4 py-3 text-center"><span class="text-xs px-2 py-1 rounded ${badgeClass}">${displayText}</span></td>
            <td class="px-4 py-3 text-center">
              <button class="view-lot-details-btn px-3 py-1 rounded bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium" data-sku="${String(r['รหัสสินค้า'] || '').trim()}" data-product-name="${String(r['ชื่อสินค้า'] || '').trim()}">
                ดูรายละเอียด
              </button>
            </td>
          `;
          body.appendChild(tr);
        });
      
        // Attach event listeners for "ดูรายละเอียด Lot"
        body.querySelectorAll('.view-lot-details-btn').forEach(button => {
          button.addEventListener('click', (e) => {
            const productSku = e.target.dataset.sku;
            const productName = e.target.dataset.productName;
            showLotDetails(productSku, productName);
          });
        });
        updateExportStockButtonVisibility();
      }

      // New function to show lot details in a modal
      function showLotDetails(productSku, productName) {
        const lotDetailModal = document.getElementById('lotDetailModal');
        const lotDetailModalTitle = document.getElementById('lotDetailModalTitle');
        const lotDetailContent = document.getElementById('lotDetailContent');
        const closeLotDetailModalBtn = document.getElementById('closeLotDetailModal');

        if (!lotDetailModal || !lotDetailModalTitle || !lotDetailContent || !closeLotDetailModalBtn) return;

        const stockRow = cache.stockReport.find(r => String(r['รหัสสินค้า']||'').trim() === productSku);
        
        lotDetailModalTitle.textContent = `รายละเอียด Lot ของ: ${productName} (${productSku})`;
        lotDetailContent.innerHTML = ''; // Clear previous content

        if (stockRow) {
          lotDetailContent.innerHTML += `
            <div class="mb-2 flex gap-4">
              <div class="text-sm text-blue-300">สินค้าที่ซื้อทั้งหมด: <span class="font-bold text-white">${Number(stockRow['สินค้าที่ซื้อทั้งหมด']||0).toLocaleString('th-TH')}</span></div>
              <div class="text-sm text-pink-300">เบิกทั้งหมด: <span class="font-bold text-white">${Number(stockRow['เบิกทั้งหมด']||0).toLocaleString('th-TH')}</span></div>
            </div>
          `;
        }
        const productLots = cache.lots
            .filter(l => String(l['รหัสสินค้า']||'').trim() === productSku && (+l['จำนวนคงเหลือ']||0) > 0)
            .sort((a, b) => new Date(a['วันที่']) - new Date(b['วันที่'])); // Sort by date for FIFO order

        if (productLots.length === 0) {
            lotDetailContent.innerHTML = '<p class="text-gray-400">ไม่พบ Lot ที่มีสต็อกคงเหลือสำหรับสินค้านี้</p>';
        } else {
            let totalRemainingQty = 0;
            productLots.forEach(lot => {
                totalRemainingQty += (+lot['จำนวนคงเหลือ']||0);
                const lotItem = document.createElement('div');
                lotItem.className = 'bg-gray-700 border border-gray-600 rounded-md p-3';
                lotItem.innerHTML = `
                    <div class="font-medium text-blue-300">Lot ID: ${String(lot.lotId || lot['Lotstoct'] || 'N/A').trim()}</div>
                    <div class="text-sm mt-1">วันที่รับเข้า: <span class="text-cyan-300">${formatDateToDDMMMYYYY(lot['วันที่'])}</span></div>
                    <div class="text-sm">คงเหลือ: <span class="font-bold text-white">${Number(lot['จำนวนคงเหลือ']||0).toLocaleString('th-TH')}</span> ชิ้น</div>
                    <div class="text-sm">ราคาต่อหน่วย: <span class="font-bold text-white">${Number(lot['ราคา']||0).toLocaleString('th-TH', {minimumFractionDigits: 2})}</span> บาท</div>
                    <div class="text-sm">มูลค่า Lot: <span class="font-bold text-white">${Number((+lot['จำนวนคงเหลือ']||0) * (+lot['ราคา']||0)).toLocaleString('th-TH', {minimumFractionDigits: 2})}</span> บาท</div>
                `;
                lotDetailContent.appendChild(lotItem);
            });
            // Add total remaining quantity at the end
            const totalQtyDiv = document.createElement('div');
            totalQtyDiv.className = 'mt-4 text-lg font-bold text-white';
            totalQtyDiv.innerHTML = `รวมคงเหลือทั้งหมด: <span class="text-green-400">${Number(totalRemainingQty).toLocaleString('th-TH')}</span> ชิ้น`;
            lotDetailContent.appendChild(totalQtyDiv);
        }

        lotDetailModal.classList.remove('hidden');

        const closeHandler = () => {
            lotDetailModal.classList.add('hidden');
            closeLotDetailModalBtn.removeEventListener('click', closeHandler);
        };
        closeLotDetailModalBtn.addEventListener('click', closeHandler);

        lotDetailModal.addEventListener('click', (e) => {
            if (e.target === lotDetailModal) {
                closeHandler();
            }
        });
      }


      function renderVendors() {
          const body = document.getElementById('vendorBody');
          if (!body) return; 
          body.innerHTML = '';
          if (cache.vendors.length === 0) {
              body.innerHTML = '<tr><td class="px-4 py-3 text-gray-400" colspan="5">ไม่มีข้อมูลผู้ขาย</td></tr>';
              return;
          }
          cache.vendors.forEach(v => {
              const tr = document.createElement('tr');
              tr.className = 'border-t border-gray-700/60';
              tr.innerHTML = `
                <td class="px-4 py-3 text-center">
                    <input type="checkbox" class="vendor-checkbox" value="${String(v['รหัส Vendors'] || '').trim()}">
                </td>
                  <td class="px-4 py-3">${String(v['รหัส Vendors'] || '').trim()}</td>
                  <td class="px-4 py-3">${String(v['Vender'] || '').trim()}</td>
                  <td class="px-4 py-3">${String(v['ที่อยู่'] || '').trim()}</td>
                  <td class="px-4 py-3">${String(v['เบอร์โทร'] || '').trim()}</td>
                  <td class="px-4 py-3">${String(v['ประเภทจดทบ.'] || '').trim()}</td>
                    <td class="px-4 py-3 text-center">
                        <button class="view-vendor-history-btn px-3 py-1 mr-2 rounded bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium" data-vendor-code="${String(v['รหัส Vendors'] || '').trim()}">ดูประวัติ</button>
                        <button class="export-vendor-excel-btn px-3 py-1 rounded bg-green-600 hover:bg-green-700 text-white text-xs font-medium" data-vendor-code="${String(v['รหัส Vendors'] || '').trim()}">ส่งออก Excel</button>
                    </td>
            `;
              body.appendChild(tr);
          });
      
      document.querySelectorAll('.view-vendor-history-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const vendorCode = btn.dataset.vendorCode;
            const vendor = cache.vendors.find(v => String(v['รหัส Vendors']||'').trim() === vendorCode);
            if (vendor) showVendorPurchaseModal(vendor);
        });
    });
    document.querySelectorAll('.export-vendor-excel-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const vendorCode = btn.dataset.vendorCode;
            const vendor = cache.vendors.find(v => String(v['รหัส Vendors']||'').trim() === vendorCode);
            if (vendor) exportVendorHistoryToExcel(vendor);
        });
    });
}
// ...ใน <scri> หลังฟังก์ชัน renderVendors()...

// 2. เพิ่ม event สำหรับช่องค้นหา
const vendorSearch = document.getElementById('vendorSearch');
if (vendorSearch) {
  vendorSearch.addEventListener('input', (e) => {
    renderVendors(e.target.value);
  });
}

// 3. ปรับ renderVendors ให้รับ searchQuery
function renderVendors(searchQuery = '') {
  const body = document.getElementById('vendorBody');
  if (!body) return; 
  body.innerHTML = '';
  const lowerCaseQuery = (searchQuery || '').toLowerCase().trim();
  const filteredVendors = cache.vendors.filter(vendor => {
    const code = (String(vendor['รหัส Vendors'] || '')).toLowerCase();
    const name = (String(vendor['Vender'] || '')).toLowerCase();
    return code.includes(lowerCaseQuery) || name.includes(lowerCaseQuery);
  });
  if (filteredVendors.length === 0) {
    body.innerHTML = '<tr><td class="px-4 py-3 text-gray-400" colspan="7">ไม่พบรายการผู้ขาย</td></tr>';
    return;
  }
  filteredVendors.forEach(v => {
    const tr = document.createElement('tr');
    tr.className = 'border-t border-gray-700/60';
    tr.innerHTML = `
      <td class="px-4 py-3 text-center">
        <input type="checkbox" class="vendor-checkbox" value="${String(v['รหัส Vendors'] || '').trim()}">
      </td>
      <td class="px-4 py-3">${String(v['รหัส Vendors'] || '').trim()}</td>
      <td class="px-4 py-3">${String(v['Vender'] || '').trim()}</td>
      <td class="px-4 py-3">${String(v['ที่อยู่'] || '').trim()}</td>
      <td class="px-4 py-3">${String(v['เบอร์โทร'] || '').trim()}</td>
      <td class="px-4 py-3">${String(v['ประเภทจดทบ.'] || '').trim()}</td>
      <td class="px-4 py-3 text-center">
        <button class="view-vendor-history-btn px-3 py-1 mr-2 rounded bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium" data-vendor-code="${String(v['รหัส Vendors'] || '').trim()}">ดูประวัติ</button>
        <button class="export-vendor-excel-btn px-3 py-1 rounded bg-green-600 hover:bg-green-700 text-white text-xs font-medium" data-vendor-code="${String(v['รหัส Vendors'] || '').trim()}">ส่งออก Excel</button>
      </td>
    `;
    body.appendChild(tr);
  });

  // Attach event listeners (เหมือนเดิม)
  body.querySelectorAll('.view-vendor-history-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const vendorCode = btn.dataset.vendorCode;
      const vendor = cache.vendors.find(v => String(v['รหัส Vendors']||'').trim() === vendorCode);
      if (vendor) showVendorPurchaseModal(vendor);
    });
  });
  body.querySelectorAll('.export-vendor-excel-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const vendorCode = btn.dataset.vendorCode;
      const vendor = cache.vendors.find(v => String(v['รหัส Vendors']||'').trim() === vendorCode);
      if (vendor) exportVendorHistoryToExcel(vendor);
    });
  });
updateExportVendorsButtonVisibility();}

// 4. เรียก renderVendors() ครั้งแรกแบบไม่มี searchQuery
renderVendors();
// แสดง/ซ่อนปุ่มส่งออก
    function updateExportVendorsButtonVisibility() {
      const btn = document.getElementById('exportSelectedVendorsBtn');
      const checked = document.querySelectorAll('.vendor-checkbox:checked');
      if (btn) btn.classList.toggle('hidden', checked.length === 0);
    }
    document.addEventListener('change', function(e) {
      if (e.target.classList.contains('vendor-checkbox') || e.target.id === 'selectAllVendors') {
        // ถ้า selectAll ถูกคลิก
        if (e.target.id === 'selectAllVendors') {
          const checked = e.target.checked;
          document.querySelectorAll('.vendor-checkbox').forEach(cb => cb.checked = checked);
        }
        updateExportVendorsButtonVisibility();
      }
    });

// Event: เมื่อกดปุ่มส่งออก
document.getElementById('exportSelectedVendorsBtn')?.addEventListener('click', function() {
  const checked = Array.from(document.querySelectorAll('.vendor-checkbox:checked')).map(cb => cb.value);
  if (checked.length === 0) return;
  exportMultiVendorsToExcel(checked);
});

// ฟังก์ชันส่งออก Excel หลายผู้ขาย
    function exportMultiVendorsToExcel(vendorCodes) {
      const selectedLots = (cache.lots || []).filter(lot =>
        vendorCodes.includes(String(lot['รหัส Vender'] || '').trim())
      );
      if (selectedLots.length === 0) {
        alert('ไม่พบประวัติการซื้อของผู้ขายที่เลือก');
        return;
      }
    function formatDateOnly(dateStr) {
      if (!dateStr) return '';
      if (dateStr.includes('T')) return dateStr.split('T')[0];
      return dateStr;
    }
      // 2. สร้าง header และ rows (เพิ่ม "ผู้ขาย" เป็นคอลัมน์แรก)
      const header = ['ผู้ขาย', 'รหัสสินค้า', 'ชื่อสินค้า', 'จำนวน', 'มูลค่า (บาท)', 'วันที่ซื้อ'];
      const rows = selectedLots.map(lot => {
        const vendor = cache.vendors.find(v => String(v['รหัส Vendors']||'').trim() === String(lot['รหัส Vender']||'').trim());
        const vendorName = vendor ? String(vendor['Vender']||'') : String(lot['รหัส Vender']||'');
        return [
          vendorName,
          String(lot['รหัสสินค้า'] || ''),
          String(lot['ชื่อสินค้า'] || ''),
          Number(lot['จำนวนที่ซื้อ'] || 0),
          Number(lot['มูลค่ารวม'] || 0).toFixed(2),
          formatDateOnly(lot['วันที่'] || '')
        ];
      });
      // 3. สร้าง CSV
      const csvContent = '\uFEFF' + [header, ...rows].map(r => r.join(',')).join('\r\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ประวัติการซื้อ_หลายผู้ขาย.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
      function showVendorPurchaseModal(vendor) {
        const modal = document.getElementById('vendorPurchaseModal');
        const title = document.getElementById('vendorPurchaseModalTitle');
        const list = document.getElementById('vendorPurchaseList');
        if (!modal || !title || !list) return;

        title.textContent = `ประวัติการซื้อกับ "${vendor['Vender']}" (${vendor['รหัส Vendors']})`;

        const purchases = (cache.lots || []).filter(lot => 
            String(lot['รหัส Vender'] || '').trim() === String(vendor['รหัส Vendors'] || '').trim()
        );

        if (purchases.length === 0) {
            list.innerHTML = `<div class="text-gray-400">ไม่พบประวัติการซื้อกับร้านนี้</div>`;
        } else {
            list.innerHTML = purchases.map(lot => `
                <div class="bg-gray-700 border border-gray-600 rounded-md p-3">
                    <div><span class="font-bold text-white">${lot['ชื่อสินค้า']}</span></div>
                    <div class="text-sm">จำนวน: <span class="text-blue-300">${Number(lot['จำนวนที่ซื้อ']||0).toLocaleString('th-TH')}</span> | 
                        มูลค่า: <span class="text-green-300">${Number(lot['มูลค่ารวม']||0).toLocaleString('th-TH', {minimumFractionDigits:2})} บาท</span>
                </div>
                <div class="text-xs text-gray-400">วันที่ซื้อ: ${lot['วันที่'] || '-'}</div>
            </div>
            `).join('');
        }
        modal.classList.remove('hidden');
    }
        // ...existing code...
    
    // ปิด modal ประวัติการซื้อผู้ขาย (ทั้งปุ่ม "ปิด" และ "กากบาท")
    document.addEventListener('click', function(e) {
      if (
        e.target.id === 'closeVendorPurchaseModal' ||
        e.target.id === 'closeVendorPurchaseModal2' ||
        (e.target.id === 'vendorPurchaseModal' && e.target.classList.contains('modal-overlay'))
      ) {
        const modal = document.getElementById('vendorPurchaseModal');
        if (modal) modal.classList.add('hidden');
      }
    });
        // แสดง/ซ่อนปุ่มส่งออก
    function updateExportStockButtonVisibility() {
      const btn = document.getElementById('exportSelectedStockBtn');
      const checked = document.querySelectorAll('.stock-checkbox:checked');
      if (btn) btn.classList.toggle('hidden', checked.length === 0);
    }
    
    // Event: เมื่อเลือก checkbox
    document.addEventListener('change', function(e) {
      if (e.target.classList.contains('stock-checkbox') || e.target.id === 'selectAllStock') {
        // ถ้า selectAll ถูกคลิก
        if (e.target.id === 'selectAllStock') {
          const checked = e.target.checked;
          document.querySelectorAll('.stock-checkbox').forEach(cb => cb.checked = checked);
        }
        updateExportStockButtonVisibility();
      }
    });
    
    // Event: เมื่อกดปุ่มส่งออก
    document.getElementById('exportSelectedStockBtn').addEventListener('click', function() {
      const checked = Array.from(document.querySelectorAll('.stock-checkbox:checked')).map(cb => cb.value);
      if (checked.length === 0) return;
      exportMultiStockToExcel(checked);
    });
    
    // ฟังก์ชันส่งออก Excel หลายสินค้า
    function exportMultiStockToExcel(skuList) {
      const selected = cache.stockReport.filter(r => skuList.includes(String(r['รหัสสินค้า']||'').trim()));
      if (selected.length === 0) {
        alert('ไม่พบข้อมูลสต็อกที่เลือก');
        return;
      }
      const header = ['รหัสสินค้า', 'ชื่อสินค้า', 'สินค้าที่ซื้อทั้งหมด', 'เบิกทั้งหมด', 'คงเหลือ', 'ขั้นต่ำ', 'ต้นทุนเฉลี่ย/ชิ้น', 'ต้นทุนรวม', 'ประเภทการเคลื่อนไหว'];
      const rows = selected.map(r => [
        String(r['รหัสสินค้า']||''),
        String(r['ชื่อสินค้า']||'').replace(/"/g, '""'),
        Number(r['สินค้าที่ซื้อทั้งหมด']||0).toLocaleString('en-US'),
        Number(r['เบิกทั้งหมด']||0).toLocaleString('en-US'),
        Number(r['คงเหลือ']||0).toLocaleString('en-US'),
        Number(r['จำนวนขั้นต่ำ']||0).toLocaleString('en-US'),
        Number(r['ต้นทุนเฉลี่ยต่อชิ้น']||0).toLocaleString('en-US', {minimumFractionDigits:2}),
        Number(r['ต้นทุนรวมปัจจุบัน']||0).toLocaleString('en-US', {minimumFractionDigits:2}),
        String(r['ประเภทการเคลื่อนไหวสินค้า']||'')
      ]);
      const csvContent = '\uFEFF' + [header, ...rows].map(r => r.map(cell => {
    // ถ้ามี comma หรือช่องว่าง ให้ใส่ ""
        return /[",\s]/.test(cell) ? `"${cell}"` : cell;
      }).join(',')).join('\r\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `รายงานสต็อกที่เลือก.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

      function renderProjects() {
          const body = document.getElementById('projectBody');
          if (!body) return; 
          body.innerHTML = '';
          if (cache.projects.length === 0) {
              body.innerHTML = '<tr><td class="px-4 py-3 text-gray-400" colspan="4">ไม่มีข้อมูลโครงการ</td></tr>'; 
              return;
          }
          cache.projects.forEach(p => {
              const tr = document.createElement('tr');
              tr.className = 'border-t border-gray-700/60';
              tr.innerHTML = `
                  <td class="px-4 py-3">${String(p['กำหนดรหัสจุด'] || '').trim()}</td>
                  <td class="px-4 py-3">${String(p['โครงการ'] || '').trim()}</td>
                  <td class="px-4 py-3">${String(p['Customer'] || '').trim()}</td>
                  <td class="px-4 py-3">${String(p['ชื่อย่อ'] || '').trim()}</td>
                  <td class="px-4 py-3">${String(p['รหัส']||'').trim()}</td>
                  <td class="px-4 py-3">${String(p['ประเภท']||'').trim()}</td>
                  <td class="px-4 py-3">${String(p['CODE']||'').trim()}</td>
                  <td class="px-4 py-3">${String(p['เฟส']||'').trim()}</td>
                  <td class="px-4 py-3">${String(p['ซอย']||'').trim()}</td>
                  <td class="px-4 py-3">${String(p['บ้านเลขที่'] || '').trim()}</td>
                  <td class="px-4 py-3">${String(p['รายละเอียด'] || '').trim()}</td>
                  <td class="px-4 py-3 text-center">
                    <button class="edit-project-btn px-3 py-1 rounded bg-purple-600 hover:bg-purple-700 text-white text-xs font-medium" data-code="${String(p['กำหนดรหัสจุด']||'')}">แก้ไข</button>
                    <button class="delete-project-btn px-3 py-1 rounded bg-red-600 hover:bg-red-700 text-white text-xs font-medium" data-code="${String(p['กำหนดรหัสจุด']||'')}">ลบ</button>
                  </td>
              `;
              body.appendChild(tr);
          });

          // Re-attach event listeners for edit/delete buttons after rendering
          document.querySelectorAll('.edit-project-btn').forEach(button => {
              button.addEventListener('click', (e) => {
                  const projectCode = e.target.dataset.projectCode;
                  const projectToEdit = cache.projects.find(p => String(p['กำหนดรหัสจุด'] || '').trim() === projectCode);
                  if (projectToEdit) {
                      populateProjectFormForEdit(projectToEdit);
                      setActiveTab('add-project');
                  }
              });
          });

          document.querySelectorAll('.delete-project-btn').forEach(button => {
              button.addEventListener('click', async (e) => {
                  const projectCode = e.target.dataset.projectCode;
                  const projectName = cache.projects.find(p => String(p['กำหนดรหัสจุด'] || '').trim() === projectCode)?.['โครงการ'] || projectCode;
                  const confirmed = await showCustomConfirm(`คุณต้องการลบโครงการ "${String(projectName||'').trim()}" นี้หรือไม่?`);
                  if (confirmed) {
                      const payload = {
                          actionType: 'deleteProject',
                          data: { 'กำหนดรหัสจุด': projectCode }
                      };
                      try {
                          const result = await sendToAppsScript(payload, addProjectStatus);
                          loadAll();
                      } catch (error) {
                          console.error('Error deleting project:', error);
                      }
                  }
              });
          });
      }


      // =========================
      // UI (Canva): "บันทึกซื้อสินค้า" Form
      // =========================
      const purchaseForm = document.getElementById('purchaseForm');
      const purchaseStatus = document.getElementById('purchaseStatus');
      const purchasePreview = document.getElementById('purchasePreview');
      const purchaseDateEl = document.getElementById('purchaseDate'); 
      const purchaseSearchInput = document.getElementById('purchaseSearch');
      const purchaseProductSelect = document.getElementById('purchaseProduct');

      if (purchaseDateEl) purchaseDateEl.valueAsDate = new Date();
          // เพิ่มฟังก์ชันนี้ใน <script> ของคุณ
    function generateLotId(productCode, dateStr, lotIndex = 1) {
      let ymd = '';
      if (dateStr) {
        let d = new Date(dateStr);
        if (!isNaN(d)) {
          ymd = d.getFullYear().toString() +
            String(d.getMonth() + 1).padStart(2, '0') +
            String(d.getDate()).padStart(2, '0');
        }
      }
      return `${productCode}-${ymd}-${String(lotIndex).padStart(2, '0')}`;
    }

      function getPurchasePayload(withAction=true){
        const selectedDate = purchaseDateEl ? purchaseDateEl.value : ''; 
        const pid = (String(document.getElementById('purchaseProduct')?.value||'')).trim();
        const ven = (String(document.getElementById('purchaseVendor')?.value||'')).trim();
        const qty = parseFloat(document.getElementById('purchaseQty')?.value||'0');
        const price = parseFloat(document.getElementById('purchasePrice')?.value||'0');
        const otherCost = parseFloat(document.getElementById('purchaseOtherCost')?.value||'0');
        const discount = parseFloat(document.getElementById('purchaseDiscount')?.value||'0');
        const note = (String(document.getElementById('purchaseNote')?.value||'')).trim();
        let total = qty * price + otherCost - discount;
        if (total < 0) total = 0;
        const lotId = generateLotId(pid, selectedDate, 1); // ถ้า 1 lot ต่อวัน/สินค้า
        const payload = {
          actionType: withAction ? 'purchase' : undefined,
          sheet: 'PurchaseTransactions',
          data: {
            'วันที่': selectedDate, 
            'รหัส Vender': ven,
            'รหัสสินค้า': pid,
            'จำนวนที่ซื้อ': qty,
            'ราคา': price,
            'ต้นทุนอื่นๆ': otherCost,
            'ส่วนลด': discount,
            'มูลค่ารวม': total,
            'หมายเหตุ': note,
            'Lotstoct': lotId
          }
        };
        if(!withAction) delete payload.actionType;
        return payload;
      }

      if (purchaseForm) { 
        purchaseForm.addEventListener('input', ()=>{
          if (purchasePreview) purchasePreview.textContent = JSON.stringify(getPurchasePayload(false), null, 2);
        });

        purchaseForm.addEventListener('submit', async (e)=>{
          e.preventDefault();
          if (purchaseStatus) purchaseStatus.textContent = '';
          const selectedDate = purchaseDateEl ? purchaseDateEl.value : ''; 
          const pid = (String(document.getElementById('purchaseProduct')?.value||'')).trim();
          const ven = (String(document.getElementById('purchaseVendor')?.value||'')).trim();
          const qty = parseFloat(document.getElementById('purchaseQty')?.value||'0');
          const price = parseFloat(document.getElementById('purchasePrice')?.value||'0');
          const otherCost = parseFloat(document.getElementById('purchaseOtherCost')?.value||'0');
          const total = qty*price + otherCost;
          const totalEl = document.getElementById('purchaseTotalPreview');
          if (totalEl) totalEl.textContent = `ยอดรวม: ${total.toLocaleString('th-TH', {minimumFractionDigits:2})} บาท`;
          if(!selectedDate || !pid){
            if (purchaseStatus) purchaseStatus.textContent = 'กรุณากรอกข้อมูลให้ครบถ้วน (ต้องมีวันที่และสินค้า)';
            return;
        }
// qty, price, etc. สามารถเป็น 0 ได้ (ของแถม)

          const payload = getPurchasePayload(true);
          if (purchasePreview) purchasePreview.textContent = JSON.stringify(payload, null, 2);

          try{
            await sendToAppsScript(payload, purchaseStatus);
            loadAll(); 
            purchaseForm.reset();
            if (purchaseDateEl) purchaseDateEl.valueAsDate = new Date(); 
          }catch(err){
          }
        });
      }

      // =========================
      // UI (Canva): "เบิกสินค้า (FIFO)" Form
      // =========================
      const issueForm = document.getElementById('issueForm');
      const issueStatus = document.getElementById('issueStatus');
      const issuePreview = document.getElementById('issuePreview');
      const fifoResult = document.getElementById('fifoResult');
      const issueSearchInput = document.getElementById('issueSearch');
      const issueProductSelect = document.getElementById('issueProduct');
      const issueDateEl = document.getElementById('issueDate');
      if (issueDateEl) issueDateEl.valueAsDate = new Date();

      function getIssuePayload(withAction=true, picks=[]){
        const pid = (String(document.getElementById('issueProduct')?.value||'')).trim();
        const proj = (String(document.getElementById('issueProject')?.value||'')).trim();
        const qty = parseFloat(document.getElementById('issueQty')?.value||'0');
        const remark = (String(document.getElementById('issueRemark')?.value||'')).trim(); // เพิ่มบรรทัดนี้
        const issueDate = issueDateEl ? issueDateEl.value : '';
        const payload = {
          actionType: withAction ? 'issue' : undefined,
          sheet: 'IssueTransactions',
          data: {
            'วันที่': issueDate,
            'รหัสสินค้า': pid,
            'จำนวนที่เบิก': qty,
            'รหัสจุดเบิก': proj,
            'หมายเหตุ': remark,
            'lotDraft': picks
          }
        };
        if(!withAction) delete payload.actionType;
        return payload;
      }

      const simulateFIFOBtn = document.getElementById('simulateFIFO');
      if (simulateFIFOBtn) { 
        simulateFIFOBtn.addEventListener('click', ()=>{
          const pid = (String(document.getElementById('issueProduct')?.value||'')).trim();
          const qtyReq = parseFloat(document.getElementById('issueQty')?.value||'0');
          if(!pid || qtyReq<=0){
            if (fifoResult) fifoResult.textContent = 'กรุณาเลือกสินค้าและใส่จำนวนให้ถูกต้อง';
            if (issuePreview) issuePreview.textContent = JSON.stringify(getIssuePayload(false, []), null, 2);
            return;
          }
          const lots = cache.lots
            .filter(l => String(l['รหัสสินค้า']||'').trim()===pid && (+l['จำนวนคงเหลือ']||0) > 0)
            .sort((a,b)=> new Date(a['วันที่']) - new Date(b['วันที่'])); 

          let remain = qtyReq;
          const picks = []; // Stores the lots that will be picked
          for(const lot of lots){
            if(remain<=0) break;
            const take = Math.min(remain, +lot['จำนวนคงเหลือ']||0);
            if(take>0){
              picks.push({ lotId: lot.lotId, qty: take, price: +lot['ราคา']||0, date: lot['วันที่'] });
              remain -= take;
            }
          }

          const stockBefore = lots.reduce((s,l)=> s + (+l['จำนวนคงเหลือ']||0), 0);
          const stockAfter = stockBefore - qtyReq;

          if(remain>0){
            if (fifoResult) fifoResult.innerHTML = `<span class="text-red-400">สต็อกไม่พอ ต้องการเพิ่มอีก ${remain}</span><div class="mt-2 text-sm">คงเหลือรวมปัจจุบัน: <b>${stockBefore}</b></div>`;
          }else{
            const lotLines = picks.map(p=>`• Lot ${String(p.lotId||'').trim()} วันที่ ${formatDateToDDMMMYYYY(p.date)} — ตัด ${p.qty} หน่วย (ราคา ${p.price})`).join('<br>');
            if (fifoResult) fifoResult.innerHTML = `${lotLines}<br><div class="mt-2 text-blue-400">คงเหลือหลังตัด: <b>${stockAfter}</b></div>`;
          }
          if (issuePreview) issuePreview.textContent = JSON.stringify(getIssuePayload(false, picks), null, 2); // Pass picks here
        });
      }

      if (issueForm) { 
        issueForm.addEventListener('input', ()=>{
          e.preventDefault();
          if (issueStatus) issueStatus.textContent = '';
          const pid = (String(document.getElementById('issueProduct')?.value||'')).trim();
          const proj = (String(document.getElementById('issueProject')?.value||'')).trim();
          const qty = parseFloat(document.getElementById('issueQty')?.value||'0');
          const lots = cache.lots
            .filter(l => String(l['รหัสสินค้า']||'').trim()===pid && (+l['จำนวนคงเหลือ']||0) > 0)
            .sort((a,b)=> new Date(a['วันที่']) - new Date(b['วันที่']));
          const stockBefore = lots.reduce((s,l)=> s + (+l['จำนวนคงเหลือ']||0), 0);
          const stockAfter = isNaN(qty) ? stockBefore : (stockBefore - qty);
          if(pid && qty>0){
            if (fifoResult) fifoResult.innerHTML = `<div class="text-xs text-gray-300">คงเหลือปัจจุบัน: <b>${stockBefore}</b> • หลังตัด: <b class="text-blue-400">${Math.max(stockAfter,0)}</b></div>`;
          }
          if (issuePreview) issuePreview.textContent = JSON.stringify(getIssuePayload(false, []), null, 2);
        });

        issueForm.addEventListener('submit', async (e)=>{
          e.preventDefault();
          if (issueStatus) issueStatus.textContent = '';
          const pid = (String(document.getElementById('issueProduct')?.value||'')).trim();
          const proj = (String(document.getElementById('issueProject')?.value||'')).trim();
          const qty = parseFloat(document.getElementById('issueQty')?.value||'0');

          if(!pid || !proj || qty<=0){
            if (issueStatus) issueStatus.textContent = 'กรุณากรอกข้อมูลให้ครบถ้วน';
            return;
          }
          const payload = getIssuePayload(true, []); // picks are handled server-side now
          if (issuePreview) issuePreview.textContent = JSON.stringify(payload, null, 2);

          try{
            await sendToAppsScript(payload, issueStatus);
            loadAll();
            issueForm.reset();
            if (fifoResult) fifoResult.textContent = '— กด “จำลองเลือก Lot แบบ FIFO” —';
          }catch(err){
          }
        });
      }
      
      // =========================
      // Google Apps Script: Send Data
      // =========================
      async function sendToAppsScript(payload, statusEl){
        if (statusEl) { 
          statusEl.innerHTML = '<span class="inline-flex items-center gap-2 text-gray-200"><span class="w-4 h-4 border-2 border-white/60 border-t-transparent rounded-full spin"></span> กำลังส่งข้อมูล...</span>';
        }
        console.log("Sending payload to Apps Script:", payload);

        try{
          const r1 = await fetch(WRITE_API, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const t = await r1.text(); 
          let result;
          try { result = JSON.parse(t); } catch { result = { ok: r1.ok, message: t || (r1.ok?'OK':'Error') }; }
          console.log("Apps Script response (JSON try):", result);

          if(!r1.ok || result.ok===false){
            // Custom error message for deletion failure
            if ((payload.actionType === 'deleteVendor' || payload.actionType === 'deleteProduct' || payload.actionType === 'deleteProject') && String(result.message || '').includes('ไม่พบ')) {
                // If the item was not found for deletion, treat as a "soft" success for the frontend
                if (statusEl) {
                    statusEl.innerHTML = `<span class="text-yellow-400">แจ้งเตือน:</span> ${result.message || 'รายการอาจถูกลบไปแล้วจาก Google Sheet'}`;
                }
                return { ok: true, message: result.message || 'รายการอาจถูกลบไปแล้ว', itemNotFound: true };
            }
            throw new Error(result.message || 'บันทึกไม่สำเร็จ');
          }
          if (statusEl) { 
            statusEl.innerHTML = `<span class="text-blue-400">สำเร็จ:</span> ${result.message || 'บันทึกเรียบร้อย'}`;
          }
          return result; 
        }catch(errJSON){
          console.error("Error with JSON payload, attempting form-urlencoded:", errJSON);
          try{
            const r2 = await fetch(WRITE_API, {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
              body: 'payload=' + encodeURIComponent(JSON.stringify(payload))
            });
            const t2 = await r2.text();
            let result2;
            try { result2 = JSON.parse(t2); } catch { result2 = { ok: r2.ok, message: t2 || (r2.ok?'OK':'Error') }; }
            console.log("Apps Script response (Form-urlencoded try):", result2);

            if(!r2.ok || result2.ok===false){
              // Custom error message for deletion failure
              if ((payload.actionType === 'deleteVendor' || payload.actionType === 'deleteProduct' || payload.actionType === 'deleteProject') && String(result2.message || '').includes('ไม่พบ')) {
                  if (statusEl) {
                      statusEl.innerHTML = `<span class="text-yellow-400">แจ้งเตือน:</span> ${result2.message || 'รายการอาจถูกลบไปแล้วจาก Google Sheet'}`;
                  }
                  return { ok: true, message: result2.message || 'รายการอาจถูกลบไปแล้ว', itemNotFound: true };
              }
              throw new Error(result2.message || 'บันทึกไม่สำเร็จ');
            }
            if (statusEl) { 
              statusEl.innerHTML = `<span class="text-blue-400">สำเร็จ:</span> ${result2.message || 'บันทึกเรียบร้อย'}`;
            }
            return result2; 
          }catch(errForm){
            console.error("Error with form-urlencoded payload:", errForm);
            if (statusEl) { 
              statusEl.innerHTML = `<span class="text-red-400">ไม่สามารถส่งข้อมูลได้:</span> ${errForm.message || 'ตรวจสอบ WRITE_API / doPost'}`;
            }
            throw errForm;
          }
        }
      }

      // =========================
      // Add/Edit/Delete Product Code
      // =========================
      const addProductForm = document.getElementById('addProductForm');
      const addProductStatus = document.getElementById('addProductStatus');
      const addProductTitle = document.getElementById('addProductTitle');
      const submitProductBtn = document.getElementById('submitProductBtn');
      const cancelEditProductBtn = document.getElementById('cancelEditProductBtn');
      const editingProductIdField = document.getElementById('editingProductId');

      const addAbbrevEl = document.getElementById('addAbbrev');
      const addCodeEl = document.getElementById('addCode');
      const addSpecsEl = document.getElementById('addSpecs');
      const addSkuEl = document.getElementById('addSku');
      const addProductNameEl = document.getElementById('addProductName');
      const addUnitEl = document.getElementById('addUnit');
      const addMinQtyEl = document.getElementById('addMinQty');
      const manageProductsTableBody = document.getElementById('manageProductsTableBody');
      const manageProductsSearch = document.getElementById('manageProductsSearch');
      // const generateProductNameBtn = document.getElementById('generateProductNameBtn'); // Removed
      const aiProductNameStatus = document.getElementById('aiProductNameStatus');

      let currentEditingProductSku = null;

      function updateAddSku() {
        const abbrev = (String(addAbbrevEl ? addAbbrevEl.value : '')).trim();
        const code = (String(addCodeEl ? addCodeEl.value : '')).trim();
        const specs = (String(addSpecsEl ? addSpecsEl.value : '')).trim();
        let sku = '';

        if (abbrev || code || specs) {
          sku = [abbrev, code, specs].filter(s => s).join(''); 
        }
        if (addSkuEl) addSkuEl.value = sku;
      }

      if (addAbbrevEl) addAbbrevEl.addEventListener('input', updateAddSku);
      if (addCodeEl) addCodeEl.addEventListener('input', updateAddSku);
      if (addSpecsEl) addSpecsEl.addEventListener('input', updateAddSku);

      // if (generateProductNameBtn) { // Removed button, so this event listener is also removed
      //   generateProductNameBtn.addEventListener('click', async () => {
      //       const abbrev = (String(addAbbrevEl ? addAbbrevEl.value : '')).trim();
      //       const code = (String(addCodeEl ? addCodeEl.value : '')).trim();
      //       const specs = (String(addSpecsEl ? addSpecsEl.value : '')).trim();

      //       if (!abbrev && !code && !specs) {
      //           if (aiProductNameStatus) aiProductNameStatus.textContent = 'กรุณากรอกข้อมูล "ชื่อย่อหมวด", "รหัส" หรือ "ขนาด, สี, จำเพาะอื่นๆ" อย่างน้อยหนึ่งช่อง';
      //           return;
      //       }

      //       const prompt = `สร้างชื่อสินค้าภาษาไทยที่กระชับและครบถ้วนจากข้อมูลต่อไปนี้:
      //       ${abbrev ? `ชื่อย่อหมวด: ${abbrev}` : ''}
      //       ${code ? `รหัส: ${code}` : ''}
      //       ${specs ? `ขนาด, สี, จำเพาะอื่นๆ: ${specs}` : ''}
      //       โดยไม่ใส่คำอธิบายเพิ่มเติมและให้เป็นชื่อสินค้าเท่านั้น.`;

      //       try {
      //           const generatedName = await callGeminiAPI(prompt, aiProductNameStatus);
      //           if (addProductNameEl && generatedName) {
      //               addProductNameEl.value = generatedName.replace(/"/g, '').trim();
      //           }
      //       } catch (error) {
      //           console.error("Failed to generate product name:", error);
      //       }
      //   });
      // }


      function resetAddProductForm() {
          currentEditingProductSku = null;
          addProductForm.reset();
          updateAddSku();
          if (addProductTitle) addProductTitle.textContent = 'จัดการสินค้า (เพิ่ม/แก้ไข/ลบ)'; // Updated title
          if (submitProductBtn) {
              submitProductBtn.textContent = 'บันทึกสินค้า';
              submitProductBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
              submitProductBtn.classList.add('bg-green-600', 'hover:bg-green-700');
          }
          if (cancelEditProductBtn) cancelEditProductBtn.classList.add('hidden');
          if (addSkuEl) addSkuEl.readOnly = true;
          if (editingProductIdField) editingProductIdField.value = '';
          if (addProductStatus) addProductStatus.textContent = '';
          if (aiProductNameStatus) aiProductNameStatus.textContent = '';
      }

      function populateProductFormForEdit(product) {
          if (!product) {
              resetAddProductForm();
              return;
          }
          currentEditingProductSku = String(product['รหัสสินค้า']||'').trim();
          if (editingProductIdField) editingProductIdField.value = String(product['รหัสสินค้า']||'').trim();

          if (addAbbrevEl) addAbbrevEl.value = String(product['ชื่อย่อหมวด'] || '').trim();
          if (addCodeEl) addCodeEl.value = String(product['รหัส'] || '').trim();
          if (addSpecsEl) addSpecsEl.value = String(product['ขนาด, สี, จำเพาะอื่นๆ'] || '').trim();
          if (addSkuEl) {
              addSkuEl.value = String(product['รหัสสินค้า'] || '').trim();
              addSkuEl.readOnly = true;
          }
          if (addProductNameEl) addProductNameEl.value = String(product['ชื่อสินค้า'] || '').trim();
          if (addUnitEl) addUnitEl.value = String(product['หน่วยนับ'] || '').trim();
          if (addMinQtyEl) addMinQtyEl.value = String(product['จำนวนขั้นต่ำ'] || '0').trim();

          if (addProductTitle) addProductTitle.textContent = `แก้ไขสินค้า: ${String(product['รหัสสินค้า']||'').trim()}`;
          if (submitProductBtn) {
              submitProductBtn.textContent = 'อัปเดตสินค้า';
              submitProductBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
              submitProductBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
          }
          if (cancelEditProductBtn) cancelEditProductBtn.classList.remove('hidden');
          if (addProductStatus) addProductStatus.textContent = '';
          if (aiProductNameStatus) aiProductNameStatus.textContent = '';
      }

      if (cancelEditProductBtn) {
          cancelEditProductBtn.addEventListener('click', resetAddProductForm);
      }

      function renderManageProducts(searchQuery = '') {
        if (!manageProductsTableBody) return;
        manageProductsTableBody.innerHTML = '';
        const lowerCaseQuery = searchQuery.toLowerCase().trim();

        const filteredProducts = cache.products.filter(product => {
            const sku = (String(product['รหัสสินค้า'] || '')).toLowerCase();
            const name = (String(product['ชื่อสินค้า'] || '')).toLowerCase();
            return sku.includes(lowerCaseQuery) || name.includes(lowerCaseQuery);
        });

        if (filteredProducts.length === 0) {
          manageProductsTableBody.innerHTML = '<tr><td class="px-4 py-3 text-gray-400" colspan="5">ไม่พบรายการสินค้า</td></tr>';
          return;
        }

        filteredProducts.forEach(product => {
          const tr = document.createElement('tr');
          tr.className = 'border-t border-gray-700/60';
          tr.innerHTML = `
            <td class="px-4 py-3">${String(product['รหัสสินค้า'] || '').trim()}</td>
            <td class="px-4 py-3">${String(product['ชื่อสินค้า'] || '').trim()}</td>
            <td class="px-4 py-3">${String(product['หน่วยนับ'] || '').trim()}</td>
            <td class="px-4 py-3 text-right">${Number(product['จำนวนขั้นต่ำ'] || 0).toLocaleString('th-TH')}</td>
            <td class="px-4 py-3 text-center">
              <button class="edit-product-btn px-3 py-1 mr-2 rounded bg-yellow-600 hover:bg-yellow-700 text-white text-xs font-medium" data-sku="${String(product['รหัสสินค้า'] || '').trim()}">
                แก้ไข
              </button>
              <button class="delete-product-btn px-3 py-1 rounded bg-red-600 hover:bg-red-700 text-white text-xs font-medium" data-sku="${String(product['รหัสสินค้า'] || '').trim()}">
                ลบ
              </button>
            </td>
          `;
          manageProductsTableBody.appendChild(tr);
        });

        document.querySelectorAll('.edit-product-btn').forEach(button => {
          button.addEventListener('click', (e) => {
            const sku = e.target.dataset.sku;
            const productToEdit = cache.products.find(p => String(p['รหัสสินค้า']||'').trim() === sku);
            if (productToEdit) {
              populateProductFormForEdit(productToEdit);
              setActiveTab('add-product');
            }
          });
        });

        document.querySelectorAll('.delete-product-btn').forEach(button => {
          button.addEventListener('click', async (e) => {
            const sku = e.target.dataset.sku;
            const productName = cache.products.find(p => String(p['รหัสสินค้า']||'').trim() === sku)?.['ชื่อสินค้า'] || sku;
            
            const confirmed = await showCustomConfirm(`คุณต้องการลบสินค้า "${String(productName||'').trim()}" นี้หรือไม่?`);
            if (confirmed) {
                const payload = {
                    actionType: 'deleteProduct',
                    data: { 'รหัสสินค้า': sku }
                };
                try {
                    const result = await sendToAppsScript(payload, addProductStatus);
                    loadAll();
                } catch (error) {
                    console.error('Error deleting product:', error);
                }
            }
          });
        });
      }

      if (manageProductsSearch) {
        manageProductsSearch.addEventListener('input', (e) => {
          renderManageProducts(e.target.value);
        });
      }


      if (addProductForm) { 
        addProductForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          if (addProductStatus) addProductStatus.textContent = '';

          const productData = {
            'ชื่อย่อหมวด': (String(addAbbrevEl ? addAbbrevEl.value : '')).trim(),
            'รหัส': (String(addCodeEl ? addCodeEl.value : '')).trim(),
            'ขนาด, สี, จำเพาะอื่นๆ': (String(addSpecsEl ? addSpecsEl.value : '')).trim(),
            'รหัสสินค้า': (String(addSkuEl ? addSkuEl.value : '')).trim(), 
            'ชื่อสินค้า': (String(addProductNameEl ? addProductNameEl.value : '')).trim(),
            'หน่วยนับ': (String(addUnitEl ? addUnitEl.value : '')).trim(),
            'จำนวนขั้นต่ำ': parseFloat(addMinQtyEl ? addMinQtyEl.value || '0' : '0'), 
          };

          let payload;
          if (currentEditingProductSku) {
            payload = {
              actionType: 'editProduct',
              data: {
                originalSku: currentEditingProductSku,
                newProductData: productData
              }
            };
          } else {
            payload = {
              actionType: 'addProduct',
              data: productData
            };
          }

          try {
            await sendToAppsScript(payload, addProductStatus);
            loadAll();
            resetAddProductForm();
          } catch(err) {
          }
        });
      }

      // =========================
      // Add/Edit/Delete Vendor Code
      // =========================
      const addVendorForm = document.getElementById('addVendorForm');
      const addVendorStatus = document.getElementById('addVendorStatus');
      const addVendorTitle = document.getElementById('addVendorTitle');
      const submitVendorBtn = document.getElementById('submitVendorBtn');
      const cancelEditVendorBtn = document.getElementById('cancelEditVendorBtn');
      const editingVendorIdField = document.getElementById('editingVendorId');

      const addVendorCodeEl = document.getElementById('addVendorCode');
      const addVendorNameEl = document.getElementById('addVendorName');
      const addVendorAddressEl = document.getElementById('addVendorAddress');
      const addVendorPhoneEl = document.getElementById('addVendorPhone');
      const addVendorRegTypeEl = document.getElementById('addVendorRegType');
      const manageVendorsTableBody = document.getElementById('manageVendorsTableBody');
      const manageVendorsSearch = document.getElementById('manageVendorsSearch');

      let currentEditingVendorCode = null;

      function resetAddVendorForm() {
          currentEditingVendorCode = null;
          addVendorForm.reset();
          if (addVendorCodeEl) addVendorCodeEl.value = cache.nextVendorCode;
          if (addVendorTitle) addVendorTitle.textContent = 'จัดการผู้ขาย (เพิ่ม/แก้ไข/ลบ)'; // Updated title
          if (submitVendorBtn) {
              submitVendorBtn.textContent = 'บันทึกผู้ขาย';
              submitVendorBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
              submitVendorBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
          }
          if (cancelEditVendorBtn) cancelEditVendorBtn.classList.add('hidden');
          if (addVendorCodeEl) addVendorCodeEl.readOnly = true;
          if (editingVendorIdField) editingVendorIdField.value = '';
          if (addVendorStatus) addVendorStatus.textContent = '';
      }

      function populateVendorFormForEdit(vendor) {
          if (!vendor) {
              resetAddVendorForm();
              return;
          }
          currentEditingVendorCode = String(vendor['รหัส Vendors']||'').trim();
          if (editingVendorIdField) editingVendorIdField.value = String(vendor['รหัส Vendors']||'').trim();

          if (addVendorCodeEl) addVendorCodeEl.value = String(vendor['รหัส Vendors'] || '').trim();
          if (addVendorNameEl) addVendorNameEl.value = String(vendor['Vender'] || '').trim();
          if (addVendorAddressEl) addVendorAddressEl.value = String(vendor['ที่อยู่'] || '').trim();
          if (addVendorPhoneEl) addVendorPhoneEl.value = String(vendor['เบอร์โทร'] || '').trim();
          if (addVendorRegTypeEl) addVendorRegTypeEl.value = String(vendor['ประเภทจดทบ.'] || '').trim();

          if (addVendorTitle) addVendorTitle.textContent = `แก้ไขผู้ขาย: ${String(vendor['Vender']||'').trim()}`;
          if (submitVendorBtn) {
              submitVendorBtn.textContent = 'อัปเดตผู้ขาย';
              submitVendorBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
              submitVendorBtn.classList.add('bg-purple-600', 'hover:bg-purple-700');
          }
          if (cancelEditVendorBtn) cancelEditVendorBtn.classList.remove('hidden');
          if (addVendorStatus) addVendorStatus.textContent = '';
      }

      if (cancelEditVendorBtn) {
          cancelEditVendorBtn.addEventListener('click', resetAddVendorForm);
      }

      function renderManageVendors(searchQuery = '') {
        if (!manageVendorsTableBody) return;
        manageVendorsTableBody.innerHTML = '';
        const lowerCaseQuery = searchQuery.toLowerCase().trim();

        const filteredVendors = cache.vendors.filter(vendor => {
            const code = (String(vendor['รหัส Vendors'] || '')).toLowerCase();
            const name = (String(vendor['Vender'] || '')).toLowerCase();
            return code.includes(lowerCaseQuery) || name.includes(lowerCaseQuery);
        });

        if (filteredVendors.length === 0) {
          manageVendorsTableBody.innerHTML = '<tr><td class="px-4 py-3 text-gray-400" colspan="6">ไม่พบรายการผู้ขาย</td></tr>';
          return;
        }

        filteredVendors.forEach(vendor => {
          const tr = document.createElement('tr');
          tr.className = 'border-t border-gray-700/60';
          tr.innerHTML = `
            <td class="px-4 py-3">${String(vendor['รหัส Vendors'] || '').trim()}</td>
            <td class="px-4 py-3">${String(vendor['Vender'] || '').trim()}</td>
            <td class="px-4 py-3">${String(vendor['ที่อยู่'] || '').trim()}</td>
            <td class="px-4 py-3">${String(vendor['เบอร์โทร'] || '').trim()}</td>
            <td class="px-4 py-3">${String(vendor['ประเภทจดทบ.'] || '').trim()}</td>
            <td class="px-4 py-3 text-center">
              <button class="edit-vendor-btn px-3 py-1 mr-2 rounded bg-purple-600 hover:bg-purple-700 text-white text-xs font-medium" data-vendor-code="${String(vendor['รหัส Vendors'] || '').trim()}">
                แก้ไข
              </button>
              <button class="delete-vendor-btn px-3 py-1 rounded bg-red-600 hover:bg-red-700 text-white text-xs font-medium" data-vendor-code="${String(vendor['รหัส Vendors'] || '').trim()}">
                ลบ
              </button>
            </td>
          `;
          manageVendorsTableBody.appendChild(tr);
        });

        document.querySelectorAll('.edit-vendor-btn').forEach(button => {
          button.addEventListener('click', (e) => {
            const vendorCode = e.target.dataset.vendorCode;
            const vendorToEdit = cache.vendors.find(v => String(v['รหัส Vendors']||'').trim() === vendorCode);
            if (vendorToEdit) {
              populateVendorFormForEdit(vendorToEdit);
              setActiveTab('add-vendor');
            }
          });
        });

        document.querySelectorAll('.delete-vendor-btn').forEach(button => {
          button.addEventListener('click', async (e) => {
            const vendorCode = e.target.dataset.vendorCode;
            const vendorName = cache.vendors.find(v => String(v['รหัส Vendors']||'').trim() === vendorCode)?.['Vender'] || vendorCode;
            
            const confirmed = await showCustomConfirm(`คุณต้องการลบผู้ขาย "${String(vendorName||'').trim()}" นี้หรือไม่?`);
            if (confirmed) {
                const payload = {
                    actionType: 'deleteVendor',
                    data: { 'รหัส Vendors': vendorCode }
                };
                try {
                    const result = await sendToAppsScript(payload, addVendorStatus);
                    loadAll();
                } catch (error) {
                    console.error('Error deleting vendor:', error);
                }
            }
          });
        });
      }

      if (manageVendorsSearch) {
        manageVendorsSearch.addEventListener('input', (e) => {
          renderManageVendors(e.target.value);
        });
      }


      if (addVendorForm) { 
        addVendorForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (addVendorStatus) addVendorStatus.textContent = '';

            const vendorData = {
                'รหัส Vendors': (String(addVendorCodeEl ? addVendorCodeEl.value : '')).trim(), 
                'Vender': (String(addVendorNameEl ? addVendorNameEl.value : '')).trim(),
                'ที่อยู่': (String(addVendorAddressEl ? addVendorAddressEl.value : '')).trim(),
                'เบอร์โทร': (String(addVendorPhoneEl ? addVendorPhoneEl.value : '')).trim(), 
                'ประเภทจดทบ.': (String(addVendorRegTypeEl ? addVendorRegTypeEl.value : '')).trim()
            };

            let payload;
            if (currentEditingVendorCode) {
                payload = {
                    actionType: 'editVendor',
                    data: {
                        originalVendorCode: currentEditingVendorCode,
                        newVendorData: vendorData
                    }
                };
            } else {
                payload = {
                    actionType: 'addVendor',
                    data: vendorData
                };
            }
            
            try {
                await sendToAppsScript(payload, addVendorStatus);
                loadAll(); 
                resetAddVendorForm();
            } catch(err) {
            }
        });
      }


      // =========================
      // Add/Edit/Delete Project Code
      // =========================
      const addProjectForm = document.getElementById('addProjectForm');
      const addProjectStatus = document.getElementById('addProjectStatus');
      const addProjectTitle = document.getElementById('addProjectTitle');
      const submitProjectBtn = document.getElementById('submitProjectBtn');
      const cancelEditProjectBtn = document.getElementById('cancelEditProjectBtn');
      const editingProjectIdField = document.getElementById('editingProjectId');
      const addProjectCustomerEl = document.getElementById('addProjectCustomer');
      const addProjectNameEl = document.getElementById('addProjectName');
      const addProjectShortNameEl = document.getElementById('addProjectShortName');
      const addProjectCodeNumEl = document.getElementById('addProjectCodeNum');
      const addProjectTypeEl = document.getElementById('addProjectType');
      const addProjectCodeTextEl = document.getElementById('addProjectCodeText');
      const addProjectPhaseEl = document.getElementById('addProjectPhase');
      const addProjectAlleyEl = document.getElementById('addProjectAlley');
      const addProjectHouseNoEl = document.getElementById('addProjectHouseNo');
      const addProjectDetailEl = document.getElementById('addProjectDetail');
      const addProjectCombinedCodeEl = document.getElementById('addProjectCombinedCode');
      const manageProjectsTableBody = document.getElementById('manageProjectsTableBody');
      const manageProjectsSearch = document.getElementById('manageProjectsSearch');
      const aiProjectDetailStatus = document.getElementById('aiProjectDetailStatus');

      let currentEditingProjectCombinedCode = null;

      // Helper function to pad numbers with leading zeros to 3 digits (NO LONGER USED FOR addProjectCodeNum)
      function padThreeDigits(num) {
          // This function is now mostly for illustrative purposes or if other fields might need it.
          // For addProjectCodeNum, padding is removed as per user request.
          let strNum = String(num);
          if (!isNaN(parseInt(strNum)) && strNum.length < 3) {
            return strNum.padStart(3, '0');
          }
          return strNum;
      }

      function updateProjectCombinedCode() {
        const customer = (String(addProjectCustomerEl?.value || '')).trim();
        const codeNum = (String(addProjectCodeNumEl?.value || '')).trim();
        const phase = (String(addProjectPhaseEl?.value || '')).trim();
        const alley = (String(addProjectAlleyEl?.value || '')).trim();
        const houseNo = (String(addProjectHouseNoEl?.value || '')).trim(); 

        const parts = [customer, codeNum, phase, alley, houseNo].filter(s => s).join('-');
        if (addProjectCombinedCodeEl) addProjectCombinedCodeEl.value = parts;
      }

      // NEW: Event listener for addProjectCodeNum to only remove non-digit characters
      if (addProjectCodeNumEl) {
        addProjectCodeNumEl.addEventListener('input', (event) => {
            let value = event.target.value;
            // Remove non-digit characters, but DO NOT limit length
            value = value.replace(/\D/g, '');
            event.target.value = value;
            updateProjectCombinedCode(); // Update combined code after filtering characters
        });

        // ลบ blur event ที่เคยทำหน้าที่เติม 0 ออกไป เพราะผู้ใช้ต้องการกรอกกี่ตัวก็ได้
        // addProjectCodeNumEl.addEventListener('blur', (event) => { /* Removed */ });
      }


      if (addProjectCustomerEl) addProjectCustomerEl.addEventListener('input', updateProjectCombinedCode);
      if (addProjectPhaseEl) addProjectPhaseEl.addEventListener('input', updateProjectCombinedCode);
      if (addProjectAlleyEl) addProjectAlleyEl.addEventListener('input', updateProjectCombinedCode);
      if (addProjectHouseNoEl) addProjectHouseNoEl.addEventListener('input', updateProjectCombinedCode);

      function resetAddProjectForm() {
          currentEditingProjectCombinedCode = null;
          addProjectForm.reset();
          if (addProjectCodeNumEl) addProjectCodeNumEl.value = ''; // Clear value
          updateProjectCombinedCode(); // Update combined code
          if (addProjectTitle) addProjectTitle.textContent = 'จัดการโครงการ (เพิ่ม/แก้ไข/ลบ)'; // Updated title
          if (submitProjectBtn) {
              submitProjectBtn.textContent = 'บันทึกโครงการ';
              submitProjectBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
              submitProjectBtn.classList.add('bg-purple-600', 'hover:bg-purple-700');
          }
          if (cancelEditProjectBtn) cancelEditProjectBtn.classList.add('hidden');
          if (addProjectCodeNumEl) addProjectCodeNumEl.readOnly = false; // Ensure it's editable
          if (addProjectCombinedCodeEl) addProjectCombinedCodeEl.readOnly = true; // Keep combined code readonly
          if (editingProjectIdField) editingProjectIdField.value = '';
          if (addProjectStatus) addProjectStatus.textContent = '';
          if (aiProjectDetailStatus) aiProjectDetailStatus.textContent = '';
      }

      function populateProjectFormForEdit(project) {
          if (!project) {
              resetAddProjectForm();
              return;
          }
          currentEditingProjectCombinedCode = String(project['กำหนดรหัสจุด']||'').trim();
          if (editingProjectIdField) editingProjectIdField.value = String(project['กำหนดรหัสจุด']||'').trim();
          if (addProjectCustomerEl) addProjectCustomerEl.value = String(project['Customer'] || '').trim();
          if (addProjectNameEl) addProjectNameEl.value = String(project['โครงการ'] || '').trim();
          if (addProjectShortNameEl) addProjectShortNameEl.value = String(project['ชื่อย่อ'] || '').trim();
          if (addProjectHouseNoEl) addProjectHouseNoEl.value = String(project['บ้านเลขที่'] || '').trim();
          if (addProjectCodeNumEl) {
            // ใช้ค่า 'รหัส' โดยตรง ไม่มีการ padding
            addProjectCodeNumEl.value = String(project['รหัส'] || '').trim();
            addProjectCodeNumEl.readOnly = false; // Ensure it's editable when editing an existing project
          }
          if (addProjectTypeEl) addProjectTypeEl.value = String(project['ประเภท'] || '').trim();
          if (addProjectCodeTextEl) addProjectCodeTextEl.value = String(project['CODE'] || '').trim();
          if (addProjectPhaseEl) addProjectPhaseEl.value = String(project['เฟส'] || '').trim();
          if (addProjectAlleyEl) addProjectAlleyEl.value = String(project['ซอย'] || '').trim();
          if (addProjectHouseNoEl) addProjectHouseNoEl.value = String(project['บ้านเลขที่'] || '').trim();
          if (addProjectDetailEl) addProjectDetailEl.value = String(project['รายละเอียด'] || '').trim();
          if (addProjectCombinedCodeEl) {
            addProjectCombinedCodeEl.value = String(project['กำหนดรหัสจุด'] || '').trim();
            addProjectCombinedCodeEl.readOnly = true;
          }

          if (addProjectTitle) addProjectTitle.textContent = `แก้ไขโครงการ: ${String(project['โครงการ']||'').trim()}`;
          if (submitProjectBtn) {
              submitProjectBtn.textContent = 'อัปเดตโครงการ';
              submitProjectBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
              submitProjectBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
          }
          if (cancelEditProjectBtn) cancelEditProjectBtn.classList.remove('hidden');
          if (addProjectStatus) addProjectStatus.textContent = '';
          if (aiProjectDetailStatus) aiProjectDetailStatus.textContent = '';
      }

      if (cancelEditProjectBtn) {
          cancelEditProjectBtn.addEventListener('click', resetAddProjectForm);
      }

      function renderManageProjects(searchQuery = '') {
        if (!manageProjectsTableBody) return;
        manageProjectsTableBody.innerHTML = '';
        const lowerCaseQuery = searchQuery.toLowerCase().trim();

        const filteredProjects = cache.projects.filter(project => {
            const code = (String(project['กำหนดรหัสจุด'] || '')).toLowerCase();
            const name = (String(project['โครงการ'] || '')).toLowerCase();
            const customer = (String(project['Customer'] || '')).toLowerCase();
            const shortName = (String(project['ชื่อย่อ'] || '')).toLowerCase();
            const codeNum = (String(project['รหัส'] || '')).toLowerCase();
            const type = (String(project['ประเภท'] || '')).toLowerCase();
            const CODE = (String(project['CODE'] || '')).toLowerCase();
            const phase = (String(project['เฟส'] || '')).toLowerCase();
            const alley = (String(project['ซอย'] || '')).toLowerCase();
            const houseNo = (String(project['บ้านเลขที่'] || '')).toLowerCase 
            return code.includes(lowerCaseQuery) || name.includes(lowerCaseQuery) || customer.includes(lowerCaseQuery) || shortName.includes(lowerCaseQuery);
        });

        if (filteredProjects.length === 0) {
          manageProjectsTableBody.innerHTML = '<tr><td class="px-4 py-3 text-gray-400" colspan="4">ไม่พบรายการโครงการ</td></tr>';
          return;
        }

        filteredProjects.forEach(project => {
          const tr = document.createElement('tr');
          tr.className = 'border-t border-gray-700/60';
          tr.innerHTML = `
            <td class="px-4 py-3">${String(project['กำหนดรหัสจุด'] || '').trim()}</td>
            <td class="px-4 py-3">${String(project['โครงการ'] || '').trim()}</td>
            <td class="px-4 py-3">${String(project['Customer'] || '').trim()}</td>
            <td class="px-4 py-3">${String(project['ชื่อย่อ'] || '').trim()}</td>
            <td class="px-4 py-3">${String(project['รหัส'] || '').trim()}</td>
            <td class="px-4 py-3">${String(project['ประเภท'] || '').trim()}</td>
            <td class="px-4 py-3">${String(project['CODE'] || '').trim()}</td>
            <td class="px-4 py-3">${String(project['เฟส'] || '').trim()}</td>
            <td class="px-4 py-3">${String(project['ซอย'] || '').trim()}</td>
            <td class="px-4 py-3">${String(project['บ้านเลขที่'] || '').trim()}</td>
            <td class="px-4 py-3 text-center">
              <button class="edit-project-btn px-3 py-1 mr-2 rounded bg-purple-600 hover:bg-purple-700 text-white text-xs font-medium" data-project-code="${String(project['กำหนดรหัสจุด'] || '').trim()}">
                แก้ไข
              </button>
              <button class="delete-project-btn px-3 py-1 rounded bg-red-600 hover:bg-red-700 text-white text-xs font-medium" data-project-code="${String(project['กำหนดรหัสจุด'] || '').trim()}">
                ลบ
              </button>
            </td>
          `;
          manageProjectsTableBody.appendChild(tr);
        });

        document.querySelectorAll('.edit-project-btn').forEach(button => {
          button.addEventListener('click', (e) => {
            const projectCode = e.target.dataset.projectCode;
            const projectToEdit = cache.projects.find(p => String(p['กำหนดรหัสจุด']||'').trim() === projectCode);
            if (projectToEdit) {
              populateProjectFormForEdit(projectToEdit);
              setActiveTab('add-project');
            }
          });
        });

        document.querySelectorAll('.delete-project-btn').forEach(button => {
          button.addEventListener('click', async (e) => {
            const projectCode = e.target.dataset.projectCode;
            const projectName = cache.projects.find(p => String(p['กำหนดรหัสจุด']||'').trim() === projectCode)?.['โครงการ'] || projectCode;
            
            const confirmed = await showCustomConfirm(`คุณต้องการลบโครงการ "${String(projectName||'').trim()}" นี้หรือไม่?`);
            if (confirmed) {
                const payload = {
                    actionType: 'deleteProject',
                    data: { 'กำหนดรหัสจุด': projectCode }
                };
                try {
                    const result = await sendToAppsScript(payload, addProjectStatus);
                    loadAll();
                } catch (error) {
                    console.error('Error deleting project:', error);
                }
            }
          });
        });
      }

      if (manageProjectsSearch) {
        manageProjectsSearch.addEventListener('input', (e) => {
          renderManageProjects(e.target.value);
        });
      }
      function exportVendorHistoryToExcel(vendor) {
        const purchases = (cache.lots || []).filter(lot => 
        String(lot['รหัส Vender'] || '').trim() === String(vendor['รหัส Vendors'] || '').trim()
    );
    if (purchases.length === 0) {
        alert('ไม่พบประวัติการซื้อกับร้านนี้');
        return;
    }
    const header = ['รหัสสินค้า', 'ชื่อสินค้า', 'จำนวน', 'มูลค่า (บาท)', 'วันที่ซื้อ'];
    const rows = purchases.map(lot => [
        `"${String(lot['รหัสสินค้า'] || '')}"`, // <<-- เพิ่มรหัสสินค้า
        `"${(lot['ชื่อสินค้า']||'').replace(/"/g, '""')}"`,
        Number(lot['จำนวนที่ซื้อ']||0),
        Number(lot['มูลค่ารวม']||0).toFixed(2),
        lot['วันที่']||''
    ]);
    const csvContent = '\uFEFF' + [header, ...rows].map(r => r.join(',')).join('\r\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ประวัติการซื้อ_${vendor['Vender']||vendor['รหัส Vendors']}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
function renderVendorMultiSelect() {
  const select = document.getElementById('vendorMultiSelect');
  if (!select) return;
  select.innerHTML = '';
  cache.vendors.forEach(v => {
    const opt = document.createElement('option');
    opt.value = String(v['รหัส Vendors'] || '').trim();
    opt.textContent = `${String(v['รหัส Vendors'] || '').trim()} — ${String(v['Vender'] || '').trim()}`;
    select.appendChild(opt);
  });
}

function showMultiVendorPurchaseModal(vendorCodes) {
  const modal = document.getElementById('vendorPurchaseModal');
  const title = document.getElementById('vendorPurchaseModalTitle');
  const list = document.getElementById('vendorPurchaseList');
  if (!modal || !title || !list) return;

  // รวมชื่อผู้ขาย
  const names = vendorCodes.map(code => {
    const v = cache.vendors.find(v => String(v['รหัส Vendors']||'').trim() === code);
    return v ? `${v['Vender']} (${v['รหัส Vendors']})` : code;
  }).join(', ');

  title.textContent = `ประวัติการซื้อกับ: ${names}`;

  // รวมประวัติการซื้อของทุก vendor ที่เลือก (ไม่ filter ตามจำนวนคงเหลือ)
  const purchases = (cache.lots || []).filter(lot =>
    vendorCodes.includes(String(lot['รหัส Vender'] || '').trim())
  );

  if (purchases.length === 0) {
    list.innerHTML = `<div class="text-gray-400">ไม่พบประวัติการซื้อกับผู้ขายที่เลือก</div>`;
  } else {
    list.innerHTML = purchases.map(lot => `
      <div class="bg-gray-700 border border-gray-600 rounded-md p-3">
        <div><span class="font-bold text-white">${lot['ชื่อสินค้า']}</span></div>
        <div class="text-sm">จำนวน: <span class="text-blue-300">${Number(lot['จำนวนที่ซื้อ']||0).toLocaleString('th-TH')}</span> | 
          มูลค่า: <span class="text-green-300">${Number(lot['มูลค่ารวม']||0).toLocaleString('th-TH', {minimumFractionDigits:2})} บาท</span>
        </div>
        <div class="text-xs text-gray-400">วันที่ซื้อ: ${lot['วันที่'] || '-'}</div>
      </div>
    `).join('');
  }
  modal.classList.remove('hidden');
}
      if (addProjectForm) { 
        addProjectForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (addProjectStatus) addProjectStatus.textContent = '';
            const projectData = {
                'Customer': (String(addProjectCustomerEl?.value || '')).trim(),
                'โครงการ': (String(addProjectNameEl?.value || '')).trim(),
                'ชื่อย่อ': (String(addProjectShortNameEl?.value || '')).trim(),
                'รหัส': (String(addProjectCodeNumEl?.value || '')).trim(), // ส่งเป็น String ที่ผู้ใช้กรอก
                'ประเภท': (String(addProjectTypeEl?.value || '')).trim(),
                'CODE': (String(addProjectCodeTextEl?.value || '')).trim(),
                'เฟส': (String(addProjectPhaseEl?.value || '')).trim(),
                'ซอย': (String(addProjectAlleyEl?.value || '')).trim(),
                'บ้านเลขที่': (String(addProjectHouseNoEl?.value || '')).trim(),
                'รายละเอียด': (String(addProjectDetailEl?.value || '')).trim(),
                'กำหนดรหัสจุด': (String(addProjectCombinedCodeEl?.value || '')).trim()
            };
            
            let payload;
            if (currentEditingProjectCombinedCode) {
              payload = {
                actionType: 'editProject',
                data: {
                  originalProjectCode: currentEditingProjectCombinedCode,
                  newProjectData: projectData
                }
              };
            } else {
              payload = {
                actionType: 'addProject',
                data: projectData // Send projectData with manually entered 'รหัส'
              };
            }

          try {
            await sendToAppsScript(payload, addProjectStatus);
            loadAll();
            resetAddProjectForm();
          } catch (err) {

          }
        });
      }
      // =========================
      // Project Expenditure Report Code
      // =========================
      const dashboardProjectExpenditureSelect = document.getElementById('dashboardProjectExpenditureSelect');
      const projectReportProductSearch = document.getElementById('projectReportProductSearch'); // New search input
      const viewProjectExpenditureBtn = document.getElementById('viewProjectExpenditureBtn');
      const projectExpenditureResult = document.getElementById('projectExpenditureResult');
      const exportProjectExpenditureBtn = document.getElementById('exportProjectExpenditureBtn');
      
      if (viewProjectExpenditureBtn) { 
        viewProjectExpenditureBtn.addEventListener('click', async () => {
            if (projectExpenditureResult) projectExpenditureResult.innerHTML = `<span class="inline-flex items-center gap-2 text-gray-200"><span class="w-4 h-4 border-2 border-white/60 border-t-transparent rounded-full spin"></span> กำลังโหลด...</span>`;
            
            const productSearchQuery = (String(projectReportProductSearch ? projectReportProductSearch.value : '')).toLowerCase().trim(); // Get search query

            if (!projectCode) {
                if (projectExpenditureResult) projectExpenditureResult.innerHTML = 'กรุณาเลือกโครงการ';
                return;
            }

            try {
                const payload = {
                    actionType: 'getDashboardProjectExpenditure',
                    data: { projectCode: projectCode }
                };
                const result = await sendToAppsScript(payload, projectExpenditureResult);
                if (result && result.projectExpenditure) {
                    const expenditure = result.projectExpenditure;
                    let itemsListHtml = '<ul class="list-disc list-inside text-xs mt-2">';
                    if (exportProjectExpenditureBtn) exportProjectExpenditureBtn.classList.remove('hidden'); // <<-- เพิ่มตรงนี้

                    // Filter itemsIssued based on productSearchQuery
                    const filteredItems = expenditure.itemsIssued.filter(item => {
                        const productName = (String(item.productName || '')).toLowerCase();
                        const productCode = (String(item.productCode || '')).toLowerCase();
                        return productName.includes(productSearchQuery) || productCode.includes(productSearchQuery);
                    });

                    if (filteredItems && filteredItems.length > 0) {
                        filteredItems.forEach(item => {
                            itemsListHtml += `<li>${String(item.productName||'').trim()} (${String(item.productCode||'').trim()}): ${Number(item.qty).toLocaleString('th-TH')} ชิ้น (มูลค่า ${Number(item.value).toLocaleString('th-TH', {minimumFractionDigits: 2})} บาท)</li>`;
                        });
                    } else {
                        itemsListHtml += `<li>ไม่มีรายการสินค้าที่เบิกไปใช้ในโครงการนี้${productSearchQuery ? ` (สำหรับ "${productSearchQuery}")` : ''}</li>`;
                    }
                    itemsListHtml += '</ul>';

                    if (projectExpenditureResult) { 
                        projectExpenditureResult.innerHTML = `
                            <div class="font-medium text-cyan-400">โครงการ: ${String(expenditure.projectCode||'').trim()}</div>
                            <div class="mt-2">มูลค่ารวมที่เบิกไป: <span class="text-blue-400 font-bold text-lg">${Number(expenditure.totalProjectCost).toLocaleString('th-TH', {minimumFractionDigits: 2})}</span> บาท</div>
                            <div class="mt-3 text-sm text-gray-300">รายการสินค้าที่เบิก:</div>
                            ${itemsListHtml}
                        `;
                    }
                } else {
                    if (projectExpenditureResult) projectExpenditureResult.innerHTML = `<span class="text-red-400">ไม่พบข้อมูลค่าใช้จ่ายโครงการ</span>`;
                }
            } catch (error) {
                if (projectExpenditureResult) projectExpenditureResult.innerHTML = `<span class="text-red-400">เกิดข้อผิดพลาด: ${error.message || 'ไม่สามารถโหลดค่าใช้จ่ายโครงการได้'}</span>`;
            }
        });
        if (exportProjectExpenditureBtn) {
          exportProjectExpenditureBtn.addEventListener('click', async () => {
            const productSearchQuery = (String(projectReportProductSearch ? projectReportProductSearch.value : '')).toLowerCase().trim();
        
            if (!projectCode) {
              alert('กรุณาเลือกโครงการก่อนส่งออก Excel');
              return;
            }
        
            try {
              const payload = {
                actionType: 'getDashboardProjectExpenditure',
                data: { projectCode: projectCode }
              };
              const result = await sendToAppsScript(payload);
              if (result && result.projectExpenditure) {
                const expenditure = result.projectExpenditure;
                // Filter itemsIssued ตาม productSearchQuery เหมือนในปุ่มดู
                const filteredItems = expenditure.itemsIssued.filter(item => {
                  const productName = (String(item.productName || '')).toLowerCase();
                  const productCode = (String(item.productCode || '')).toLowerCase();
                  return productName.includes(productSearchQuery) || productCode.includes(productSearchQuery);
                });
        
                const header = ['รหัสสินค้า', 'ชื่อสินค้า', 'จำนวนที่เบิก', 'มูลค่ารวม (บาท)'];
                const rows = filteredItems.map(item => [
                  `"${String(item.productCode||'')}"`,
                  `"${String(item.productName||'')}"`,
                  Number(item.qty||0),
                  Number(item.value||0).toFixed(2)
                ]);
                const csvContent = '\uFEFF' + [header, ...rows].map(r => r.join(',')).join('\r\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `รายงานโครงการ_${projectCode}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
              } else {
                alert('ไม่พบข้อมูลโครงการนี้');
              }
            } catch (error) {
              alert('เกิดข้อผิดพลาดในการส่งออก Excel');
            }
          });
        }
      }


      // Initial load
    loadAll();
    loadAll().then(() => {
      populateProductDatalist();
      populateVendorDatalist();
      populateIssueProductDatalist();
      populateIssueProjectDatalist();
      // ...อื่นๆ...
    });
            // หลัง loadAll() เสร็จ
      loadAll().then(() => {
        renderBudgetEstimate();
      });
      const selectAllBudgetEstimate = document.getElementById('selectAllBudgetEstimate');
      const exportSelectedBudgetEstimateBtn = document.getElementById('exportSelectedBudgetEstimateBtn');
      
      function updateExportBudgetEstimateButtonVisibility() {
        const checked = document.querySelectorAll('.budget-estimate-checkbox:checked');
        if (exportSelectedBudgetEstimateBtn) exportSelectedBudgetEstimateBtn.classList.toggle('hidden', checked.length === 0);
      }
      
      let selectedBudgetEstimateIds = new Set();
      document.addEventListener('change', function(e) {
        if (e.target.classList.contains('budget-estimate-checkbox')) {
          const lotId = e.target.value;
          if (e.target.checked) {
            selectedBudgetEstimateIds.add(lotId);
          } else {
            selectedBudgetEstimateIds.delete(lotId);
          }
          updateExportBudgetEstimateButtonVisibility();
        }
        if (e.target.id === 'selectAllBudgetEstimate') {
          const checked = e.target.checked;
          document.querySelectorAll('.budget-estimate-checkbox').forEach(cb => {
            cb.checked = checked;
            if (checked) {
              selectedBudgetEstimateIds.add(cb.value);
            } else {
              selectedBudgetEstimateIds.delete(cb.value);
            }
          });
          updateExportBudgetEstimateButtonVisibility();
        }
      });
      // ...หลัง renderBudgetEstimate() และ updateExportBudgetEstimateButtonVisibility()...

      if (exportSelectedBudgetEstimateBtn) {
        exportSelectedBudgetEstimateBtn.addEventListener('click', function() {
          const selectedLots = (cache.lots || []).filter(lot => selectedBudgetEstimateIds.has(lot.lotId));
          if (selectedLots.length === 0) {
            alert('กรุณาเลือกข้อมูลก่อนส่งออก Excel');
            return;
          }
          exportBudgetEstimateToExcel(selectedLots);
        });
      }
      // ฟังก์ชันส่งออก Excel
            function exportBudgetEstimateToExcel(lots) {
        // สรุปแยกตามแต่ละรหัสสินค้า
        const groupByProduct = {};
        lots.forEach(lot => {
          const code = lot['รหัสสินค้า'] || '-';
          if (!groupByProduct[code]) groupByProduct[code] = [];
          groupByProduct[code].push(lot);
        });
      
        // สร้าง summary rows
        const summaryRows = [];
        Object.entries(groupByProduct).forEach(([code, items]) => {
          const name = items[0]['ชื่อสินค้า'] || '-';
          const totalQty = items.reduce((sum, l) => sum + (+l['จำนวนที่ซื้อ'] || 0), 0);
          const totalValue = items.reduce((sum, l) => sum + (+l['มูลค่ารวม'] || 0), 0);
          const prices = items.map(l => +l['ราคา'] || 0).filter(p => p > 0);
          const minPrice = prices.length ? Math.min(...prices) : 0;
          const maxPrice = prices.length ? Math.max(...prices) : 0;
          const avgPrice = totalQty > 0 ? (totalValue / totalQty) : 0;
          const count = items.length;
          const remain = items.reduce((sum, l) => sum + (+l['จำนวนคงเหลือ'] || 0), 0);
          summaryRows.push([
            code,
            name,
            totalQty,
            totalValue.toFixed(2),
            avgPrice.toFixed(2),
            minPrice.toFixed(2),
            maxPrice.toFixed(2),
            count,
            remain
          ]);
        });
      
        // Header
        const header = [
          'รหัสสินค้า',
          'ชื่อสินค้า',
          'จำนวนที่เคยสั่งซื้อทั้งหมด',
          'ยอดรวมที่สั่งซื้อทั้งหมด',
          'ราคาเฉลี่ย (Average)',
          'ราคาต่ำสุด (Min)',
          'ราคาสูงสุด (Max)',
          'จำนวนครั้งที่ซื้อ',
          'จำนวนคงเหลือ'
        ];
      
        // สร้างไฟล์ CSV
        const csvContent = '\uFEFF' + [header, ...summaryRows].map(r => r.join(',')).join('\r\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `สรุปยอดซื้อแยกตามสินค้า.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      //จบฟังก์ชันส่งออก Excel

      const budgetEstimateProductSearch = document.getElementById('budgetEstimateProductSearch');
      const budgetEstimateVendorSearch = document.getElementById('budgetEstimateVendorSearch');
      const budgetEstimateProjectSearch = document.getElementById('budgetEstimateProjectSearch');
      const budgetEstimateSummary = document.getElementById('budgetEstimateSummary');
      const budgetEstimateTableBody = document.getElementById('budgetEstimateTableBody');

      if (budgetEstimateProductSearch) {
        budgetEstimateProductSearch.addEventListener('input', () => renderBudgetEstimate());
      }
      if (budgetEstimateVendorSearch) {
        budgetEstimateVendorSearch.addEventListener('input', () => renderBudgetEstimate());
      }
      if (budgetEstimateProjectSearch) {
        budgetEstimateProjectSearch.addEventListener('input', () => renderBudgetEstimate());
      }
      function renderBudgetEstimate(query = '') {
        const qProduct = (budgetEstimateProductSearch?.value || '').toLowerCase().trim();
        const qVendor = (budgetEstimateVendorSearch?.value || '').toLowerCase().trim();
        const qProject = (budgetEstimateProjectSearch?.value || '').toLowerCase().trim();
        
        const filteredLots = (cache.lots || []).filter(lot => {
          const productCode = String(lot['รหัสสินค้า'] || '').toLowerCase();
          const productName = String(lot['ชื่อสินค้า'] || '').toLowerCase();
          const vendorCode = String(lot['รหัส Vender'] || '').toLowerCase();
          const vendorObj = cache.vendors.find(v => String(v['รหัส Vendors']||'').trim() === String(lot['รหัส Vender']||'').trim());
          const vendorName = vendorObj ? String(vendorObj['Vender'] || '').toLowerCase() : '';
          const projectShort = String(lot['ชื่อย่อ'] || '').toLowerCase();
          const projectPhase = String(lot['เฟส'] || '').toLowerCase();
          const projectAlley = String(lot['ซอย'] || '').toLowerCase();
          const projectHouseNo = String(lot['บ้านเลขที่'] || '').toLowerCase();
          const projectCode = String(lot['กำหนดรหัสจุด'] || '').toLowerCase();
          
          const productMatch = !qProduct || productCode.includes(qProduct) || productName.includes(qProduct);
          const vendorMatch = !qVendor || vendorCode.includes(qVendor) || vendorName.includes(qVendor);
          const projectMatch = !qProject ||
            projectShort.includes(qProject) ||
            projectPhase.includes(qProject) ||
            projectAlley.includes(qProject) ||
            projectHouseNo.includes(qProject) ||
            projectCode.includes(qProject);
          return productMatch && vendorMatch && projectMatch;

        });

        if (filteredLots.length === 0) {
          budgetEstimateTableBody.innerHTML = '<tr><td class="px-4 py-3 text-gray-400" colspan="6">ไม่พบรายการซื้อสำหรับสินค้านี้</td></tr>';
          budgetEstimateSummary.innerHTML = '';
          return;
        }
        // คำนวณสถิติ
        const totalQty = filteredLots.reduce((sum, lot) => sum + (+lot['จำนวนที่ซื้อ'] || 0), 0);
        const totalValue = filteredLots.reduce((sum, lot) => sum + (+lot['มูลค่ารวม'] || 0), 0);
        const prices = filteredLots.map(lot => +lot['ราคา'] || 0).filter(p => p > 0);
        const minPrice = prices.length ? Math.min(...prices) : 0;
        const maxPrice = prices.length ? Math.max(...prices) : 0;
        const avgPrice = totalQty > 0 ? (totalValue / totalQty) : 0;
        const totalRemain = filteredLots.reduce((sum, lot) => sum + (+lot['จำนวนคงเหลือ'] || 0), 0);
      
        budgetEstimateSummary.innerHTML = `
          <div>จำนวนที่เคยสั่งซื้อทั้งหมด: <span class="text-blue-400 font-bold">${totalQty.toLocaleString('th-TH')}</span> หน่วย</div>
          <div>ยอดรวมที่สั่งซื้อทั้งหมด: <span class="text-green-400 font-bold">${totalValue.toLocaleString('th-TH', {minimumFractionDigits:2})}</span> บาท</div>
          <div>จำนวนคงเหลือ: <span class="text-green-400 font-bold">${totalRemain.toLocaleString('th-TH')}</span> หน่วย</div>
          <div>ราคาเฉลี่ย (Average): <span class="text-yellow-400 font-bold">${avgPrice.toLocaleString('th-TH', {minimumFractionDigits:2})}</span> บาท/หน่วย</div>
          <div>ราคาต่ำสุด (Min): <span class="text-green-400 font-bold">${minPrice.toLocaleString('th-TH', {minimumFractionDigits:2})}</span> บาท/หน่วย</div>
          <div>ราคาสูงสุด (Max): <span class="text-red-400 font-bold">${maxPrice.toLocaleString('th-TH', {minimumFractionDigits:2})}</span> บาท/หน่วย</div>
          <div>จำนวนครั้งที่ซื้อ: <span class="text-cyan-400 font-bold">${filteredLots.length}</span> ครั้ง</div>
        `;
        function getVendorName(vendorCode) {
          const v = cache.vendors.find(v => String(v['รหัส Vendors']||'').trim() === String(vendorCode||'').trim());
          return v ? v['Vender'] : (vendorCode || '-');
        }
        
        function getVendorName(vendorCode) {
          const v = cache.vendors.find(v => String(v['รหัส Vendors']||'').trim() === String(vendorCode||'').trim());
          return v ? v['Vender'] : (vendorCode || '-');
        }

        function formatDateOnly(dateStr) {
          if (!dateStr) return '-';
          let d = dateStr;
          if (dateStr.includes('T')) d = dateStr.split('T')[0];
          if (/^\d{4}-\d{2}-\d{2}$/.test(d)) {
            const [y, m, day] = d.split('-');
            return `${day}/${m}/${y}`;
          } 
          return d;
}
        console.log(filteredLots);
        const summaryRow = `
          
        `;
        budgetEstimateTableBody.innerHTML =
        summaryRow +
        filteredLots.map((lot, idx) =>`
          <tr>
            <td class="px-4 py-3 text-center">
              <input type="checkbox" class="budget-estimate-checkbox" value="${lot.lotId}" ${selectedBudgetEstimateIds.has(lot.lotId) ? 'checked' : ''}>
            </td>
            <td class="px-4 py-3">${formatDateOnly(lot['วันที่'])}</td>
            <td class="px-4 py-3">${lot['รหัสสินค้า'] || '-'}</td>
            <td class="px-4 py-3">${lot['ชื่อสินค้า'] || '-'}</td>
            <td class="px-4 py-3">${Number(lot['จำนวนที่ซื้อ'] || 0).toLocaleString('th-TH')}</td>
            <td class="px-4 py-3">${Number(lot['จำนวนคงเหลือ'] || 0).toLocaleString('th-TH')}</td>
            <td class="px-4 py-3">${Number(lot['ราคา'] || 0).toLocaleString('th-TH', {minimumFractionDigits:2})}</td>
            <td class="px-4 py-3">${Number(lot['มูลค่ารวม'] || 0).toLocaleString('th-TH', {minimumFractionDigits:2})}</td>
            <td class="px-4 py-3">${getVendorName(lot['รหัส Vender'])}</td>
          </tr>
        
        `).join('');
        filteredLots.map((lot, idx) => `
          <tr>
            <td class="px-4 py-3 text-center">
              <input type="checkbox" class="budget-estimate-checkbox" value="${lot.lotId}" ${selectedBudgetEstimateIds.has(lot.lotId) ? 'checked' : ''}>
            </td>
            <!-- ...คอลัมน์อื่นๆ... -->
          </tr>
        `).join('');
        // ...existing code...
      }
            // ...หลัง loadAll() แล้ว...
      function renderProjectMultiSelect() {
        const box = document.getElementById('projectMultiSelect');
        const search = document.getElementById('projectMultiSearch');
        if (!box) return;
        const q = (search?.value || '').toLowerCase();
        box.innerHTML = '';
        cache.projects
          .filter(p => !q || (String(p['โครงการ']||'').toLowerCase().includes(q) || String(p['กำหนดรหัสจุด']||'').toLowerCase().includes(q)))
          .forEach(p => {
            const id = String(p['กำหนดรหัสจุด']||'').trim();
            const label = `${id} — ${String(p['โครงการ']||'').trim()}${p['ชื่อย่อ']?' ('+String(p['ชื่อย่อ']||'').trim()+')':''}`;
            box.innerHTML += `<label class="flex items-center gap-2"><input type="checkbox" class="project-multi-checkbox" value="${id}"> ${label}</label>`;
          });
      }
      let selectedProjectReportProductIds = new Set();
            document.addEventListener('change', function(e) {
        if (e.target.classList.contains('product-multi-checkbox')) {
          const productId = e.target.value;
          if (e.target.checked) {
            selectedProjectReportProductIds.add(productId);
          } else {
            selectedProjectReportProductIds.delete(productId);
          }
        }
        if (e.target.id === 'selectAllProducts') {
          const checked = e.target.checked;
          document.querySelectorAll('.product-multi-checkbox').forEach(cb => {
            cb.checked = checked;
            if (checked) {
              selectedProjectReportProductIds.add(cb.value);
            } else {
              selectedProjectReportProductIds.delete(cb.value);
            }
          });
        }
      });
      function renderProductMultiSelect() {
        const box = document.getElementById('productMultiSelect');
        const search = document.getElementById('productMultiSearch');
        if (!box) return;
        const q = (search?.value || '').toLowerCase();
        box.innerHTML = '';
        cache.products
          .filter(p => !q || (String(p['ชื่อสินค้า']||'').toLowerCase().includes(q) || String(p['รหัสสินค้า']||'').toLowerCase().includes(q)))
          .forEach(p => {
            const id = String(p['รหัสสินค้า']||'').trim();
            const label = `${id} — ${String(p['ชื่อสินค้า']||'').trim()}`;
            box.innerHTML += `<label class="flex items-center gap-2"><input type="checkbox" class="product-multi-checkbox" value="${id}" ${selectedProjectReportProductIds.has(id) ? 'checked' : ''}> ${label}</label>`;
          });
      }
      document.getElementById('projectMultiSearch')?.addEventListener('input', renderProjectMultiSelect);
      document.getElementById('productMultiSearch')?.addEventListener('input', renderProductMultiSelect);
      renderProjectMultiSelect();
      renderProductMultiSelect();
      
      // เลือกทั้งหมด
      document.getElementById('selectAllProjects')?.addEventListener('change', function(e) {
        const checked = e.target.checked;
        document.querySelectorAll('.project-multi-checkbox').forEach(cb => cb.checked = checked);
      });
      document.getElementById('selectAllProducts')?.addEventListener('change', function(e) {
        const checked = e.target.checked;
        document.querySelectorAll('.product-multi-checkbox').forEach(cb => cb.checked = checked);
      });
      
      // ดูค่าใช้จ่ายโครงการ (โหลดไวด้วย multi-project)
      document.getElementById('viewProjectExpenditureBtn')?.addEventListener('click', async () => {
        const resultBox = document.getElementById('projectExpenditureResult');
        resultBox.innerHTML = `<span class="inline-flex items-center gap-2 text-gray-200"><span class="w-4 h-4 border-2 border-white/60 border-t-transparent rounded-full spin"></span> กำลังโหลด...</span>`;
        const projectCodes = Array.from(document.querySelectorAll('.project-multi-checkbox:checked')).map(cb=>cb.value);
        const productCodes = Array.from(document.querySelectorAll('.product-multi-checkbox:checked')).map(cb=>cb.value.toLowerCase());
        if (!projectCodes.length) {
          resultBox.innerHTML = 'กรุณาเลือกโครงการ';
          return;
        }
        // ส่ง request เดียว (ต้องมี actionType getDashboardMultiProjectExpenditure ใน Apps Script)
        const payload = { actionType: 'getDashboardMultiProjectExpenditure', data: { projectCodes } };
        const result = await sendToAppsScript(payload, resultBox);
        let html = '';
        if (result && result.multiProjectExpenditure) {
          projectCodes.forEach(projectCode => {
            const project = result.multiProjectExpenditure[projectCode];
            if (!project) return;
            let items = project.itemsIssued;
            if (productCodes.length) {
              items = items.filter(item => productCodes.includes(String(item.productCode||'').toLowerCase()));
            }
            html += `<div class="font-medium text-cyan-400">โครงการ: ${projectCode}</div>
              <div class="mt-2">มูลค่ารวมที่เบิกไป: <span class="text-blue-400 font-bold text-lg">${Number(project.totalProjectCost).toLocaleString('th-TH', {minimumFractionDigits: 2})}</span> บาท</div>
              <div class="mt-3 text-sm text-gray-300">รายการสินค้าที่เบิก:</div>
              <ul class="list-disc list-inside text-xs mt-2">
              ${items.length ? items.map(item=>`<li>${item.productName} (${item.productCode}): ${Number(item.qty).toLocaleString('th-TH')} ชิ้น (มูลค่า ${Number(item.value).toLocaleString('th-TH', {minimumFractionDigits: 2})} บาท)</li>`).join('') : '<li>ไม่มีรายการสินค้าที่เบิกไปใช้ในโครงการนี้</li>'}
              </ul>
              <hr class="my-2 border-gray-700">`;
          });
        }
        resultBox.innerHTML = html;
      });
      
      // ส่งออก Excel หลายโครงการ/สินค้า
      document.getElementById('exportProjectExpenditureBtn')?.addEventListener('click', async function() {
        const btn = this;
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'กำลังส่งออก...';
        btn.classList.add('opacity-60', 'cursor-not-allowed');

        try {
          const projectCodes = Array.from(document.querySelectorAll('.project-multi-checkbox:checked')).map(cb=>cb.value);
          const productCodes = Array.from(document.querySelectorAll('.product-multi-checkbox:checked')).map(cb=>cb.value.toLowerCase());
          if (!projectCodes.length) {
            alert('กรุณาเลือกโครงการก่อนส่งออก Excel');
            return;
          }
          const payload = { actionType: 'getDashboardMultiProjectExpenditure', data: { projectCodes } };
          const result = await sendToAppsScript(payload);
          let allRows = [];
          if (result && result.multiProjectExpenditure) {
            projectCodes.forEach(projectCode => {
              const project = result.multiProjectExpenditure[projectCode];
              if (!project) return;
              let items = project.itemsIssued;
              if (productCodes.length) {
                items = items.filter(item => productCodes.includes(String(item.productCode||'').toLowerCase()));
              }
              items.forEach(item => {
                allRows.push([
                  projectCode,
                  String(item.productCode||''),
                  String(item.productName||''),
                  Number(item.qty||0),
                  Number(item.value||0).toFixed(2)
                ]);
              });
            });
          }
          if (allRows.length === 0) {
            alert('ไม่พบข้อมูลสำหรับโครงการที่เลือก');
            return;
          }
              const header = ['รหัสโครงการ', 'รหัสสินค้า', 'ชื่อสินค้า', 'จำนวนที่เบิก', 'มูลค่ารวม (บาท)'];
          const csvContent = '\uFEFF' + [header, ...allRows].map(r => r.join(',')).join('\r\n');
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `รายงานโครงการ_หลายโครงการ.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
          btn.classList.remove('opacity-60', 'cursor-not-allowed');
        }
      });
    })
  </script>
</body>
