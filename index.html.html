<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÄ‡∏î‡∏≠‡∏∞ ‡∏ã‡∏±‡∏û‡∏û‡∏≠‡∏£‡πå‡∏ï ‡∏à‡∏≥‡∏Å‡∏±‡∏î</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Chart.js for Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script>
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ò‡∏µ‡∏° Tailwind CSS
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Kanit', 'sans-serif'], // ‡πÉ‡∏ä‡πâ Kanit ‡πÄ‡∏õ‡πá‡∏ô‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏´‡∏•‡∏±‡∏Å
          },
          colors: {
            base: { bg: '#0a0b12', card: '#121326', line: '#1f2140' },
            neon: { blue: '#4cc1ff', violet: '#a78b45', fuchsia: '#ff6bff', cyan: '#3fe3ff' }
          },
          boxShadow: {
            neonBlue: '0 0 22px rgba(76,193,255,.35)',
            neonViolet: '0 0 22px rgba(167,139,250,.35)',
          }
        }
      }
    }
  </script>
  <style>
    /* Ensure HTML and Body take full height and width, and set background */
    html {
      height: 100%;
      width: 100%;
    }
    body {
      font-family: 'Kanit', sans-serif;
      background-color: #0a0b12; /* Explicit background from base.bg */
      min-height: 100vh; /* Use viewport height */
      width: 100vw; /* Use viewport width */
      display: flex; /* Make body a flex container */
      margin: 0;
      padding: 0;
      overflow-x: hidden; /* Prevent horizontal scroll on body */
    }

    /* Neon Gradient for buttons and progress bar from user's code */
    .neon-gradient {
      background: linear-gradient(135deg, #3b82f6, #8b5cf6, #06b6d4);
      background-size: 200% 200%;
      animation: gradientShift 3s ease infinite;
    }

    /* Neon Glow for main elements/buttons from user's code */
    .neon-glow {
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.5), 0 0 40px rgba(139, 92, 246, 0.3);
    }

    /* Pulse Ring animation for refresh button from user's code */
    .pulse-ring {
      position: absolute;
      border: 2px solid rgba(59, 130, 246, 0.6);
      border-radius: 50%;
      animation: pulseRing 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
    }

    /* Refresh Spin animation for icon from user's code */
    .refresh-spin {
      animation: refreshSpin 1s linear infinite;
    }

    /* Progress Bar styles from user's code */
    .progress-bar {
      width: 0%;
      transition: width 2s ease-in-out;
    }
    .progress-active {
      width: 100%;
    }

    /* Ripple effect for refresh button from user's code */
    .ripple {
      position: absolute;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.6);
      transform: scale(0);
      animation: rippleEffect 0.6s linear;
      pointer-events: none;
    }

    /* Keyframes from user's provided code */
    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    @keyframes pulseRing {
      0% {
        transform: scale(0.33);
        opacity: 1;
      }
      80%, 100% {
        transform: scale(2.5);
        opacity: 0;
      }
    }

    @keyframes refreshSpin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    @keyframes rippleEffect {
      to {
        transform: scale(4);
        opacity: 0;
      }
    }

    /* Menu item styles from user's provided code */
    .menu-item {
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      display: flex; /* Added for consistency with current layout */
      align-items: center; /* Added for consistency with current layout */
      padding: 1rem 1.5rem; /* px-6 py-4 */
      cursor: pointer;
      color: #D1D5DB; /* text-gray-300 default */
      gap: 0.75rem; /* space-x-3 equivalent for flex gap */
    }

    .menu-item:hover {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
      transform: translateX(8px);
      color: white; /* Ensure text is white on hover */
    }

    .menu-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 3px;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      transform: scaleY(0);
      transition: transform 0.3s ease;
    }

    .menu-item:hover::before {
      transform: scaleY(1);
    }

    /* Active tab style */
    .menu-item.tab-active { 
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
      color: white; /* Active text color */
    }
    .menu-item.tab-active::before {
      transform: scaleY(1); /* Active indicator */
    }

    .glow-border {
      box-shadow: inset 0 0 0 1px rgba(167,139,250,.45), 0 0 16px rgba(76,193,255,.18);
    }
    .glow-focus:focus { outline: none; box-shadow: 0 0 0 3px rgba(76,193,255,.35); }
    
    /* Original spin animation - kept for general use */
    .spin { animation: spin 0.9s linear infinite; } 
    @keyframes spin { to { transform: rotate(360deg); } }

    .table th { background: rgba(76,193,255,.10); font-weight: 600; }
    .table tr:hover { background: rgba(167,139,250,.10); }
    /* Make select options text black as requested */
    select option { color: #111827; }
    /* Datalist input style */
    input[list] {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
    }
    
    /* === Sidebar & Main Content - Responsive adjustments === */
    /* Base styles for sidebar and main content */
    .sidebar-wrapper {
        position: fixed; /* Changed to fixed for mobile slide-out effect */
        top: 0;
        left: 0;
        height: 100vh;
        width: 16rem; /* w-64 */
        background-color: #1f2937; /* bg-gray-800 */
        overflow-y: auto;
        transform: translateX(0%); /* Default to visible on desktop */
        transition: transform 0.3s ease-in-out; /* Add transition */
        z-index: 50; /* Ensure sidebar is above other content on mobile */
    }

    .main-content-wrapper {
        flex: 1;
        min-width: 0;
        overflow-y: auto;
        margin-left: 0; /* Default for desktop */
        transition: margin-left 0.3s ease-in-out; /* Add transition */
    }

    /* Mobile-specific styles */
    @media (max-width: 767px) { /* md:hidden equivalent */
        .sidebar-wrapper {
            transform: translateX(-100%); /* Hidden by default on mobile */
        }
        .sidebar-wrapper.sidebar-open { /* Class added by JS when sidebar is open */
            transform: translateX(0%);
        }
        .main-content-wrapper {
            margin-left: 0; /* No margin on mobile */
            padding-top: 5rem; /* Space for fixed mobile header */
        }
        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40; /* Between mobile header and sidebar */
            display: none; /* Hidden by default */
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
        }
        .sidebar-overlay.overlay-active {
            display: block;
            opacity: 1;
        }
    }

    /* Custom modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background-color: #1f2937; /* bg-gray-800 */
      padding: 2rem;
      border-radius: 0.75rem; /* rounded-xl */
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); /* neon-glow effect */
      max-width: 700px;
      width: 95%;
      text-align: center;
    }
    #outOfStockModal .modal-content {
      max-height: 80vh;
      overflow-y: auto;
    }


    /* Specific modal style for lot details to allow more content */
    #lotDetailModal .modal-content {
      max-width: 600px; /* Wider for lot details */
      text-align: left; /* Align text left for readability */
    }
        /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô <style> ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î‡πÉ‡∏ô <head>) */
    
    /* --- ‡∏õ‡∏£‡∏±‡∏ö sidebar ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ö main-content ‡∏ö‡∏ô desktop --- */
    @media (min-width: 768px) {
      .sidebar-wrapper {
        left: 0;
        top: 0;
        height: 100vh;
        width: 16rem;
        position: fixed;
        z-index: 50;
      }
      .main-content-wrapper {
        margin-left: 16rem; /* ‡∏Ç‡∏¢‡∏±‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å sidebar */
      }
    }
    
    /* ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (max-width: 767px) ‡πÉ‡∏´‡πâ sidebar ‡∏ã‡πâ‡∏≠‡∏ô‡∏ó‡∏±‡∏ö‡πÅ‡∏•‡∏∞ main-content ‡πÑ‡∏°‡πà‡∏°‡∏µ margin */
    @media (max-width: 767px) {
      .main-content-wrapper {
        margin-left: 0 !important;
      }
    }
        /* --- Force text color to white for form controls and table --- */
    select, input, textarea, option, table, th, td {
      color: #fff !important;
      background-color: inherit;
    }
    
    /* Option in dropdown (for most browsers) */
    select option {
      color: #fff !important;
      background: #1f2937 !important; /* ‡πÉ‡∏´‡πâ dropdown list ‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡πÄ‡∏Ç‡πâ‡∏° */
    }
    
    /* Table header and cell text */
    .table th, .table td {
      color: #fff !important;
    }
    
    /* For autofill background in Chrome */
    input:-webkit-autofill, textarea:-webkit-autofill, select:-webkit-autofill {
      -webkit-text-fill-color: #fff !important;
      box-shadow: 0 0 0px 1000px #1f2937 inset;
    }
  </style>
</head>
<body class="bg-gray-900 text-white">
  <!-- Mobile Header - ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ -->
  <header class="md:hidden bg-blue-600 text-white shadow-lg fixed top-0 left-0 right-0 z-40">
    <div class="px-4 py-4 flex justify-between items-center">
        <h1 class="text-xl font-bold">üì¶ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á</h1>
        <button id="sidebarToggle" class="p-2 rounded-lg hover:bg-blue-700 transition-colors">
            <!-- ‡∏õ‡∏∏‡πà‡∏° Hamburger -->
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>
    </div>
  </header>

  <!-- Overlay ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ -->
  <div id="sidebarOverlay" class="sidebar-overlay"></div>

  <!-- Sidebar -->
  <div id="sidebar" class="sidebar-wrapper">
    <div class="p-6 border-b border-gray-700 flex items-center justify-between">
      <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
        The Support
      </h1>
      <!-- Close button for mobile sidebar -->
      <button id="sidebarClose" class="md:hidden p-1 rounded-lg text-gray-400 hover:bg-gray-700">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <nav class="mt-6">
      <div data-tab="dashboard" class="menu-item tab-active">
        <i class="fas fa-tachometer-alt text-blue-400 w-5"></i>
        <span>Dashboard</span>
      </div>
      <div data-tab="add-product" class="menu-item">
        <i class="fas fa-cubes text-green-400 w-5"></i>
        <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
      </div>
      <div data-tab="add-vendor" class="menu-item">
        <i class="fas fa-handshake text-yellow-400 w-5"></i>
        <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</span>
      </div>
      <div data-tab="add-project" class="menu-item">
        <i class="fas fa-building text-purple-400 w-5"></i>
        <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</span>
      </div>
      <div data-tab="purchase" class="menu-item">
        <i class="fas fa-shopping-cart text-orange-400 w-5"></i>
        <span>‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
      </div>
      <div data-tab="issue" class="menu-item">
        <i class="fas fa-box-open text-pink-400 w-5"></i>
        <span>‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
      </div>
      
      <!-- Reports Dropdown -->
      <div id="toggleReportsDropdown" class="menu-item justify-between">
        <div class="flex items-center gap-3">
          <i class="fas fa-chart-bar text-cyan-400 w-5"></i>
          <span>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</span>
        </div>
        <i id="reportsDropdownArrow" class="fas fa-chevron-down transform transition-transform duration-200 text-gray-400"></i>
      </div>
      <div id="reportsDropdown" class="ml-4 mt-1 space-y-1 hidden">
        <div data-tab="report" class="menu-item text-sm">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å</div>
        <div data-tab="vendors-list" class="menu-item text-sm">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</div>
        <div data-tab="project-expenditure-report" class="menu-item text-sm">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</div>
      </div>
      <div data-tab="budget-estimate" class="menu-item">
        <i class="fas fa-calculator text-cyan-400 w-5"></i>
        <span>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</span>
      </div>
      <!-- End Reports Dropdown -->

      <div data-tab="settings" class="menu-item">
        <i class="fas fa-cogs text-gray-400 w-5"></i>
        <span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
      </div>
    </nav>
  </div>

  <!-- Main Content -->
  <div id="mainContentWrapper" class="main-content-wrapper">
    <!-- Inner div for consistent padding on all content -->
    <div class="content-padded-wrapper p-4 sm:p-6 lg:p-8 pb-8">
      <header class="flex items-center justify-between w-full mb-8">
        <h2 class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
          ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á
        </h2>

        <!-- Refresh Button and its elements -->
        <div class="flex flex-col items-end">
          <button id="refreshBtn" class="relative neon-gradient neon-glow px-4 py-2 rounded-full font-semibold text-white text-sm transition-all duration-300 hover:scale-105 active:scale-95 overflow-hidden">
            <i id="refreshIcon" class="fas fa-sync-alt mr-2"></i>
            <span id="btnLabel">Refresh</span>
          </button>
          <div class="w-24 bg-gray-700 rounded-full h-1.5 mt-2 overflow-hidden">
            <div id="progressBar" class="progress-bar h-full neon-gradient rounded-full relative">
              <div class="absolute inset-0 bg-white opacity-30 animate-pulse"></div>
            </div>
          </div>
          <div id="statusText" class="text-gray-400 text-xs font-medium mt-1">
            ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
          </div>
        </div>
      </header>

      <section id="tab-dashboard" class="tab-section">
        <h2 class="text-2xl md:text-3xl font-bold text-white mb-6">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° Dashboard</h2>
        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-gray-800 rounded-xl p-6 card-hover border border-gray-700">
            <p class="text-gray-300 text-sm">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏£‡∏ß‡∏°</p>
            <div class="flex items-end gap-2 mt-2">
                <h2 id="kpiTotalQty" class="text-3xl font-bold text-white">-</h2>
                <span class="text-xs text-gray-400">‡∏´‡∏ô‡πà‡∏ß‡∏¢</span>
            </div>
            <p id="kpiUpdatedAt" class="text-sm text-gray-400 mt-2">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: -</p>
            </div>
            <div class="bg-gray-800 rounded-xl p-6 card-hover border border-gray-700">
            <p class="text-gray-300 text-sm">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
            <div class="flex items-end gap-2 mt-2">
                <h2 id="kpiStockValue" class="text-3xl font-bold text-white">-</h2>
                <span class="text-xs text-gray-400">‡∏ö‡∏≤‡∏ó</span>
            </div>
            <p class="text-sm text-gray-400 mt-2">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
            </div>
            <div class="bg-gray-800 rounded-xl p-6 card-hover border border-gray-700">
            <p class="text-gray-300 text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
            <div class="flex items-end gap-2 mt-2">
                <h2 id="kpiProductCount" class="text-3xl font-bold text-white">-</h2>
                <span class="text-xs text-gray-400">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
            </div>
            <p class="text-sm text-gray-400 mt-2">Active</p>
            </div>
            <div class="bg-gray-800 rounded-xl p-6 card-hover border border-gray-700">
            <p class="text-gray-300 text-sm">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ Deadstock</p>
            <div class="flex items-end gap-2 mt-2">
                <h2 id="kpiDeadValue" class="text-3xl font-bold text-red-400">-</h2>
                <span class="text-xs text-gray-400">‡∏ö‡∏≤‡∏ó</span>
            </div>
            <p class="text-sm text-gray-400 mt-2" id="kpiDeadPercent">-</p>
            </div>
        </div>

        <!-- Alerts -->
        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 mb-6">
            <h3 class="font-semibold text-xl mb-4 text-orange-400">üîî ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
            <div id="alertsContainer" class="space-y-3">
            <div class="text-gray-400 text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô...</div>
            </div>
        </div>

        <!-- Top 5 ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡πÄ‡∏£‡πá‡∏ß -->
        <div class="bg-gray-800 rounded-xl p-6 mb-6 border border-gray-700">
            <h3 class="font-semibold text-green-400 mb-4">Top 5 ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h3>
            <div id="topIssuedList" class="space-y-2"></div>
        </div>

        <!-- Top 5 ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î -->
        <div class="bg-gray-800 rounded-xl p-6 mb-6 border border-gray-700">
            <h3 class="font-semibold text-blue-400 mb-4">Top 5 ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h3>
            <div id="topStockValueList" class="space-y-2"></div>
        </div>

        <!-- Chart ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£) -->
        <div class="bg-gray-800 rounded-xl p-6 mb-6 border border-gray-700">
            <h3 class="font-semibold text-pink-400 mb-4">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
            <div class="chart-container" style="height:300px;">
            <canvas id="purchaseChart"></canvas>
            </div>
        </div>
        </section>

        <!-- ADD/EDIT/DELETE PRODUCT -->
        <section id="tab-add-product" class="tab-section hidden">
          <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 mb-6">
            <h2 id="addProductTitle" class="text-2xl md:text-3xl font-bold text-green-400 mb-6">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö)</h2>
            <form id="addProductForm" class="grid grid-cols-1 gap-y-4">
              <input type="hidden" id="editingProductId" value="">

              <div>
                <label class="block text-sm text-gray-300">‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î</label>
                <input list="abbrevOptions" type="text" id="addAbbrev" name="addAbbrev" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" required/>
                <datalist id="abbrevOptions"></datalist>
              </div>
              <div>
                <label class="block text-sm text-gray-300">‡∏£‡∏´‡∏±‡∏™</label>
                <input list="codeOptions" type="text" id="addCode" name="addCode" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" required/>
                <datalist id="codeOptions"></datalist>
              </div>
              <div>
                <label class="block text-sm text-gray-300">‡∏Ç‡∏ô‡∏≤‡∏î, ‡∏™‡∏µ, ‡∏à‡∏≥‡πÄ‡∏û‡∏≤‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ</label>
                <input type="text" id="addSpecs" name="addSpecs" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" required/>
              </div>
              <div>
                <label class="block text-sm text-gray-300">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                <input type="text" id="addSku" name="addSku" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" required readonly/>
              </div>
              <div>
                <label class="block text-sm text-gray-300">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                <div class="flex items-center gap-2 mt-1">
                  <input type="text" id="addProductName" name="addProductName" class="flex-grow bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" required/>
                </div>
              </div>
              <div>
                <label class="block text-sm text-gray-300">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</label>
                <input type="text" id="addUnit" name="addUnit" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" required/>
              </div>
              <div>
                <label class="block text-sm text-gray-300">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</label>
                <input type="number" id="addMinQty" name="minQty" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" value="0"/>
              </div>
              <div class="flex items-center justify-end gap-3 mt-4">
                <span id="aiProductNameStatus" class="text-sm text-gray-300 flex items-center gap-2"></span>
                <button type="submit" id="submitProductBtn" class="px-5 py-2.5 rounded-md bg-green-600 hover:bg-green-700 text-white font-medium transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                <button type="button" id="cancelEditProductBtn" class="hidden px-5 py-2.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white font-medium transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                <span id="addProductStatus" class="text-sm text-gray-300"></span>
              </div>
            </form>
          </div>

          <!-- Current Products List for Management -->
          <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <h3 class="font-semibold text-xl mb-4 text-green-400">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h3>
            <div class="mb-4">
              <input type="text" id="manageProductsSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500"/>
            </div>
            <div class="overflow-auto border border-gray-700 rounded-lg">
              <table class="w-full table">
                <thead>
                  <tr class="text-left text-sm text-gray-300">
                    <th class="px-4 py-3">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th class="px-4 py-3">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th class="px-4 py-3">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                    <th class="px-4 py-3 text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</th>
                    <th class="px-4 py-3 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                  </tr>
                </thead>
                <tbody id="manageProductsTableBody" class="text-sm">
                  <tr><td class="px-4 py-3 text-gray-400" colspan="5">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- ADD/EDIT/DELETE VENDOR -->
        <section id="tab-add-vendor" class="tab-section hidden">
          <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 mb-6">
            <h2 id="addVendorTitle" class="text-2xl md:text-3xl font-bold text-yellow-400 mb-6">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢ (‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö)</h2>
            <form id="addVendorForm" class="grid grid-cols-1 gap-y-4">
              <input type="hidden" id="editingVendorId" value="">

              <div>
                <label class="block text-sm text-gray-300">‡∏£‡∏´‡∏±‡∏™ Vendors</label>
                <input type="text" id="addVendorCode" name="vendorCode" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" required readonly/>
              </div>
              <div>
                <label class="block text-sm text-gray-300">Vender (‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢)</label>
                <input type="text" id="addVendorName" name="vendorName" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" required/>
              </div>
              <div>
                <label class="block text-sm text-gray-300">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
                <textarea id="addVendorAddress" name="vendorAddress" rows="2" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500"></textarea>
              </div>
              <div>
                <label class="block text-sm text-gray-300">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
                <input type="tel" id="addVendorPhone" name="vendorPhone" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500"/>
              </div>
              <div>
                <label class="block text-sm text-gray-300">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏à‡∏î‡∏ó‡∏ö.</label>
                <input list="regTypeOptions" type="text" id="addVendorRegType" name="vendorRegType" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500"/>
                <datalist id="regTypeOptions"></datalist>
              </div>
              <div class="flex items-center justify-end gap-3 mt-4">
                <span id="addVendorStatus" class="text-sm text-gray-300"></span>
                <button type="submit" id="submitVendorBtn" class="px-5 py-2.5 rounded-md bg-yellow-600 hover:bg-yellow-700 text-white font-medium transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</button>
                <button type="button" id="cancelEditVendorBtn" class="hidden px-5 py-2.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white font-medium transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              </div>
            </form>
          </div>

          <!-- Current Vendors List for Management -->
          <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <h3 class="font-semibold text-xl mb-4 text-yellow-400">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h3>
            <div class="mb-4">
              <input type="text" id="manageVendorsSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢ / ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢)" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500"/>
            </div>
            <div class="overflow-auto border border-gray-700 rounded-lg">
              <table class="w-full table">
                <thead>
                  <tr class="text-left text-sm text-gray-300">
                    <th class="px-4 py-3">‡∏£‡∏´‡∏±‡∏™ Vendors</th>
                    <th class="px-4 py-3">Vender</th>
                    <th class="px-4 py-3">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</th>
                    <th class="px-4 py-3">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                    <th class="px-4 py-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏à‡∏î‡∏ó‡∏ö.</th>
                    <th class="px-4 py-3 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                  </tr>
                </thead>
                <tbody id="manageVendorsTableBody" class="text-sm">
                  <tr><td class="px-4 py-3 text-gray-400" colspan="6">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- ADD/EDIT/DELETE PROJECT -->
        <section id="tab-add-project" class="tab-section hidden">
          <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 mb-6">
            <h2 id="addProjectTitle" class="text-2xl md:text-3xl font-bold text-purple-400 mb-6">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö)</h2>
            <form id="addProjectForm" class="grid grid-cols-1 gap-y-4">
              <input type="hidden" id="editingProjectId" value="">

              <div>
                <label class="block text-sm text-gray-300">Customer</label>
                <input list="projectCustomerOptions" type="text" id="addProjectCustomer" name="projectCustomer" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" required/>
                <datalist id="projectCustomerOptions"></datalist>
              </div>
              <div>
                <label class="block text-sm text-gray-300">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</label>
                <input type="text" id="addProjectName" name="projectName" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" required/>
              </div>
              <div>
                <label class="block text-sm text-gray-300">‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠</label>
                <input type="text" id="addProjectShortName" name="projectShortName" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"/>
              </div>
              <div>
                <label class="block text-sm text-gray-300">‡∏£‡∏´‡∏±‡∏™ (‡πÄ‡∏•‡∏Ç)</label>
                <input type="text" id="addProjectCodeNum" name="projectCodeNum" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"/>
              </div>
              <div>
                <label class="block text-sm text-gray-300">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                <input list="projectTypeOptions" type="text" id="addProjectType" name="projectType" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"/>
                <datalist id="projectTypeOptions"></datalist>
              </div>
              <div>
                <label class="block text-sm text-gray-300">CODE (Text)</label>
                <input list="projectCodeTextOptions" type="text" id="addProjectCodeText" name="projectCodeText" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"/>
                <datalist id="projectCodeTextOptions"></datalist>
              </div>
              <div>
                <label class="block text-sm text-gray-300">‡πÄ‡∏ü‡∏™</label>
                <input list="projectPhaseOptions" type="text" id="addProjectPhase" name="projectPhase" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"/>
                <datalist id="projectPhaseOptions"></datalist>
              </div>
              <div>
                <label class="block text-sm text-gray-300">‡∏ã‡∏≠‡∏¢</label>
                <input list="projectAlleyOptions" type="text" id="addProjectAlley" name="projectAlley" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"/>
                <datalist id="projectAlleyOptions"></datalist>
              </div>
              <div>
                <label class="block text-sm text-gray-300">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</label>
                <input type="text" id="addProjectHouseNo" name="projectHouseNo" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"/>
              </div>
              <div>
                <label class="block text-sm text-gray-300">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                <div class="flex items-center gap-2 mt-1">
                  <textarea id="addProjectDetail" name="projectDetail" rows="2" class="flex-grow bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                </div>
              </div>
              <div>
                <label class="block text-sm text-gray-300">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∏‡∏î</label>
                <input type="text" id="addProjectCombinedCode" name="projectCombinedCode" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" readonly/>
              </div>
              <div class="flex items-center justify-end gap-3 mt-4">
                <span id="aiProjectDetailStatus" class="text-sm text-gray-300 flex items-center gap-2"></span>
                <button type="submit" id="submitProjectBtn" class="px-5 py-2.5 rounded-md bg-purple-600 hover:bg-purple-700 text-white font-medium transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</button>
                <button type="button" id="cancelEditProjectBtn" class="hidden px-5 py-2.5 rounded-md bg-gray-600 hover:bg-gray-700 text-white font-medium transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                <span id="addProjectStatus" class="text-sm text-gray-300"></span>
              </div>
            </form>
          </div>
          <!-- Current Projects List for Management -->
          <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <h3 class="font-semibold text-xl mb-4 text-purple-400">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h3>
            <div class="mb-4">
              <input type="text" id="manageProjectsSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ / ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£)" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"/>
            </div>
            <div class="overflow-auto border border-gray-700 rounded-lg">
              <table class="w-full table">
                <thead>
                  <tr class="text-left text-sm text-gray-300">
                    <th class="px-4 py-3">‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∏‡∏î‡πÄ‡∏ö‡∏¥‡∏Å</th>
                    <th class="px-4 py-3">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</th>
                    <th class="px-4 py-3">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                    <th class="px-4 py-3">‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠</th>
                    <th class="px-4 py-3">‡∏£‡∏´‡∏±‡∏™</th>
                    <th class="px-4 py-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                    <th class="px-4 py-3">CODE</th>
                    <th class="px-4 py-3">‡πÄ‡∏ü‡∏™</th>
                    <th class="px-4 py-3">‡∏ã‡∏≠‡∏¢</th>
                    <th class="px-4 py-3">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                    <th class="px-4 py-3 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                  </tr>
                </thead>
                <tbody id="manageProjectsTableBody" class="text-sm">
                  <tr><td class="px-4 py-3 text-gray-400" colspan="4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- PURCHASE -->
        <section id="tab-purchase" class="tab-section hidden">
          <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <h3 class="font-semibold text-orange-400 mb-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
            <!-- ‡πÇ‡∏Ñ‡πâ‡∏î UI (Canva): ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡∏∑‡πâ‡∏≠ -->
            <form id="purchaseForm" class="grid grid-cols-1 gap-y-4">
              <div>
                <label class="text-sm text-gray-300">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠</label>
                <input type="date" id="purchaseDate" name="purchaseDate" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500"/>
              </div>
              <div>
                <label class="text-sm text-gray-300">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                <input id="purchaseProduct" list="purchaseProductOptions" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏£‡∏´‡∏±‡∏™/‡∏ä‡∏∑‡πà‡∏≠)">
                <datalist id="purchaseProductOptions"></datalist>
              </div>
              <div>
                <label class="text-sm text-gray-300">‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢ (Vender)</label>
                <input id="purchaseVendor" list="purchaseVendorOptions" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢ (‡∏£‡∏´‡∏±‡∏™/‡∏ä‡∏∑‡πà‡∏≠)">
                <datalist id="purchaseVendorOptions"></datalist>    
              </div>
              <div>
                <label class="text-sm text-gray-300">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠</label>
                <input id="purchaseQty" type="number" min="0" step="0.01" placeholder="0" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500"/>
              </div>
              <div>
                <label class="text-sm text-gray-300">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
                <input id="purchasePrice" type="number" min="0" step="0.01" placeholder="0.00" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500"/>
              </div>
            <div>
              <label class="text-sm text-gray-300">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (‡∏ö‡∏≤‡∏ó)</label>
              <input id="purchaseDiscount" type="number" min="0" step="0.01" placeholder="0.00" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500"/>
            </div>
              <div>
                <label for="purchaseOtherCost" class="block text-sm text-gray-300">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ</label>
                <input type="number" step="0.01" min="0" id="purchaseOtherCost" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0.00"/>
              </div>
              <div id="purchaseTotalPreview" class="text-lg font-bold text-orange-400 mt-2"></div>
              <div>
                <label class="text-sm text-gray-300">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                <input id="purchaseNote" type="text" placeholder="‡πÉ‡∏™‡πà‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500"/>
              </div>
              <div class="flex items-center gap-3 mt-4">
                <button type="submit" class="px-5 py-2.5 rounded-md bg-orange-600 hover:bg-orange-700 text-white font-medium transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠ (‡∏™‡∏£‡πâ‡∏≤‡∏á Lot)</button>
                <span id="purchaseStatus" class="text-sm text-gray-300"></span>
              </div>
            </form>
          </div>
        </section>

        <!-- ISSUE -->
        <section id="tab-issue" class="tab-section hidden">
          <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <h3 class="font-semibold text-pink-400 mb-4">‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (FIFO)</h3>
            <!-- ‡πÇ‡∏Ñ‡πâ‡∏î UI (Canva): ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
            <form id="issueForm" class="grid grid-cols-1 gap-y-4">
              <div>
                <label class="text-sm text-gray-300">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å</label>
                <input type="date" id="issueDate" name="issueDate" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pink-500"/>
              </div>
            <div>
                <label class="text-sm text-gray-300">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                <input id="issueProduct" list="issueProductOptions" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏£‡∏´‡∏±‡∏™/‡∏ä‡∏∑‡πà‡∏≠)">
                <datalist id="issueProductOptions"></datalist>
            </div>
            <div>
                <label class="text-sm text-gray-300">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</label>
                <input id="issueProject" list="issueProjectOptions" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (‡∏£‡∏´‡∏±‡∏™/‡∏ä‡∏∑‡πà‡∏≠)">
                <datalist id="issueProjectOptions"></datalist>
            </div>
              <div>
                <label class="text-sm text-gray-300">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</label>
                <input id="issueQty" type="number" min="0" step="0.01" placeholder="0" class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pink-500"/>
              </div>
              <div class="flex items-end">
                <button type="button" id="simulateFIFO" class="w-full px-5 py-2.5 rounded-md bg-pink-600 hover:bg-pink-700 text-white font-medium transition">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Lot</button>
              </div>
              <div>
                <label class="block text-sm text-gray-300">Lot ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡∏î</label>
                <div id="fifoResult" class="text-sm text-gray-200 bg-gray-700 border border-gray-600 rounded-md p-3 min-h-[56px]">
                  ‚Äî ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‚Äî
                </div>
                <div>
                  <label class="text-sm text-gray-300" for="issueRemark">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                  <input id="issueRemark" name="issueRemark" type="text"
                         class="w-full mt-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pink-500"
                         placeholder="‡πÉ‡∏™‡πà‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"/>
                </div>
              </div>
              <div class="flex items-center gap-3 mt-4">
                <button type="submit" class="px-5 py-2.5 rounded-md bg-pink-600 hover:bg-pink-700 text-white font-medium transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</button>
                <span id="issueStatus" class="text-sm text-gray-300"></span>
              </div>
            </form>
          </div>
        </section>

        <!-- REPORT (‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å) -->
        <section id="tab-report" class="tab-section hidden">
          <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <div class="flex items-center justify-between mb-3">
              <h3 class="font-semibold text-blue-400">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å (StockReport)</h3>
            <button id="exportSelectedStockBtn" class="px-5 py-2 rounded bg-green-600 hover:bg-green-700 text-white font-medium transition hidden">
        ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel
      </button>
            </div>
            <div class="mb-4">
              <input type="text" id="reportSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"/> 
            </div>
            <div class="overflow-auto border border-gray-700 rounded-lg">
              <table class="w-full table">
                <thead>
                  <tr class="text-left text-sm text-gray-300">
                    <th class="px-4 py-3 text-center"><input type="checkbox" id="selectAllStock"></th>
                    <th class="px-4 py-3">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th class="px-4 py-3">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th class="px-4 py-3">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th>
                    <th class="px-4 py-3">‡πÄ‡∏ö‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th>
                    <th class="px-4 py-3 text-right">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                    <th class="px-4 py-3 text-right">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</th>
                    <th class="px-4 py-3 text-right">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ä‡∏¥‡πâ‡∏ô</th>
                    <th class="px-4 py-3 text-right">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°</th>
                    <th class="px-4 py-3 text-center">‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß</th>
                    <th class="px-4 py-3 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                  </tr>
                </thead>
                <tbody id="reportBody" class="text-sm">
                  <tr><td class="px-4 py-3 text-gray-400" colspan="8">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
                </tbody>
              </table>
              <div class="flex justify-end mt-4">
                <button id="exportSelectedStockBtn" class="px-5 py-2 rounded bg-green-600 hover:bg-green-700 text-white font-medium transition hidden">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel
              </button>
            </div>
            </div>

            <div class="mt-4 text-xs text-gray-400">Fast = ‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏ö‡πà‡∏≠‡∏¢ ‚Ä¢ Deadstock = ‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏ô‡∏≤‡∏ô</div>
          </div>
        </section>

        <!-- VENDORS LIST (‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢) -->
        <section id="tab-vendors-list" class="tab-section hidden">
          <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <div class="flex items-center justify-between mb-3">
              <h3 class="font-semibold text-green-400">üöö ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢ (Vendors)</h3>
              <button id="exportSelectedVendorsBtn" class="px-5 py-2 rounded bg-green-600 hover:bg-green-700 text-white font-medium transition hidden">
                    ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel
              </button>
            </div>
            <div class="mb-4">
                <input type="text" id="vendorSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢ / ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢)" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500"/>
            </div>
            <div class="overflow-auto border border-gray-700 rounded-lg">
              <table class="w-full table">
                <thead>
                  <tr class="text-left text-sm text-gray-300">
                    <th class="px-4 py-3 text-center"><input type="checkbox" id="selectAllVendors"></th>
                    <th class="px-4 py-3">‡∏£‡∏´‡∏±‡∏™ Vendors</th>
                    <th class="px-4 py-3">Vender</th>
                    <th class="px-4 py-3">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</th>
                    <th class="px-4 py-3">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                    <th class="px-4 py-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏à‡∏î‡∏ó‡∏ö.</th>
                    <th class="px-4 py-3 text-center">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥/‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å</th>
                  </tr>
                </thead>
                <tbody id="vendorBody" class="text-sm">
                  <tr><td class="px-4 py-3 text-gray-400" colspan="5">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <div>
          <section id="tab-project-expenditure-report" class="tab-section hidden">
            <div>
              <label class="block text-sm text-gray-300">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£)</label>
                <input type="text" id="projectMultiSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£..." class="w-full mb-2 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500"/>
                <div class="flex items-center mb-2">
                  <input type="checkbox" id="selectAllProjects" class="mr-2">
                  <label for="selectAllProjects" class="text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                </div>
                <div id="projectMultiSelect" class="max-h-40 overflow-y-auto bg-gray-700 border border-gray-600 rounded-md px-3 py-2 space-y-1"></div>
              </div>
              <div>
                <label class="block text-sm text-gray-300 mt-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)</label>
                <input type="text" id="productMultiSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." class="w-full mb-2 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500"/>
                <div class="flex items-center mb-2">
                  <input type="checkbox" id="selectAllProducts" class="mr-2">
                  <label for="selectAllProducts" class="text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                </div>
                <div id="productMultiSelect" class="max-h-40 overflow-y-auto bg-gray-700 border border-gray-600 rounded-md px-3 py-2 space-y-1"></div>
              </div>
              <div class="flex items-end mt-4">
                <button id="viewProjectExpenditureBtn" class="w-full px-5 py-2.5 rounded-md bg-cyan-600 hover:bg-cyan-700 text-white font-medium transition">‡∏î‡∏π‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</button>
                <button id="exportProjectExpenditureBtn" class="ml-2 px-4 py-2 rounded bg-green-600 hover:bg-green-700 text-white font-medium transition text-sm">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</button>
              </div>
              <div id="projectExpenditureResult" class="text-sm text-gray-200 bg-gray-700 border border-gray-600 rounded-md p-3 min-h-[60px] mt-2">
                ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏Å‡∏î "‡∏î‡∏π‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...
              </div>
                </div>
              </section>
                <!-- Section: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï -->
        <section id="tab-budget-estimate" class="tab-section hidden">
          <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-semibold text-cyan-400 text-xl mb-0">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï</h3>
              <button id="exportSelectedBudgetEstimateBtn" class="px-5 py-2 rounded bg-green-600 hover:bg-green-700 text-white font-medium transition hidden">
                ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel
              </button>
            </div>
            <div class="mb-4 grid grid-cols-1 md:grid-cols-2 gap-4">
              <input type="text" id="budgetEstimateProductSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏£‡∏´‡∏±‡∏™/‡∏ä‡∏∑‡πà‡∏≠)" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500"/>
              <input type="text" id="budgetEstimateVendorSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢ (‡∏£‡∏´‡∏±‡∏™/‡∏ä‡∏∑‡πà‡∏≠)" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500"/>
            </div>
            <div id="budgetEstimateSummary" class="mb-4 text-sm text-gray-300"></div>
            <div class="overflow-auto border border-gray-700 rounded-lg">
              <table class="w-full table">
                <thead>
                  <tr class="text-left text-sm text-gray-300">
                    <th class="px-4 py-3 text-center"><input type="checkbox" id="selectAllBudgetEstimate"></th>
                    <th class="px-4 py-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠</th>
                    <th class="px-4 py-3">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th class="px-4 py-3">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                    <th class="px-4 py-3">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ã‡∏∑‡πâ‡∏≠</th>
                    <th class="px-4 py-3">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                    <th class="px-4 py-3">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                    <th class="px-4 py-3">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°</th>
                    <th class="px-4 py-3">‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</th>
                  </tr>
                </thead>
                <tbody id="budgetEstimateTableBody" class="text-sm">
                  <tr><td class="px-4 py-3 text-gray-400" colspan="5">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td></tr>
                </tbody>
              </table>
              <div class="flex justify-end mt-4">
                <button id="exportSelectedBudgetEstimateBtn" class="px-5 py-2 rounded bg-green-600 hover:bg-green-700 text-white font-medium transition hidden">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</button>
              </div>
            </div>
          </div>
        </section>
        <!-- SETTINGS -->
        <section id="tab-settings" class="tab-section hidden">
          <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
            <h3 class="font-semibold text-xl mb-4 text-gray-400">‚öôÔ∏è ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h3>
            <p class="text-gray-400">‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï</p>
          </div>
        </section>
    </div> <!-- End content-padded-wrapper -->
  </div>

  <!-- Custom Confirmation Modal -->
  <div id="customConfirmModal" class="modal-overlay hidden">
    <div class="modal-content">
      <p id="confirmMessage" class="text-lg text-gray-200 mb-6">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
      <div class="flex justify-center gap-4">
        <button id="confirmYes" class="px-6 py-2 rounded-md bg-red-600 hover:bg-red-700 text-white font-medium transition">‡πÉ‡∏ä‡πà</button>
        <button id="confirmNo" class="px-6 py-2 rounded-md bg-gray-600 hover:bg-gray-700 text-white font-medium transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>
  </div>

  <!-- New: Lot Detail Modal -->
  <div id="lotDetailModal" class="modal-overlay hidden">
    <div class="modal-content">
      <h3 id="lotDetailModalTitle" class="text-xl font-bold text-blue-400 mb-4"></h3>
      <div id="lotDetailContent" class="space-y-3 text-gray-300">
        <!-- Lot details will be rendered here -->
      </div>
      <button id="closeLotDetailModal" class="mt-6 px-6 py-2 rounded-md bg-gray-600 hover:bg-gray-700 text-white font-medium transition">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>

  <div id="outOfStockModal" class="modal-overlay hidden">
    <div class="modal-content relative">
    <button id="closeOutOfStockModal" class="absolute top-10 right-10 text-gray-400 hover:text-white text-xl font-bold focus:outline-none" title="‡∏õ‡∏¥‡∏î">
      &times;
    </button>
      <h3 class="text-xl font-bold text-red-400 mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å</h3>
      <div id="outOfStockList" class="space-y-2 text-gray-300"></div>
      <button id="closeOutOfStockModal" class="mt-6 px-6 py-2 rounded-md bg-gray-600 hover:bg-gray-700 text-white font-medium transition">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>
  <div id="vendorPurchaseModal" class="modal-overlay hidden">
    <div class="modal-content max-w-2xl w-full text-left">
        <button id="closeVendorPurchaseModal" class="absolute top-6 right-8 text-gray-400 hover:text-white text-2xl font-bold focus:outline-none" title="‡∏õ‡∏¥‡∏î">&times;</button>
        <h3 id="vendorPurchaseModalTitle" class="text-xl font-bold text-blue-400 mb-4"></h3>
        <div id="vendorPurchaseList" class="space-y-2 text-gray-300 max-h-[60vh] overflow-y-auto"></div>
        <button id="closeVendorPurchaseModal2" class="mt-6 px-6 py-2 rounded-md bg-gray-600 hover:bg-gray-700 text-white font-medium transition">‡∏õ‡∏¥‡∏î</button>
    </div>
</div>
  <script>
    // Utilities
    const sleep = (ms)=> new Promise(r=>setTimeout(r, ms));

    // Custom Confirmation Dialog (NOT alert/confirm)
    function showCustomConfirm(message) {
        return new Promise((resolve) => {
            const modal = document.getElementById('customConfirmModal');
            const confirmMessage = document.getElementById('confirmMessage');
            const confirmYes = document.getElementById('confirmYes');
            const confirmNo = document.getElementById('confirmNo');

            confirmMessage.innerHTML = message; // Use innerHTML for potential HTML in message
            modal.classList.remove('hidden');

            const handleYes = () => {
                modal.classList.add('hidden');
                confirmYes.removeEventListener('click', handleYes);
                confirmNo.removeEventListener('click', handleNo);
                resolve(true);
            };

            const handleNo = () => {
                modal.classList.add('hidden');
                confirmYes.removeEventListener('click', handleYes);
                confirmNo.removeEventListener('click', handleNo);
                resolve(false);
            };

            confirmYes.addEventListener('click', handleYes);
            confirmNo.addEventListener('click', handleNo);
        });
    }

    // Gemini API call function (with exponential backoff)
    async function callGeminiAPI(prompt, statusEl) {
        // AI generation is disabled for these buttons
        return Promise.reject(new Error('‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô AI ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ'));
    }


    document.addEventListener('DOMContentLoaded', () => {
      // =========================
      // Responsive Design JavaScript Logic - FOR HAMBURGER MENU
      // =========================
      const sidebarToggle = document.getElementById('sidebarToggle');
      const sidebarClose = document.getElementById('sidebarClose');
      const sidebar = document.getElementById('sidebar');
      const sidebarOverlay = document.getElementById('sidebarOverlay');
      const mainContentWrapper = document.getElementById('mainContentWrapper');

      function openSidebar() {
          sidebar.classList.add('sidebar-open');
          sidebarOverlay.classList.add('overlay-active');
          document.body.style.overflow = 'hidden'; // Prevent scrolling on body when sidebar is open
      }

      function closeSidebar() {
          sidebar.classList.remove('sidebar-open');
          sidebarOverlay.classList.remove('overlay-active');
          document.body.style.overflow = ''; // Restore scrolling on body
      }

      // Only attach event listeners if elements exist
      if (sidebarToggle) {
          sidebarToggle.addEventListener('click', openSidebar);
      }
      if (sidebarClose) {
          sidebarClose.addEventListener('click', closeSidebar);
      }
      if (sidebarOverlay) {
          sidebarOverlay.addEventListener('click', closeSidebar);
      }

      // Close sidebar when clicking menu items on mobile
      const menuItems = document.querySelectorAll('.menu-item');
      menuItems.forEach(item => {
          item.addEventListener('click', function() {
              if (window.innerWidth < 768) { // Only on mobile
                  closeSidebar();
              }
          });
      });

      // Adjust layout on resize
      window.addEventListener('resize', () => {
          if (window.innerWidth >= 768) { // If it's desktop size or larger
              sidebar.classList.remove('sidebar-open'); // Ensure sidebar is always visible
              sidebarOverlay.classList.remove('overlay-active'); // Hide overlay
              document.body.style.overflow = ''; // Restore body scrolling
          }
          const qtyEl = document.getElementById('purchaseQty');
        const priceEl = document.getElementById('purchasePrice');
        const otherCostEl = document.getElementById('purchaseOtherCost');
        const discountEl = document.getElementById('purchaseDiscount');
        const totalPreviewEl = document.getElementById('purchaseTotalPreview');
        
        function updateTotalPreview() {
            const qty = parseFloat(qtyEl?.value || '0');
            const price = parseFloat(priceEl?.value || '0');
            const otherCost = parseFloat(otherCostEl?.value || '0');
            const discount = parseFloat(discountEl?.value || '0');
            let total = qty * price + otherCost - discount;
            if (total < 0) total = 0;
            if (totalPreviewEl) {
                totalPreviewEl.textContent = `‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${total.toLocaleString('th-TH', {minimumFractionDigits:2})} ‡∏ö‡∏≤‡∏ó`;
      }
}    
    [qtyEl, priceEl, otherCostEl,discountEl].forEach(el => {
        if (el) el.addEventListener('input', updateTotalPreview);
    });
    updateTotalPreview()
    });
    const tabs = [
      'dashboard','add-product','add-vendor','add-project','purchase','issue',
      'report', 'vendors-list', 'project-expenditure-report', 'budget-estimate', 'settings'
    ];

    const tabButtons = document.querySelectorAll('.menu-item');
      
    const sections = {};
      tabs.forEach(t => {
        const el = document.getElementById('tab-' + t);
          if (el) {
              sections[t] = el;
          }
      
      });
      
      const reportsDropdown = document.getElementById('reportsDropdown');
      const toggleReportsDropdownBtn = document.getElementById('toggleReportsDropdown');
      const reportsDropdownArrow = document.getElementById('reportsDropdownArrow');

      function setActiveTab(name){
        // Hide all sections, then show the active one
        Object.values(sections).forEach(section => section.classList.add('hidden'));
        if (sections[name]) {
            sections[name].classList.remove('hidden');
        }
        
        // Remove active styling from all tab buttons
        tabButtons.forEach(b=>b.classList.remove('tab-active'));
        if (toggleReportsDropdownBtn) { 
          toggleReportsDropdownBtn.classList.remove('tab-active');
        }

        // Add active styling to the clicked tab button
        const clickedTabButton = document.querySelector(`.menu-item[data-tab="${name}"]`);
        if (clickedTabButton) {
          clickedTabButton.classList.add('tab-active');
        } else if (['report', 'vendors-list', 'project-expenditure-report'].includes(name)) {
          // If a report sub-item is clicked, activate the main Reports dropdown button
          if (toggleReportsDropdownBtn) {
            toggleReportsDropdownBtn.classList.add('tab-active');
          }
          const subItem = reportsDropdown.querySelector(`[data-tab="${name}"]`);
          if (subItem) subItem.classList.add('tab-active'); // Also highlight the sub-item
        }


        // Handle reports dropdown visibility and styling
        if (['report', 'vendors-list', 'project-expenditure-report'].includes(name)) {
          if (reportsDropdown) { 
            reportsDropdown.classList.remove('hidden');
          }
          if (reportsDropdownArrow) { 
            reportsDropdownArrow.classList.add('rotate-180'); 
          }
        } else {
          if (reportsDropdown) { 
            reportsDropdown.classList.add('hidden');
          }
          if (reportsDropdownArrow) { 
            reportsDropdownArrow.classList.remove('rotate-180'); 
          }
        }

        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
      
      // Attach click listeners to all menu items for tab switching
      tabButtons.forEach(btn=>{
        if(btn.id !== 'toggleReportsDropdown') {
          btn.addEventListener('click', ()=>setActiveTab(btn.dataset.tab));
        }
      });
      
      // Specific click listener for the main Reports dropdown toggle
      if (toggleReportsDropdownBtn) { 
        toggleReportsDropdownBtn.addEventListener('click', () => {
          if (reportsDropdown) {
            reportsDropdown.classList.toggle('hidden');
          }
          if (reportsDropdownArrow) { 
            reportsDropdownArrow.classList.toggle('rotate-180'); 
          }
        });
      }
      
      // Default active tab
      setActiveTab('dashboard');  

      // =========================
      // Google Apps Script Integration
      // =========================
      // ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏≤ URL ‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå Google Apps Script ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà:
      // Deploy -> New deployment -> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó "Web app" -> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å URL
      const READ_API = 'https://script.google.com/macros/s/AKfycbwUIOOrpz5OuBTozDFROkA4_Lxfm8P4N2DuY_DeOplhjiLjiXuCYmGGsVPXDJ0aqh4R/exec'; 
      const WRITE_API = 'https://script.google.com/macros/s/AKfycbwUIOOrpz5OuBTozDFROkA4_Lxfm8P4N2DuY_DeOplhjiLjiXuCYmGGsVPXDJ0aqh4R/exec';

      let cache = { 
        products: [], vendors: [], projects: [], stockReport: [], lots: [], 
        // Modified: `recentActivities` now expected to contain a `value` property for each activity
        recentActivities: [], 
        topIssued: [], topStockValue: [], monthlyActivity: { labels: [], purchase: [], issue: [] }, 
        projectExpenditureData: [],
        lastUpdated: null, nextVendorCode: '001', nextProjectNo: 1, nextPurchaseNo: 1 
      };
    function populateProductDatalist() {
        const datalist = document.getElementById('purchaseProductOptions');
        if (!datalist) return;
        datalist.innerHTML = '';
        cache.products.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'];
            opt.label = `${p['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']} ‚Äî ${p['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']}`;
            datalist.appendChild(opt);
        });
        }
    
    function populateVendorDatalist() {
        const datalist = document.getElementById('purchaseVendorOptions');
        if (!datalist) return;
        datalist.innerHTML = '';
        cache.vendors.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v['‡∏£‡∏´‡∏±‡∏™ Vendors'];
            opt.label = `${v['‡∏£‡∏´‡∏±‡∏™ Vendors']} ‚Äî ${v['Vender']}`;
            datalist.appendChild(opt);
        });
        }

    function populateIssueProductDatalist() {
      const datalist = document.getElementById('issueProductOptions');
      if (!datalist) return;
      datalist.innerHTML = '';
      cache.products.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'];
        opt.label = `${p['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']} ‚Äî ${p['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']}`;
        datalist.appendChild(opt);
      });
    }
    
    function populateIssueProjectDatalist() {
      const datalist = document.getElementById('issueProjectOptions');
      if (!datalist) return;
      datalist.innerHTML = '';
      cache.projects.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p['‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∏‡∏î'];
        opt.label = `${p['‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∏‡∏î']} ‚Äî ${p['‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£']}${p['‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠'] ? ' ('+p['‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠']+')' : ''}`;
        datalist.appendChild(opt);
      });
    }

      // Chart instances - REMOVED
      // let dailyMovementLineChart = null;
      // let dailyMovementDoughnutChart = null;

      // --- Refresh Button UI elements ---
      const refreshBtn = document.getElementById('refreshBtn');
      const refreshIcon = document.getElementById('refreshIcon');
      const btnLabel = document.getElementById('btnLabel');
      const progressBar = document.getElementById('progressBar');
      const statusText = document.getElementById('statusText');
      const dashboardActivityList = document.getElementById('activityList'); // Original recent activities list

      let isRefreshing = false;

      // Function to create ripple effect
      function createRipple(e) {
        const button = e.currentTarget;
        const rect = button.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const x = e.clientX - rect.left - size / 2;
        const y = e.clientY - rect.top - size / 2;

        const ripple = document.createElement('div');
        ripple.classList.add('ripple');
        ripple.style.width = ripple.style.height = size + 'px';
        ripple.style.left = x + 'px';
        ripple.style.top = y + 'px';

        button.appendChild(ripple);

        // Create pulse rings
        for (let i = 0; i < 3; i++) {
          setTimeout(() => {
            const ring = document.createElement('div');
            ring.classList.add('pulse-ring');
            ring.style.width = ring.style.height = '60px';
            ring.style.left = '50%';
            ring.style.top = '50%';
            ring.style.marginLeft = '-30px';
            ring.style.marginTop = '-30px';

            button.appendChild(ring);

            setTimeout(() => ring.remove(), 1500);
          }, i * 200);
        }

        setTimeout(() => ripple.remove(), 600);
      }

      // Function to start refresh process
      async function startRefresh() {
        isRefreshing = true;
        if (refreshIcon) refreshIcon.classList.add('refresh-spin');
        if (btnLabel) btnLabel.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä...';
        if (refreshBtn) refreshBtn.classList.add('opacity-80');
        if (progressBar) {
          progressBar.classList.remove('progress-active');
          progressBar.style.width = '0%';
        }
        setTimeout(() => {
          if (progressBar) progressBar.classList.add('progress-active');
        }, 100);

        // Update status text with animation
        const statuses = [
          '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå...',
          '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
          '‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
          '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠...',
          '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!'
        ];

        let errorDuringLoad = false;
        try {
        for (let i = 0; i < statuses.length; i++) {
          if (statusText) {
            statusText.textContent = statuses[i];
            statusText.classList.add('text-blue-400');
          }
          if (statuses[i] === '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...') {
            await loadAll(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
          }
          // ‡∏•‡∏î sleep ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 0 ‡∏´‡∏£‡∏∑‡∏≠ 100ms
          await sleep(i === statuses.length - 1 ? 0 : 100);
        }
        } catch (error) {
          errorDuringLoad = true;
          console.error("Error during refresh process:", error);
          if (statusText) {
            statusText.textContent = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`;
            statusText.classList.remove('text-blue-400');
            statusText.classList.add('text-red-400');
          }
        } finally {
          completeRefresh(errorDuringLoad);
        }
      }

      // Function to complete refresh process
      function completeRefresh(hadError = false) {
        // Reset button state
        if (refreshIcon) refreshIcon.classList.remove('refresh-spin');
        if (btnLabel) btnLabel.textContent = 'Refresh';
        if (refreshBtn) refreshBtn.classList.remove('opacity-80');

        // Reset progress bar
        setTimeout(() => {
          if (progressBar) {
            progressBar.classList.remove('progress-active');
            progressBar.style.width = '0%';
          }
        }, 500);

        // Update status
        if (!hadError) {
          if (statusText) {
            statusText.textContent = '‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!';
            statusText.classList.remove('text-blue-400', 'text-red-400');
            statusText.classList.add('text-green-400');
          }
        }
        // If there was an error, statusText is already updated by startRefresh

        // Reset status after 2 seconds
        setTimeout(() => {
          if (statusText) {
            statusText.textContent = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä';
            statusText.classList.remove('text-green-400', 'text-red-400', 'text-blue-400');
          }
          isRefreshing = false;
        }, 2000);

        // Add success pulse to button
        if (refreshBtn) {
          refreshBtn.classList.add('animate-pulse');
          setTimeout(() => {
            refreshBtn.classList.remove('animate-pulse');
          }, 1000);
        }
      }

      // Attach click handler to refresh button
      if (refreshBtn) {
        refreshBtn.addEventListener('click', function(e) {
          if (isRefreshing) return;
          createRipple(e);
          startRefresh();
        });
      }

      // Prepend activity function for Dashboard
      function prependActivity(text){
        if (!dashboardActivityList) return; 
        const li = document.createElement('div');
        li.className = 'flex items-center justify-between bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-sm';
        li.textContent = text;
        dashboardActivityList.prepend(li);

        const items = dashboardActivityList.querySelectorAll('div');
        if (items.length > 6) items[items.length-1].remove();
      }

      // Placeholder setting function
      function setPlaceholders(){
        const minList = document.getElementById('minList');
        if (minList) minList.innerHTML = `<div class="text-gray-400 text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>`;
        
        const dashboardActivityList = document.getElementById('activityList');
        if (dashboardActivityList) dashboardActivityList.innerHTML = `<div class="text-gray-400 text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>`;
        
        const reportBody = document.getElementById('reportBody');
        if (reportBody) reportBody.innerHTML = `<tr><td class="px-4 py-3 text-gray-400" colspan="8">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>`;
        
        const kpiTotalQty = document.getElementById('kpiTotalQty');
        if (kpiTotalQty) kpiTotalQty.textContent = '-';
        
        const kpiStockValue = document.getElementById('kpiStockValue');
        if (kpiStockValue) kpiStockValue.textContent = '-';
        
        const kpiDead = document.getElementById('kpiDead');
        if (kpiDead) kpiDead.textContent = '-';
        
        const kpiSlow = document.getElementById('kpiSlow');
        if (kpiSlow) kpiSlow.textContent = '-'; // Set to '-' since the card is hidden
        
        const kpiUpdatedAt = document.getElementById('kpiUpdatedAt');
        if (kpiUpdatedAt) kpiUpdatedAt.textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: -';
        
        const alertsContainer = document.getElementById('alertsContainer');
        if (alertsContainer) alertsContainer.innerHTML = `<div class="text-gray-400 text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô...</div>`; 
        
        const vendorBody = document.getElementById('vendorBody');
        if (vendorBody) vendorBody.innerHTML = `<tr><td class="px-4 py-3 text-gray-400" colspan="5">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>`;
        
        const projectBody = document.getElementById('projectBody');
        if (projectBody) projectBody.innerHTML = `<tr><td class="px-4 py-3 text-gray-400" colspan="4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>`; 
        
        const projectExpenditureResult = document.getElementById('projectExpenditureResult');
        if (projectExpenditureResult) projectExpenditureResult.innerHTML = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°...`;

        const addProductStatus = document.getElementById('addProductStatus');
        if(addProductStatus) addProductStatus.textContent = '';
        const addVendorStatus = document.getElementById('addVendorStatus');
        if(addVendorStatus) addVendorStatus.textContent = '';
        const addProjectStatus = document.getElementById('addProjectStatus');
        if(addProjectStatus) addProjectStatus.textContent = '';

        // Reset daily activity summary
        const dailyActivityList = document.getElementById('dailyActivityList');
        if (dailyActivityList) dailyActivityList.innerHTML = `<div class="text-gray-400 text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô...</div>`;
      
        // Clear charts and their related text - REMOVED
      }

      // Error display function
      function showError(msg){
        // Update the main status text with a more prominent error message
        if (statusText) {
          statusText.textContent = `‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${msg}`;
          statusText.classList.remove('text-blue-400', 'text-green-400');
          statusText.classList.add('text-red-400');
        }

        const minList = document.getElementById('minList');
        if (minList) minList.innerHTML = `<div class="text-red-400 text-sm">${msg}</div>`;
        
        const dashboardActivityList = document.getElementById('activityList');
        if (dashboardActivityList) dashboardActivityList.innerHTML = `<div class="text-red-400 text-sm">${msg}</div>`;
        
        const reportBody = document.getElementById('reportBody');
        if (reportBody) reportBody.innerHTML = `<tr><td class="px-4 py-3 text-red-400" colspan="8">${msg}</td></tr>`;
        
        const kpiTotalQty = document.getElementById('kpiTotalQty');
        if (kpiTotalQty) kpiTotalQty.textContent = 'Error';
        
        const kpiStockValue = document.getElementById('kpiStockValue');
        if (kpiStockValue) kpiStockValue.textContent = 'Error';
        
        const kpiDead = document.getElementById('kpiDead');
        if (kpiDead) kpiDead.textContent = 'Error';
        
        const kpiSlow = document.getElementById('kpiSlow');
        if (kpiSlow) kpiSlow.textContent = 'Error';
        
        const kpiUpdatedAt = document.getElementById('kpiUpdatedAt');
        if (kpiUpdatedAt) kpiUpdatedAt.textContent = 'Error';
        
        const alertsContainer = document.getElementById('alertsContainer');
        if (alertsContainer) alertsContainer.innerHTML = `<div class="text-red-400 text-sm">${msg}</div>`; 
        
        const vendorBody = document.getElementById('vendorBody');
        if (vendorBody) vendorBody.innerHTML = `<tr><td class="px-4 py-3 text-red-400" colspan="5">${msg}</td></tr>`;
        
        const projectBody = document.getElementById('projectBody');
        if (projectBody) projectBody.innerHTML = `<tr><td class="px-4 py-3 text-red-400" colspan="4">${msg}</td></tr>`; 

        const projectExpenditureResult = document.getElementById('projectExpenditureResult');
        if (projectExpenditureResult) projectExpenditureResult.innerHTML = `<span class="text-red-400">${msg}</span>`;

        const addProductStatus = document.getElementById('addProductStatus');
        if(addProductStatus) addProductStatus.innerHTML = `<span class="text-red-400">${msg}</span>`;
        const addVendorStatus = document.getElementById('addVendorStatus');
        if(addVendorStatus) addVendorStatus.innerHTML = `<span class="text-red-400">${msg}</span>`;
        const addProjectStatus = document.getElementById('addProjectStatus');
        if(addProjectStatus) addProjectStatus.innerHTML = `<span class="text-red-400">${msg}</span>`;

        const dailyActivityList = document.getElementById('dailyActivityList');
        if (dailyActivityList) dailyActivityList.innerHTML = `<div class="text-red-400 text-sm">${msg}</div>`;
      }

      // Load all data function
      async function loadAll(){
        setPlaceholders(); // Call placeholders before fetching
        try{
          // NOTE: The previous check for placeholder URLs has been removed as they are now set.
          // The error "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï URL ‡∏Ç‡∏≠‡∏á Apps Script Web App..." should no longer appear.

          const res = await fetch(READ_API, { method: 'GET' });
          if(!res.ok) {
              const errorText = await res.text();
              throw new Error(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Status: ${res.status}, Message: ${errorText.substring(0, 100)}...)`);
          }
          const data = await res.json();
          cache.products = Array.isArray(data.products)?data.products:[];
          cache.vendors = Array.isArray(data.vendors)?data.vendors:[];
          cache.projects = Array.isArray(data.projects)?data.projects:[]; 
          cache.stockReport = Array.isArray(data.stockReport)?data.stockReport:[];
          cache.lots = Array.isArray(data.lots)?data.lots:[];
          
          // Assuming `recentActivities` now contains `value`
          cache.recentActivities = Array.isArray(data.recentActivities)?data.recentActivities:[];
          
          cache.topIssued = Array.isArray(data.topIssued)?data.topIssued:[];
          cache.topStockValue = Array.isArray(data.topStockValue)?data.topStockValue:[]; 
          cache.monthlyActivity = data.monthlyActivity || { labels: [], purchase: [], issue: [] };
          cache.projectExpenditureData = Array.isArray(data.projectExpenditureData)?data.projectExpenditureData:[];

          cache.lastUpdated = new Date();

          cache.nextVendorCode = data.nextVendorCode || '001';
          cache.nextProjectNo = data.nextProjectNo || 1;
          cache.nextPurchaseNo = data.nextPurchaseNo || 1; 

          // Debugging: Log the cache content
          console.log("Cache Products after loadAll:", cache.products);
          console.log("Cache Vendors after loadAll:", cache.vendors);
          console.log("Cache Projects after loadAll:", cache.projects);
          console.log("Cache Lots after loadAll:", cache.lots);
          console.log("Next Project No (Internal, for reference):", cache.nextProjectNo);
          console.log("Recent Activities (expected with value):", cache.recentActivities);

          function padVendorCode(num) {return String(num).padStart(3, '0');}cache.nextVendorCode = padVendorCode(data.nextVendorCode || '1');


          renderDropdowns();

          // New: Populate datalist for product search in Project Expenditure Report
          populateDatalist('productOptionsProjectReport', cache.products, item => item['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']);

          populateDatalist('abbrevOptions', cache.products, item => item['‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î']);
          populateDatalist('codeOptions', cache.products, item => item['‡∏£‡∏´‡∏±‡∏™']); 
          populateDatalist('regTypeOptions', cache.vendors, item => item['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏à‡∏î‡∏ó‡∏ö.']);
          populateDatalist('projectCustomerOptions', cache.projects, item => item['Customer']);
          populateDatalist('projectTypeOptions', cache.projects, item => item['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó']);
          populateDatalist('projectCodeTextOptions', cache.projects, item => item['CODE']);
          populateDatalist('projectPhaseOptions', cache.projects, item => item['‡πÄ‡∏ü‡∏™']);
          populateDatalist('projectAlleyOptions', cache.projects, item => item['‡∏ã‡∏≠‡∏¢']);

          renderDashboard();
          renderReport();
          renderVendors();
          renderVendorMultiSelect(); 
          renderProjects(); 
          renderManageProducts(document.getElementById('manageProductsSearch').value);
          renderManageVendors(document.getElementById('manageVendorsSearch').value);
          renderManageProjects(document.getElementById('manageProjectsSearch').value);

          resetAddProductForm();
          resetAddVendorForm();
          resetAddProjectForm(); // Call reset to update new project number

        }catch(e){
          showError(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å READ_API ‡πÑ‡∏î‡πâ: ${e.message || '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL doGet ‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á'}`);
          console.error("Error loading data:", e);
          throw e;
        }
      }

      function fillOptions(selectEl, items, getValue, getLabel){
        if (!selectEl) return; 
        selectEl.innerHTML = '<option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî</option>';
        items.forEach(it=>{
          const opt = document.createElement('option');
          opt.value = getValue(it);
          opt.textContent = getLabel(it);
          selectEl.appendChild(opt);
        });
      }

      function populateDatalist(datalistId, items, getKey) {
        const datalistEl = document.getElementById(datalistId);
        if (!datalistEl) return; 
        datalistEl.innerHTML = ''; 
        const uniqueItems = new Set();
        items.forEach(item => {
          const value = String(getKey(item) || '').trim();
          if (value && !uniqueItems.has(value)) {
            const option = document.createElement('option');
            option.value = value;
            datalistEl.appendChild(option);
            uniqueItems.add(value);
          }
        });
      }

      // Function to filter product dropdowns based on search query
      function filterProductSelect(selectEl, query){
        if (!selectEl) return; 
        const q = (query||'').toLowerCase().trim();
        selectEl.innerHTML = '<option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî</option>'; 
        const filtered = cache.products.filter(it => 
            (String(it['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || '').toLowerCase().includes(q)) || 
            (String(it['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || '').toLowerCase().includes(q))
        );
        filtered.forEach(o => {
          const opt = document.createElement('option');
          opt.value = o['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'];
          opt.textContent = `${o['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']} ‚Äî ${o['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']}`;
          selectEl.appendChild(opt);
        });
      }

      // Function to filter vendor dropdowns based on search query
      function filterVendorSelect(selectEl, query){
        if (!selectEl) return;
        const q = (query||'').toLowerCase().trim();
        selectEl.innerHTML = '<option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî</option>';
        const filtered = cache.vendors.filter(it =>
            (String(it['‡∏£‡∏´‡∏±‡∏™ Vendors'] || '').toLowerCase().includes(q)) ||
            (String(it['Vender'] || '').toLowerCase().includes(q))
        );
        filtered.forEach(o => {
            const opt = document.createElement('option');
            opt.value = o['‡∏£‡∏´‡∏±‡∏™ Vendors'];
            opt.textContent = `${o['‡∏£‡∏´‡∏±‡∏™ Vendors']} ‚Äî ${o['Vender']}`;
            selectEl.appendChild(opt);
        });
      }


      function formatDateToDDMMMYYYY(dateString) {
          if (!dateString) return '';
          const date = new Date(dateString);
          if (isNaN(date)) return ''; 
          const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          const day = String(date.getDate()).padStart(2, '0');
          const month = months[date.getMonth()];
          const year = date.getFullYear();
          return `${day}-${month}-${year}`;
      }

      function renderDropdowns(){
        fillOptions(
          document.getElementById('purchaseVendor'),
          cache.vendors,
          it=>String(it['‡∏£‡∏´‡∏±‡∏™ Vendors'] || it['‡∏£‡∏´‡∏±‡∏™Vendors'] || '').trim(),
          it=>`${String(it['‡∏£‡∏´‡∏±‡∏™ Vendors']||it['‡∏£‡∏´‡∏±‡∏™Vendors'] || '').trim()} ‚Äî ${String(it['Vender'] || '').trim()}`
        );
        
        fillOptions(
          document.getElementById('issueProject'),
          cache.projects,
          it=>String(it['‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∏‡∏î'] || '').trim(),
          it=>`${String(it['‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∏‡∏î'] || '').trim()} ‚Äî ${String(it['‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£'] || '').trim()}${it['‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠']?' ('+String(it['‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠'] || '').trim()+')':''}`
        );
        
        fillOptions(
          document.getElementById('dashboardProjectExpenditureSelect'),
          cache.projects,
          it=>String(it['‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∏‡∏î'] || '').trim(),
          it=>`${String(it['‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∏‡∏î'] || '').trim()} ‚Äî ${String(it['‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£'] || '').trim()}${it['‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠']?' ('+String(it['‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠'] || '').trim()+')':''}`
        );

        const purchaseSearchInput = document.getElementById('purchaseSearch');
        const purchaseProductSelect = document.getElementById('purchaseProduct');
        if (purchaseSearchInput && purchaseProductSelect) {
            purchaseSearchInput.addEventListener('input', (e) => filterProductSelect(purchaseProductSelect, e.target.value));
        }
        const issueSearchInput = document.getElementById('issueSearch');
        const issueProductSelect = document.getElementById('issueProduct');
        if (issueSearchInput && issueProductSelect) {
            issueSearchInput.addEventListener('input', (e) => filterProductSelect(issueProductSelect, e.target.value));
        }
      }

    function renderDashboard() {
      // 1. KPI Cards
      const totalQty = cache.stockReport.reduce((s, r) => s + (+r['‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠'] || 0), 0);
      const totalStockValue = cache.stockReport.reduce((s, r) => s + (+r['‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô'] || 0), 0);
      const productCount = cache.stockReport.length;
      const deadValue = cache.stockReport
        .filter(r => (String(r['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || '').toLowerCase() === 'deadstock'))
        .reduce((s, r) => s + (+r['‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô'] || 0), 0);
      const deadPercent = totalStockValue > 0 ? (deadValue / totalStockValue) * 100 : 0;
    
      document.getElementById('kpiTotalQty').textContent = totalQty.toLocaleString('th-TH');
      document.getElementById('kpiStockValue').textContent = totalStockValue.toLocaleString('th-TH', { minimumFractionDigits: 2 });
      document.getElementById('kpiProductCount').textContent = productCount.toLocaleString('th-TH');
      document.getElementById('kpiDeadValue').textContent = deadValue.toLocaleString('th-TH', { minimumFractionDigits: 2 });
      document.getElementById('kpiDeadPercent').textContent = `${deadPercent.toFixed(1)}% ‡∏Ç‡∏≠‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î`;
      document.getElementById('kpiUpdatedAt').textContent = `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${cache.lastUpdated ? formatDateToDDMMMYYYY(cache.lastUpdated.toISOString()) : '-'}`;
          // ...‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderDashboard()...
    
    // 5. ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (Alerts)
    const alerts = [];
    // 1. ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å
    const outOfStock = cache.stockReport.filter(r => (+r['‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠']||0) === 0);
    if (outOfStock.length) {
        const moreId = `outOfStockMore-${Date.now()}`;
        alerts.push(`<div class="text-red-400 font-semibold mb-1">‚ùå ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å (${outOfStock.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</div>`);
        alerts.push(...outOfStock.slice(0, 5).map(r =>
        `<div class="ml-4 text-sm">‚Ä¢ ${r['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']} - ${r['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']}</div>`
        ));
        if (outOfStock.length > 5) {
        alerts.push(`
            <a href="#" class="ml-4 text-xs text-blue-400 underline cursor-pointer alert-toggle" data-target="${moreId}">...‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${outOfStock.length-5} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</a>
            <div id="${moreId}" class="ml-4 mt-1 hidden">
            ${outOfStock.slice(5).map(r => `<div class="text-sm">‚Ä¢ ${r['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']} - ${r['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']}</div>`).join('')}
            <a href="#" class="text-xs text-blue-400 underline cursor-pointer alert-toggle" data-target="${moreId}">‡∏ã‡πà‡∏≠‡∏ô</a>
            </div>
        `);
        }
    }
    // 2. ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ <= ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ ‡πÅ‡∏•‡∏∞ ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ > 0)
    const lowStock = cache.stockReport.filter(r => {
        const remain = +r['‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠']||0;
        const min = +r['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥']||0;
        return remain > 0 && remain <= min;
    });
    if (lowStock.length) {
        const moreId = `lowStockMore-${Date.now()}`;
        alerts.push(`<div class="text-yellow-400 font-semibold mt-2 mb-1">‚ö†Ô∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (${lowStock.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</div>`);
        alerts.push(...lowStock.slice(0, 5).map(r =>
        `<div class="ml-4 text-sm">‚Ä¢ ${r['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']} - ${r['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']} (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${Number(r['‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠']||0).toLocaleString('th-TH')})</div>`
        ));
        if (lowStock.length > 5) {
        alerts.push(`
            <a href="#" class="ml-4 text-xs text-blue-400 underline cursor-pointer alert-toggle" data-target="${moreId}">...‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${lowStock.length-5} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</a>
            <div id="${moreId}" class="ml-4 mt-1 hidden">
            ${lowStock.slice(5).map(r => `<div class="text-sm">‚Ä¢ ${r['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']} - ${r['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']} (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${Number(r['‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠']||0).toLocaleString('th-TH')})</div>`).join('')}
            <a href="#" class="text-xs text-blue-400 underline cursor-pointer alert-toggle" data-target="${moreId}">‡∏ã‡πà‡∏≠‡∏ô</a>
            </div>
        `);
        }
    }
        
    // 3. ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ Deadstock
    const deadStock = cache.stockReport.filter(r => String(r['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').toLowerCase() === 'deadstock');
    if (deadStock.length) {
        const moreId = `deadStockMore-${Date.now()}`;
        alerts.push(`<div class="text-pink-400 font-semibold mt-2 mb-1">üõë ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ Deadstock (${deadStock.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</div>`);
        alerts.push(...deadStock.slice(0, 5).map(r =>
        `<div class="ml-4 text-sm">‚Ä¢ ${r['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']} - ${r['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']}</div>`
        ));
        if (deadStock.length > 5) {
        alerts.push(`
            <a href="#" class="ml-4 text-xs text-blue-400 underline cursor-pointer alert-toggle" data-target="${moreId}">...‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${deadStock.length-5} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</a>
            <div id="${moreId}" class="ml-4 mt-1 hidden">
            ${deadStock.slice(5).map(r => `<div class="text-sm">‚Ä¢ ${r['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']} - ${r['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']}</div>`).join('')}
            <a href="#" class="text-xs text-blue-400 underline cursor-pointer alert-toggle" data-target="${moreId}">‡∏ã‡πà‡∏≠‡∏ô</a>
            </div>
        `);
        }
    }
    
    // 4. ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ Slow Moving
    const slowStock = cache.stockReport.filter(r => String(r['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').toLowerCase() === 'slow');
    if (slowStock.length) {
      alerts.push(`<div class="text-yellow-300 font-semibold mt-2 mb-1">üê¢ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ Slow Moving (${slowStock.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</div>`);
      alerts.push(...slowStock.slice(0, 5).map(r =>
        `<div class="ml-4 text-sm">‚Ä¢ ${r['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']} - ${r['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']}</div>`
      ));
      if (slowStock.length > 5) alerts.push(`<div class="ml-4 text-xs text-gray-400">...‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${slowStock.length-5} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>`);
    }
    
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    if (!alerts.length) {
      alerts.push('<div class="text-green-400">‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</div>');
    }
    
    const alertsContainer = document.getElementById('alertsContainer');
    if (alertsContainer) alertsContainer.innerHTML = alerts.join('');
    
    console.log('topIssued', cache.topIssued);
    console.log('topStockValue', cache.topStockValue);
      // 2. Top 5 ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡πÄ‡∏£‡πá‡∏ß
      const topIssued = (cache.topIssued || []).slice(0, 5);
      document.getElementById('topIssuedList').innerHTML = topIssued.length
        ? topIssued.map((item, i) => `
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center text-sm font-bold">${i + 1}</div>
              <span class="text-sm">${item.productName || '-'}</span>
            </div>
            <span class="text-green-400 font-semibold">${(+item.totalQtyIssued || 0).toLocaleString('th-TH')} ‡∏´‡∏ô‡πà‡∏ß‡∏¢</span>
            </div>
        `).join('')
        : '<div class="text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
    
      // 3. Top 5 ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
      const topStockValue = (cache.topStockValue || []).slice(0, 5);
      document.getElementById('topStockValueList').innerHTML = topStockValue.length
        ? topStockValue.map((item, i) => `
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-sm font-bold">${i + 1}</div>
              <span class="text-sm">${item.productName || '-'}</span>
            </div>
            <span class="text-blue-400 font-semibold">${(+item.totalStockValue || 0).toLocaleString('th-TH', { minimumFractionDigits: 2 })} ‡∏ö‡∏≤‡∏ó</span>
            </div>
        `).join('')
        : '<div class="text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
    
      // 4. Chart.js ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)
      if (window.purchaseChartInstance) window.purchaseChartInstance.destroy();
      const ctx = document.getElementById('purchaseChart').getContext('2d');
      window.purchaseChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: cache.monthlyActivity.labels || [],
          datasets: [{
            label: '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠',
            data: cache.monthlyActivity.purchase || [],
            backgroundColor: '#8b5cf6',
            borderRadius: 8,
            borderSkipped: false,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: '#9ca3af',
                callback: value => value.toLocaleString('th-TH', { minimumFractionDigits: 0 }) + ' ‡∏ö‡∏≤‡∏ó'
              },
              grid: { color: '#374151' }
            },
            x: {
              ticks: { color: '#9ca3af' },
              grid: { display: false }
            }
          }
        }
      });
    }
    
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('alert-toggle')) {
        e.preventDefault();
        const targetId = e.target.getAttribute('data-target');
        const el = document.getElementById(targetId);
        if (el) el.classList.toggle('hidden');
      }
    });
    function toggleAlertMore(id) {
        const el = document.getElementById(id);
        if (el) el.classList.toggle('hidden');
        }
            // ...existing code...
      function parseSheetDate(dateStr) {
        // ‡πÅ‡∏õ‡∏•‡∏á dd-MMM-yyyy ‡πÄ‡∏õ‡πá‡∏ô YYYY-MM-DD
        if (!dateStr) return '';
        const parts = String(dateStr).split('-');
        if (parts.length === 3) {
          const day = parts[0].padStart(2, '0');
          const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
          const month = (monthNames.indexOf(parts[1]) + 1).toString().padStart(2, '0');
          const year = parts[2];
          return `${year}-${month}-${day}`;
        }
        return '';
      }
      
      const today = new Date();
      const todayStr = today.toISOString().slice(0,10); // YYYY-MM-DD
      
      // ‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
      const purchasesToday = cache.lots.filter(lot => !!lot['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']);
      const issuesToday = (cache.issues || []).filter(issue => !!issue['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'])

      document.addEventListener('click', function(e) {
        if (e.target && e.target.id === 'viewOutOfStockBtn') {
          const modal = document.getElementById('outOfStockModal');
          const list = document.getElementById('outOfStockList');
          if (modal && list) {
            list.innerHTML = cache.stockReport
              .filter(r => (+r['‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠']||0) === 0)
              .map(item => `<div class="bg-gray-700 border border-gray-600 rounded-md px-3 py-2">${String(item['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim()} - ${String(item['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim()}</div>`)
              .join('');
            modal.classList.remove('hidden');
          }
        }
        if (e.target && e.target.id === 'closeOutOfStockModal') {
          const modal = document.getElementById('outOfStockModal');
          if (modal) modal.classList.add('hidden');
        }
      });
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° event ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
      const stockSearchInput = document.getElementById('reportSearch');
      if (stockSearchInput) {
        stockSearchInput.addEventListener('input', (e) => {
          renderReport(e.target.value);
        });
      }
      
      function renderReport(searchQuery = '') {
        const body = document.getElementById('reportBody');
        if (!body) return; 
        body.innerHTML = '';
        const lowerCaseQuery = (searchQuery || '').toLowerCase().trim();
        const filteredStock = cache.stockReport.filter(item => {
          const sku = (String(item['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || '')).toLowerCase();
          const name = (String(item['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || '')).toLowerCase();
          return sku.includes(lowerCaseQuery) || name.includes(lowerCaseQuery);
        });
        if(filteredStock.length===0){
          body.innerHTML = '<tr><td class="px-4 py-3 text-gray-400" colspan="9">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td></tr>';
          return;
        }
        filteredStock.forEach(r=>{
          let badgeClass = 'bg-gray-600/20 text-gray-300';
          let displayText = String(r['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim();
          const movementTypeLower = displayText.toLowerCase();
          if (movementTypeLower === 'fast') {
            badgeClass = 'bg-emerald-600/20 text-emerald-300';
            displayText = 'Fast';
          } else if (movementTypeLower === 'deadstock') {
            badgeClass = 'bg-red-600/20 text-red-300';
            displayText = 'Deadstock';
          } else if (movementTypeLower === 'slow') {
            badgeClass = 'bg-yellow-600/20 text-yellow-300';
            displayText = 'Slow';
          } else if (displayText === '') {
            displayText = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
          } else {
            displayText = displayText.charAt(0).toUpperCase() + displayText.slice(1);
            badgeClass = 'bg-indigo-600/20 text-indigo-300';
          }
      
          const tr = document.createElement('tr');
          tr.className = 'border-t border-gray-700/60';
          tr.innerHTML = `
            <td class="px-4 py-3 text-center">
              <input type="checkbox" class="stock-checkbox" value="${String(r['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || '').trim()}">
            </td>
            <td class="px-4 py-3">${String(r['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim()}</td>
            <td class="px-4 py-3">${String(r['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim()}</td>
            <td class="px-4 py-3">${Number(r['‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'] || 0).toLocaleString('th-TH')}</td>
            <td class="px-4 py-3">${Number(r['‡πÄ‡∏ö‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'] || 0).toLocaleString('th-TH')}</td>
            <td class="px-4 py-3 text-right">${Number(r['‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠']||0).toLocaleString('th-TH')}</td>
            <td class="px-4 py-3 text-right">${Number(r['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥']||0).toLocaleString('th-TH')}</td>
            <td class="px-4 py-3 text-right">${Number(r['‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô']||0).toLocaleString('th-TH',{minimumFractionDigits:2})}</td>
            <td class="px-4 py-3 text-right">${Number(r['‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô']||0).toLocaleString('th-TH',{minimumFractionDigits:2})}</td>
            <td class="px-4 py-3 text-center"><span class="text-xs px-2 py-1 rounded ${badgeClass}">${displayText}</span></td>
            <td class="px-4 py-3 text-center">
              <button class="view-lot-details-btn px-3 py-1 rounded bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium" data-sku="${String(r['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || '').trim()}" data-product-name="${String(r['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || '').trim()}">
                ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
              </button>
            </td>
          `;
          body.appendChild(tr);
        });
      
        // Attach event listeners for "‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Lot"
        body.querySelectorAll('.view-lot-details-btn').forEach(button => {
          button.addEventListener('click', (e) => {
            const productSku = e.target.dataset.sku;
            const productName = e.target.dataset.productName;
            showLotDetails(productSku, productName);
          });
        });
        updateExportStockButtonVisibility();
      }

      // New function to show lot details in a modal
      function showLotDetails(productSku, productName) {
        const lotDetailModal = document.getElementById('lotDetailModal');
        const lotDetailModalTitle = document.getElementById('lotDetailModalTitle');
        const lotDetailContent = document.getElementById('lotDetailContent');
        const closeLotDetailModalBtn = document.getElementById('closeLotDetailModal');

        if (!lotDetailModal || !lotDetailModalTitle || !lotDetailContent || !closeLotDetailModalBtn) return;

        const stockRow = cache.stockReport.find(r => String(r['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim() === productSku);
        
        lotDetailModalTitle.textContent = `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Lot ‡∏Ç‡∏≠‡∏á: ${productName} (${productSku})`;
        lotDetailContent.innerHTML = ''; // Clear previous content

        if (stockRow) {
          lotDetailContent.innerHTML += `
            <div class="mb-2 flex gap-4">
              <div class="text-sm text-blue-300">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span class="font-bold text-white">${Number(stockRow['‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î']||0).toLocaleString('th-TH')}</span></div>
              <div class="text-sm text-pink-300">‡πÄ‡∏ö‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span class="font-bold text-white">${Number(stockRow['‡πÄ‡∏ö‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î']||0).toLocaleString('th-TH')}</span></div>
            </div>
          `;
        }
        const productLots = cache.lots
            .filter(l => String(l['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim() === productSku && (+l['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠']||0) > 0)
            .sort((a, b) => new Date(a['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']) - new Date(b['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'])); // Sort by date for FIFO order

        if (productLots.length === 0) {
            lotDetailContent.innerHTML = '<p class="text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö Lot ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ</p>';
        } else {
            let totalRemainingQty = 0;
            productLots.forEach(lot => {
                totalRemainingQty += (+lot['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠']||0);
                const lotItem = document.createElement('div');
                lotItem.className = 'bg-gray-700 border border-gray-600 rounded-md p-3';
                lotItem.innerHTML = `
                    <div class="font-medium text-blue-300">Lot ID: ${String(lot.lotId || lot['Lotstoct'] || 'N/A').trim()}</div>
                    <div class="text-sm mt-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤: <span class="text-cyan-300">${formatDateToDDMMMYYYY(lot['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'])}</span></div>
                    <div class="text-sm">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <span class="font-bold text-white">${Number(lot['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠']||0).toLocaleString('th-TH')}</span> ‡∏ä‡∏¥‡πâ‡∏ô</div>
                    <div class="text-sm">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢: <span class="font-bold text-white">${Number(lot['‡∏£‡∏≤‡∏Ñ‡∏≤']||0).toLocaleString('th-TH', {minimumFractionDigits: 2})}</span> ‡∏ö‡∏≤‡∏ó</div>
                    <div class="text-sm">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ Lot: <span class="font-bold text-white">${Number((+lot['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠']||0) * (+lot['‡∏£‡∏≤‡∏Ñ‡∏≤']||0)).toLocaleString('th-TH', {minimumFractionDigits: 2})}</span> ‡∏ö‡∏≤‡∏ó</div>
                `;
                lotDetailContent.appendChild(lotItem);
            });
            // Add total remaining quantity at the end
            const totalQtyDiv = document.createElement('div');
            totalQtyDiv.className = 'mt-4 text-lg font-bold text-white';
            totalQtyDiv.innerHTML = `‡∏£‡∏ß‡∏°‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span class="text-green-400">${Number(totalRemainingQty).toLocaleString('th-TH')}</span> ‡∏ä‡∏¥‡πâ‡∏ô`;
            lotDetailContent.appendChild(totalQtyDiv);
        }

        lotDetailModal.classList.remove('hidden');

        const closeHandler = () => {
            lotDetailModal.classList.add('hidden');
            closeLotDetailModalBtn.removeEventListener('click', closeHandler);
        };
        closeLotDetailModalBtn.addEventListener('click', closeHandler);

        lotDetailModal.addEventListener('click', (e) => {
            if (e.target === lotDetailModal) {
                closeHandler();
            }
        });
      }


      function renderVendors() {
          const body = document.getElementById('vendorBody');
          if (!body) return; 
          body.innerHTML = '';
          if (cache.vendors.length === 0) {
              body.innerHTML = '<tr><td class="px-4 py-3 text-gray-400" colspan="5">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</td></tr>';
              return;
          }
          cache.vendors.forEach(v => {
              const tr = document.createElement('tr');
              tr.className = 'border-t border-gray-700/60';
              tr.innerHTML = `
                <td class="px-4 py-3 text-center">
                    <input type="checkbox" class="vendor-checkbox" value="${String(v['‡∏£‡∏´‡∏±‡∏™ Vendors'] || '').trim()}">
                </td>
                  <td class="px-4 py-3">${String(v['‡∏£‡∏´‡∏±‡∏™ Vendors'] || '').trim()}</td>
                  <td class="px-4 py-3">${String(v['Vender'] || '').trim()}</td>
                  <td class="px-4 py-3">${String(v['‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà'] || '').trim()}</td>
                  <td class="px-4 py-3">${String(v['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£'] || '').trim()}</td>
                  <td class="px-4 py-3">${String(v['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏à‡∏î‡∏ó‡∏ö.'] || '').trim()}</td>
                    <td class="px-4 py-3 text-center">
                        <button class="view-vendor-history-btn px-3 py-1 mr-2 rounded bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium" data-vendor-code="${String(v['‡∏£‡∏´‡∏±‡∏™ Vendors'] || '').trim()}">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
                        <button class="export-vendor-excel-btn px-3 py-1 rounded bg-green-600 hover:bg-green-700 text-white text-xs font-medium" data-vendor-code="${String(v['‡∏£‡∏´‡∏±‡∏™ Vendors'] || '').trim()}">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</button>
                    </td>
            `;
              body.appendChild(tr);
          });
      
      document.querySelectorAll('.view-vendor-history-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const vendorCode = btn.dataset.vendorCode;
            const vendor = cache.vendors.find(v => String(v['‡∏£‡∏´‡∏±‡∏™ Vendors']||'').trim() === vendorCode);
            if (vendor) showVendorPurchaseModal(vendor);
        });
    });
    document.querySelectorAll('.export-vendor-excel-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const vendorCode = btn.dataset.vendorCode;
            const vendor = cache.vendors.find(v => String(v['‡∏£‡∏´‡∏±‡∏™ Vendors']||'').trim() === vendorCode);
            if (vendor) exportVendorHistoryToExcel(vendor);
        });
    });
}
// ...‡πÉ‡∏ô <scri> ‡∏´‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderVendors()...

// 2. ‡πÄ‡∏û‡∏¥‡πà‡∏° event ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
const vendorSearch = document.getElementById('vendorSearch');
if (vendorSearch) {
  vendorSearch.addEventListener('input', (e) => {
    renderVendors(e.target.value);
  });
}

// 3. ‡∏õ‡∏£‡∏±‡∏ö renderVendors ‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ö searchQuery
function renderVendors(searchQuery = '') {
  const body = document.getElementById('vendorBody');
  if (!body) return; 
  body.innerHTML = '';
  const lowerCaseQuery = (searchQuery || '').toLowerCase().trim();
  const filteredVendors = cache.vendors.filter(vendor => {
    const code = (String(vendor['‡∏£‡∏´‡∏±‡∏™ Vendors'] || '')).toLowerCase();
    const name = (String(vendor['Vender'] || '')).toLowerCase();
    return code.includes(lowerCaseQuery) || name.includes(lowerCaseQuery);
  });
  if (filteredVendors.length === 0) {
    body.innerHTML = '<tr><td class="px-4 py-3 text-gray-400" colspan="7">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</td></tr>';
    return;
  }
  filteredVendors.forEach(v => {
    const tr = document.createElement('tr');
    tr.className = 'border-t border-gray-700/60';
    tr.innerHTML = `
      <td class="px-4 py-3 text-center">
        <input type="checkbox" class="vendor-checkbox" value="${String(v['‡∏£‡∏´‡∏±‡∏™ Vendors'] || '').trim()}">
      </td>
      <td class="px-4 py-3">${String(v['‡∏£‡∏´‡∏±‡∏™ Vendors'] || '').trim()}</td>
      <td class="px-4 py-3">${String(v['Vender'] || '').trim()}</td>
      <td class="px-4 py-3">${String(v['‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà'] || '').trim()}</td>
      <td class="px-4 py-3">${String(v['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£'] || '').trim()}</td>
      <td class="px-4 py-3">${String(v['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏à‡∏î‡∏ó‡∏ö.'] || '').trim()}</td>
      <td class="px-4 py-3 text-center">
        <button class="view-vendor-history-btn px-3 py-1 mr-2 rounded bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium" data-vendor-code="${String(v['‡∏£‡∏´‡∏±‡∏™ Vendors'] || '').trim()}">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
        <button class="export-vendor-excel-btn px-3 py-1 rounded bg-green-600 hover:bg-green-700 text-white text-xs font-medium" data-vendor-code="${String(v['‡∏£‡∏´‡∏±‡∏™ Vendors'] || '').trim()}">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</button>
      </td>
    `;
    body.appendChild(tr);
  });

  // Attach event listeners (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
  body.querySelectorAll('.view-vendor-history-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const vendorCode = btn.dataset.vendorCode;
      const vendor = cache.vendors.find(v => String(v['‡∏£‡∏´‡∏±‡∏™ Vendors']||'').trim() === vendorCode);
      if (vendor) showVendorPurchaseModal(vendor);
    });
  });
  body.querySelectorAll('.export-vendor-excel-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const vendorCode = btn.dataset.vendorCode;
      const vendor = cache.vendors.find(v => String(v['‡∏£‡∏´‡∏±‡∏™ Vendors']||'').trim() === vendorCode);
      if (vendor) exportVendorHistoryToExcel(vendor);
    });
  });
updateExportVendorsButtonVisibility();}

// 4. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å renderVendors() ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏°‡∏µ searchQuery
renderVendors();
// ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å
    function updateExportVendorsButtonVisibility() {
      const btn = document.getElementById('exportSelectedVendorsBtn');
      const checked = document.querySelectorAll('.vendor-checkbox:checked');
      if (btn) btn.classList.toggle('hidden', checked.length === 0);
    }
    document.addEventListener('change', function(e) {
      if (e.target.classList.contains('vendor-checkbox') || e.target.id === 'selectAllVendors') {
        // ‡∏ñ‡πâ‡∏≤ selectAll ‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏•‡∏¥‡∏Å
        if (e.target.id === 'selectAllVendors') {
          const checked = e.target.checked;
          document.querySelectorAll('.vendor-checkbox').forEach(cb => cb.checked = checked);
        }
        updateExportVendorsButtonVisibility();
      }
    });

// Event: ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å
document.getElementById('exportSelectedVendorsBtn')?.addEventListener('click', function() {
  const checked = Array.from(document.querySelectorAll('.vendor-checkbox:checked')).map(cb => cb.value);
  if (checked.length === 0) return;
  exportMultiVendorsToExcel(checked);
});

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel ‡∏´‡∏•‡∏≤‡∏¢‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢
    function exportMultiVendorsToExcel(vendorCodes) {
      const selectedLots = (cache.lots || []).filter(lot =>
        vendorCodes.includes(String(lot['‡∏£‡∏´‡∏±‡∏™ Vender'] || '').trim())
      );
      if (selectedLots.length === 0) {
        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å');
        return;
      }
    function formatDateOnly(dateStr) {
      if (!dateStr) return '';
      if (dateStr.includes('T')) return dateStr.split('T')[0];
      return dateStr;
    }
      // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á header ‡πÅ‡∏•‡∏∞ rows (‡πÄ‡∏û‡∏¥‡πà‡∏° "‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢" ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏£‡∏Å)
      const header = ['‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢', '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ (‡∏ö‡∏≤‡∏ó)', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠'];
      const rows = selectedLots.map(lot => {
        const vendor = cache.vendors.find(v => String(v['‡∏£‡∏´‡∏±‡∏™ Vendors']||'').trim() === String(lot['‡∏£‡∏´‡∏±‡∏™ Vender']||'').trim());
        const vendorName = vendor ? String(vendor['Vender']||'') : String(lot['‡∏£‡∏´‡∏±‡∏™ Vender']||'');
        return [
          vendorName,
          String(lot['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || ''),
          String(lot['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || ''),
          Number(lot['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠'] || 0),
          Number(lot['‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°'] || 0).toFixed(2),
          formatDateOnly(lot['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] || '')
        ];
      });
      // 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á CSV
      const csvContent = '\uFEFF' + [header, ...rows].map(r => r.join(',')).join('\r\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠_‡∏´‡∏•‡∏≤‡∏¢‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
      function showVendorPurchaseModal(vendor) {
        const modal = document.getElementById('vendorPurchaseModal');
        const title = document.getElementById('vendorPurchaseModalTitle');
        const list = document.getElementById('vendorPurchaseList');
        if (!modal || !title || !list) return;

        title.textContent = `‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Å‡∏±‡∏ö "${vendor['Vender']}" (${vendor['‡∏£‡∏´‡∏±‡∏™ Vendors']})`;

        const purchases = (cache.lots || []).filter(lot => 
            String(lot['‡∏£‡∏´‡∏±‡∏™ Vender'] || '').trim() === String(vendor['‡∏£‡∏´‡∏±‡∏™ Vendors'] || '').trim()
        );

        if (purchases.length === 0) {
            list.innerHTML = `<div class="text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Å‡∏±‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</div>`;
        } else {
            list.innerHTML = purchases.map(lot => `
                <div class="bg-gray-700 border border-gray-600 rounded-md p-3">
                    <div><span class="font-bold text-white">${lot['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']}</span></div>
                    <div class="text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: <span class="text-blue-300">${Number(lot['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠']||0).toLocaleString('th-TH')}</span> | 
                        ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤: <span class="text-green-300">${Number(lot['‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°']||0).toLocaleString('th-TH', {minimumFractionDigits:2})} ‡∏ö‡∏≤‡∏ó</span>
                </div>
                <div class="text-xs text-gray-400">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠: ${lot['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] || '-'}</div>
            </div>
            `).join('');
        }
        modal.classList.remove('hidden');
    }
        // ...existing code...
    
    // ‡∏õ‡∏¥‡∏î modal ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢ (‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏∏‡πà‡∏° "‡∏õ‡∏¥‡∏î" ‡πÅ‡∏•‡∏∞ "‡∏Å‡∏≤‡∏Å‡∏ö‡∏≤‡∏ó")
    document.addEventListener('click', function(e) {
      if (
        e.target.id === 'closeVendorPurchaseModal' ||
        e.target.id === 'closeVendorPurchaseModal2' ||
        (e.target.id === 'vendorPurchaseModal' && e.target.classList.contains('modal-overlay'))
      ) {
        const modal = document.getElementById('vendorPurchaseModal');
        if (modal) modal.classList.add('hidden');
      }
    });
        // ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å
    function updateExportStockButtonVisibility() {
      const btn = document.getElementById('exportSelectedStockBtn');
      const checked = document.querySelectorAll('.stock-checkbox:checked');
      if (btn) btn.classList.toggle('hidden', checked.length === 0);
    }
    
    // Event: ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å checkbox
    document.addEventListener('change', function(e) {
      if (e.target.classList.contains('stock-checkbox') || e.target.id === 'selectAllStock') {
        // ‡∏ñ‡πâ‡∏≤ selectAll ‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏•‡∏¥‡∏Å
        if (e.target.id === 'selectAllStock') {
          const checked = e.target.checked;
          document.querySelectorAll('.stock-checkbox').forEach(cb => cb.checked = checked);
        }
        updateExportStockButtonVisibility();
      }
    });
    
    // Event: ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å
    document.getElementById('exportSelectedStockBtn').addEventListener('click', function() {
      const checked = Array.from(document.querySelectorAll('.stock-checkbox:checked')).map(cb => cb.value);
      if (checked.length === 0) return;
      exportMultiStockToExcel(checked);
    });
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel ‡∏´‡∏•‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    function exportMultiStockToExcel(skuList) {
      const selected = cache.stockReport.filter(r => skuList.includes(String(r['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim()));
      if (selected.length === 0) {
        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å');
        return;
      }
      const header = ['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', '‡πÄ‡∏ö‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠', '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥', '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ä‡∏¥‡πâ‡∏ô', '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°', '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß'];
      const rows = selected.map(r => [
        String(r['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||''),
        String(r['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').replace(/"/g, '""'),
        Number(r['‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î']||0).toLocaleString('en-US'),
        Number(r['‡πÄ‡∏ö‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î']||0).toLocaleString('en-US'),
        Number(r['‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠']||0).toLocaleString('en-US'),
        Number(r['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥']||0).toLocaleString('en-US'),
        Number(r['‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô']||0).toLocaleString('en-US', {minimumFractionDigits:2}),
        Number(r['‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô']||0).toLocaleString('en-US', {minimumFractionDigits:2}),
        String(r['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'')
      ]);
      const csvContent = '\uFEFF' + [header, ...rows].map(r => r.map(cell => {
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ comma ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà ""
        return /[",\s]/.test(cell) ? `"${cell}"` : cell;
      }).join(',')).join('\r\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

      function renderProjects() {
          const body = document.getElementById('projectBody');
          if (!body) return; 
          body.innerHTML = '';
          if (cache.projects.length === 0) {
              body.innerHTML = '<tr><td class="px-4 py-3 text-gray-400" colspan="4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</td></tr>'; 
              return;
          }
          cache.projects.forEach(p => {
              const tr = document.createElement('tr');
              tr.className = 'border-t border-gray-700/60';
              tr.innerHTML = `
                  <td class="px-4 py-3">${String(p['‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∏‡∏î'] || '').trim()}</td>
                  <td class="px-4 py-3">${String(p['‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£'] || '').trim()}</td>
                  <td class="px-4 py-3">${String(p['Customer'] || '').trim()}</td>
                  <td class="px-4 py-3">${String(p['‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠'] || '').trim()}</td>
                  <td class="px-4 py-3">${String(p['‡∏£‡∏´‡∏±‡∏™']||'').trim()}</td>
                  <td class="px-4 py-3">${String(p['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó']||'').trim()}</td>
                  <td class="px-4 py-3">${String(p['CODE']||'').trim()}</td>
                  <td class="px-4 py-3">${String(p['‡πÄ‡∏ü‡∏™']||'').trim()}</td>
                  <td class="px-4 py-3">${String(p['‡∏ã‡∏≠‡∏¢']||'').trim()}</td>
                  <td class="px-4 py-3">${String(p['‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà'] || '').trim()}</td>
                  <td class="px-4 py-3">${String(p['‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'] || '').trim()}</td>
                  <td class="px-4 py-3 text-center">
                    <button class="edit-project-btn px-3 py-1 rounded bg-purple-600 hover:bg-purple-700 text-white text-xs font-medium" data-code="${String(p['‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∏‡∏î']||'')}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button class="delete-project-btn px-3 py-1 rounded bg-red-600 hover:bg-red-700 text-white text-xs font-medium" data-code="${String(p['‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∏‡∏î']||'')}">‡∏•‡∏ö</button>
                  </td>
              `;
              body.appendChild(tr);
          });

          // Re-attach event listeners for edit/delete buttons after rendering
          document.querySelectorAll('.edit-project-btn').forEach(button => {
              button.addEventListener('click', (e) => {
                  const projectCode = e.target.dataset.projectCode;
                  const projectToEdit = cache.projects.find(p => String(p['‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∏‡∏î'] || '').trim() === projectCode);
                  if (projectToEdit) {
                      populateProjectFormForEdit(projectToEdit);
                      setActiveTab('add-project');
                  }
              });
          });

          document.querySelectorAll('.delete-project-btn').forEach(button => {
              button.addEventListener('click', async (e) => {
                  const projectCode = e.target.dataset.projectCode;
                  const projectName = cache.projects.find(p => String(p['‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∏‡∏î'] || '').trim() === projectCode)?.['‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£'] || projectCode;
                  const confirmed = await showCustomConfirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ "${String(projectName||'').trim()}" ‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`);
                  if (confirmed) {
                      const payload = {
                          actionType: 'deleteProject',
                          data: { '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∏‡∏î': projectCode }
                      };
                      try {
                          const result = await sendToAppsScript(payload, addProjectStatus);
                          loadAll();
                      } catch (error) {
                          console.error('Error deleting project:', error);
                      }
                  }
              });
          });
      }


      // =========================
      // UI (Canva): "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" Form
      // =========================
      const purchaseForm = document.getElementById('purchaseForm');
      const purchaseStatus = document.getElementById('purchaseStatus');
      const purchasePreview = document.getElementById('purchasePreview');
      const purchaseDateEl = document.getElementById('purchaseDate'); 
      const purchaseSearchInput = document.getElementById('purchaseSearch');
      const purchaseProductSelect = document.getElementById('purchaseProduct');

      if (purchaseDateEl) purchaseDateEl.valueAsDate = new Date();
          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô <script> ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    function generateLotId(productCode, dateStr, lotIndex = 1) {
      let ymd = '';
      if (dateStr) {
        let d = new Date(dateStr);
        if (!isNaN(d)) {
          ymd = d.getFullYear().toString() +
            String(d.getMonth() + 1).padStart(2, '0') +
            String(d.getDate()).padStart(2, '0');
        }
      }
      return `${productCode}-${ymd}-${String(lotIndex).padStart(2, '0')}`;
    }

      function getPurchasePayload(withAction=true){
        const selectedDate = purchaseDateEl ? purchaseDateEl.value : ''; 
        const pid = (String(document.getElementById('purchaseProduct')?.value||'')).trim();
        const ven = (String(document.getElementById('purchaseVendor')?.value||'')).trim();
        const qty = parseFloat(document.getElementById('purchaseQty')?.value||'0');
        const price = parseFloat(document.getElementById('purchasePrice')?.value||'0');
        const otherCost = parseFloat(document.getElementById('purchaseOtherCost')?.value||'0');
        const discount = parseFloat(document.getElementById('purchaseDiscount')?.value||'0');
        const note = (String(document.getElementById('purchaseNote')?.value||'')).trim();
        let total = qty * price + otherCost - discount;
        if (total < 0) total = 0;
        const lotId = generateLotId(pid, selectedDate, 1); // ‡∏ñ‡πâ‡∏≤ 1 lot ‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô/‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        const payload = {
          actionType: withAction ? 'purchase' : undefined,
          sheet: 'PurchaseTransactions',
          data: {
            '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': selectedDate, 
            '‡∏£‡∏´‡∏±‡∏™ Vender': ven,
            '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤': pid,
            '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠': qty,
            '‡∏£‡∏≤‡∏Ñ‡∏≤': price,
            '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ': otherCost,
            '‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î': discount,
            '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°': total,
            '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏': note,
            'Lotstoct': lotId
          }
        };
        if(!withAction) delete payload.actionType;
        return payload;
      }

      if (purchaseForm) { 
        purchaseForm.addEventListener('input', ()=>{
          if (purchasePreview) purchasePreview.textContent = JSON.stringify(getPurchasePayload(false), null, 2);
        });

        purchaseForm.addEventListener('submit', async (e)=>{
          e.preventDefault();
          if (purchaseStatus) purchaseStatus.textContent = '';
          const selectedDate = purchaseDateEl ? purchaseDateEl.value : ''; 
          const pid = (String(document.getElementById('purchaseProduct')?.value||'')).trim();
          const ven = (String(document.getElementById('purchaseVendor')?.value||'')).trim();
          const qty = parseFloat(document.getElementById('purchaseQty')?.value||'0');
          const price = parseFloat(document.getElementById('purchasePrice')?.value||'0');
          const otherCost = parseFloat(document.getElementById('purchaseOtherCost')?.value||'0');
          const total = qty*price + otherCost;
          const totalEl = document.getElementById('purchaseTotalPreview');
          if (totalEl) totalEl.textContent = `‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${total.toLocaleString('th-TH', {minimumFractionDigits:2})} ‡∏ö‡∏≤‡∏ó`;
          if(!selectedDate || !pid){
            if (purchaseStatus) purchaseStatus.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)';
            return;
        }
// qty, price, etc. ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÑ‡∏î‡πâ (‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏°)

          const payload = getPurchasePayload(true);
          if (purchasePreview) purchasePreview.textContent = JSON.stringify(payload, null, 2);

          try{
            await sendToAppsScript(payload, purchaseStatus);
            loadAll(); 
            purchaseForm.reset();
            if (purchaseDateEl) purchaseDateEl.valueAsDate = new Date(); 
          }catch(err){
          }
        });
      }

      // =========================
      // UI (Canva): "‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (FIFO)" Form
      // =========================
      const issueForm = document.getElementById('issueForm');
      const issueStatus = document.getElementById('issueStatus');
      const issuePreview = document.getElementById('issuePreview');
      const fifoResult = document.getElementById('fifoResult');
      const issueSearchInput = document.getElementById('issueSearch');
      const issueProductSelect = document.getElementById('issueProduct');
      const issueDateEl = document.getElementById('issueDate');
      if (issueDateEl) issueDateEl.valueAsDate = new Date();

      function getIssuePayload(withAction=true, picks=[]){
        const pid = (String(document.getElementById('issueProduct')?.value||'')).trim();
        const proj = (String(document.getElementById('issueProject')?.value||'')).trim();
        const qty = parseFloat(document.getElementById('issueQty')?.value||'0');
        const remark = (String(document.getElementById('issueRemark')?.value||'')).trim(); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
        const issueDate = issueDateEl ? issueDateEl.value : '';
        const payload = {
          actionType: withAction ? 'issue' : undefined,
          sheet: 'IssueTransactions',
          data: {
            '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': issueDate,
            '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤': pid,
            '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å': qty,
            '‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∏‡∏î‡πÄ‡∏ö‡∏¥‡∏Å': proj,
            '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏': remark,
            'lotDraft': picks
          }
        };
        if(!withAction) delete payload.actionType;
        return payload;
      }

      const simulateFIFOBtn = document.getElementById('simulateFIFO');
      if (simulateFIFOBtn) { 
        simulateFIFOBtn.addEventListener('click', ()=>{
          const pid = (String(document.getElementById('issueProduct')?.value||'')).trim();
          const qtyReq = parseFloat(document.getElementById('issueQty')?.value||'0');
          if(!pid || qtyReq<=0){
            if (fifoResult) fifoResult.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
            if (issuePreview) issuePreview.textContent = JSON.stringify(getIssuePayload(false, []), null, 2);
            return;
          }
          const lots = cache.lots
            .filter(l => String(l['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim()===pid && (+l['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠']||0) > 0)
            .sort((a,b)=> new Date(a['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']) - new Date(b['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'])); 

          let remain = qtyReq;
          const picks = []; // Stores the lots that will be picked
          for(const lot of lots){
            if(remain<=0) break;
            const take = Math.min(remain, +lot['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠']||0);
            if(take>0){
              picks.push({ lotId: lot.lotId, qty: take, price: +lot['‡∏£‡∏≤‡∏Ñ‡∏≤']||0, date: lot['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] });
              remain -= take;
            }
          }

          const stockBefore = lots.reduce((s,l)=> s + (+l['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠']||0), 0);
          const stockAfter = stockBefore - qtyReq;

          if(remain>0){
            if (fifoResult) fifoResult.innerHTML = `<span class="text-red-400">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏≠ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡∏Å ${remain}</span><div class="mt-2 text-sm">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏£‡∏ß‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <b>${stockBefore}</b></div>`;
          }else{
            const lotLines = picks.map(p=>`‚Ä¢ Lot ${String(p.lotId||'').trim()} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatDateToDDMMMYYYY(p.date)} ‚Äî ‡∏ï‡∏±‡∏î ${p.qty} ‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡∏£‡∏≤‡∏Ñ‡∏≤ ${p.price})`).join('<br>');
            if (fifoResult) fifoResult.innerHTML = `${lotLines}<br><div class="mt-2 text-blue-400">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏î: <b>${stockAfter}</b></div>`;
          }
          if (issuePreview) issuePreview.textContent = JSON.stringify(getIssuePayload(false, picks), null, 2); // Pass picks here
        });
      }

      if (issueForm) { 
        issueForm.addEventListener('input', ()=>{
          e.preventDefault();
          if (issueStatus) issueStatus.textContent = '';
          const pid = (String(document.getElementById('issueProduct')?.value||'')).trim();
          const proj = (String(document.getElementById('issueProject')?.value||'')).trim();
          const qty = parseFloat(document.getElementById('issueQty')?.value||'0');
          const lots = cache.lots
            .filter(l => String(l['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim()===pid && (+l['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠']||0) > 0)
            .sort((a,b)=> new Date(a['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']) - new Date(b['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']));
          const stockBefore = lots.reduce((s,l)=> s + (+l['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠']||0), 0);
          const stockAfter = isNaN(qty) ? stockBefore : (stockBefore - qty);
          if(pid && qty>0){
            if (fifoResult) fifoResult.innerHTML = `<div class="text-xs text-gray-300">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <b>${stockBefore}</b> ‚Ä¢ ‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏î: <b class="text-blue-400">${Math.max(stockAfter,0)}</b></div>`;
          }
          if (issuePreview) issuePreview.textContent = JSON.stringify(getIssuePayload(false, []), null, 2);
        });

        issueForm.addEventListener('submit', async (e)=>{
          e.preventDefault();
          if (issueStatus) issueStatus.textContent = '';
          const pid = (String(document.getElementById('issueProduct')?.value||'')).trim();
          const proj = (String(document.getElementById('issueProject')?.value||'')).trim();
          const qty = parseFloat(document.getElementById('issueQty')?.value||'0');

          if(!pid || !proj || qty<=0){
            if (issueStatus) issueStatus.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô';
            return;
          }
          const payload = getIssuePayload(true, []); // picks are handled server-side now
          if (issuePreview) issuePreview.textContent = JSON.stringify(payload, null, 2);

          try{
            await sendToAppsScript(payload, issueStatus);
            loadAll();
            issueForm.reset();
            if (fifoResult) fifoResult.textContent = '‚Äî ‡∏Å‡∏î ‚Äú‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Lot ‡πÅ‡∏ö‡∏ö FIFO‚Äù ‚Äî';
          }catch(err){
          }
        });
      }
      
      // =========================
      // Google Apps Script: Send Data
      // =========================
      async function sendToAppsScript(payload, statusEl){
        if (statusEl) { 
          statusEl.innerHTML = '<span class="inline-flex items-center gap-2 text-gray-200"><span class="w-4 h-4 border-2 border-white/60 border-t-transparent rounded-full spin"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>';
        }
        console.log("Sending payload to Apps Script:", payload);

        try{
          const r1 = await fetch(WRITE_API, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const t = await r1.text(); 
          let result;
          try { result = JSON.parse(t); } catch { result = { ok: r1.ok, message: t || (r1.ok?'OK':'Error') }; }
          console.log("Apps Script response (JSON try):", result);

          if(!r1.ok || result.ok===false){
            // Custom error message for deletion failure
            if ((payload.actionType === 'deleteVendor' || payload.actionType === 'deleteProduct' || payload.actionType === 'deleteProject') && String(result.message || '').includes('‡πÑ‡∏°‡πà‡∏û‡∏ö')) {
                // If the item was not found for deletion, treat as a "soft" success for the frontend
                if (statusEl) {
                    statusEl.innerHTML = `<span class="text-yellow-400">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</span> ${result.message || '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏≤‡∏Å Google Sheet'}`;
                }
                return { ok: true, message: result.message || '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß', itemNotFound: true };
            }
            throw new Error(result.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          }
          if (statusEl) { 
            statusEl.innerHTML = `<span class="text-blue-400">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:</span> ${result.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'}`;
          }
          return result; 
        }catch(errJSON){
          console.error("Error with JSON payload, attempting form-urlencoded:", errJSON);
          try{
            const r2 = await fetch(WRITE_API, {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
              body: 'payload=' + encodeURIComponent(JSON.stringify(payload))
            });
            const t2 = await r2.text();
            let result2;
            try { result2 = JSON.parse(t2); } catch { result2 = { ok: r2.ok, message: t2 || (r2.ok?'OK':'Error') }; }
            console.log("Apps Script response (Form-urlencoded try):", result2);

            if(!r2.ok || result2.ok===false){
              // Custom error message for deletion failure
              if ((payload.actionType === 'deleteVendor' || payload.actionType === 'deleteProduct' || payload.actionType === 'deleteProject') && String(result2.message || '').includes('‡πÑ‡∏°‡πà‡∏û‡∏ö')) {
                  if (statusEl) {
                      statusEl.innerHTML = `<span class="text-yellow-400">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</span> ${result2.message || '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏≤‡∏Å Google Sheet'}`;
                  }
                  return { ok: true, message: result2.message || '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß', itemNotFound: true };
              }
              throw new Error(result2.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            }
            if (statusEl) { 
              statusEl.innerHTML = `<span class="text-blue-400">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:</span> ${result2.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'}`;
            }
            return result2; 
          }catch(errForm){
            console.error("Error with form-urlencoded payload:", errForm);
            if (statusEl) { 
              statusEl.innerHTML = `<span class="text-red-400">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ:</span> ${errForm.message || '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö WRITE_API / doPost'}`;
            }
            throw errForm;
          }
        }
      }

      // =========================
      // Add/Edit/Delete Product Code
      // =========================
      const addProductForm = document.getElementById('addProductForm');
      const addProductStatus = document.getElementById('addProductStatus');
      const addProductTitle = document.getElementById('addProductTitle');
      const submitProductBtn = document.getElementById('submitProductBtn');
      const cancelEditProductBtn = document.getElementById('cancelEditProductBtn');
      const editingProductIdField = document.getElementById('editingProductId');

      const addAbbrevEl = document.getElementById('addAbbrev');
      const addCodeEl = document.getElementById('addCode');
      const addSpecsEl = document.getElementById('addSpecs');
      const addSkuEl = document.getElementById('addSku');
      const addProductNameEl = document.getElementById('addProductName');
      const addUnitEl = document.getElementById('addUnit');
      const addMinQtyEl = document.getElementById('addMinQty');
      const manageProductsTableBody = document.getElementById('manageProductsTableBody');
      const manageProductsSearch = document.getElementById('manageProductsSearch');
      // const generateProductNameBtn = document.getElementById('generateProductNameBtn'); // Removed
      const aiProductNameStatus = document.getElementById('aiProductNameStatus');

      let currentEditingProductSku = null;

      function updateAddSku() {
        const abbrev = (String(addAbbrevEl ? addAbbrevEl.value : '')).trim();
        const code = (String(addCodeEl ? addCodeEl.value : '')).trim();
        const specs = (String(addSpecsEl ? addSpecsEl.value : '')).trim();
        let sku = '';

        if (abbrev || code || specs) {
          sku = [abbrev, code, specs].filter(s => s).join(''); 
        }
        if (addSkuEl) addSkuEl.value = sku;
      }

      if (addAbbrevEl) addAbbrevEl.addEventListener('input', updateAddSku);
      if (addCodeEl) addCodeEl.addEventListener('input', updateAddSku);
      if (addSpecsEl) addSpecsEl.addEventListener('input', updateAddSku);

      // if (generateProductNameBtn) { // Removed button, so this event listener is also removed
      //   generateProductNameBtn.addEventListener('click', async () => {
      //       const abbrev = (String(addAbbrevEl ? addAbbrevEl.value : '')).trim();
      //       const code = (String(addCodeEl ? addCodeEl.value : '')).trim();
      //       const specs = (String(addSpecsEl ? addSpecsEl.value : '')).trim();

      //       if (!abbrev && !code && !specs) {
      //           if (aiProductNameStatus) aiProductNameStatus.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î", "‡∏£‡∏´‡∏±‡∏™" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏Ç‡∏ô‡∏≤‡∏î, ‡∏™‡∏µ, ‡∏à‡∏≥‡πÄ‡∏û‡∏≤‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ" ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ä‡πà‡∏≠‡∏á';
      //           return;
      //       }

      //       const prompt = `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ:
      //       ${abbrev ? `‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î: ${abbrev}` : ''}
      //       ${code ? `‡∏£‡∏´‡∏±‡∏™: ${code}` : ''}
      //       ${specs ? `‡∏Ç‡∏ô‡∏≤‡∏î, ‡∏™‡∏µ, ‡∏à‡∏≥‡πÄ‡∏û‡∏≤‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ: ${specs}` : ''}
      //       ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô.`;

      //       try {
      //           const generatedName = await callGeminiAPI(prompt, aiProductNameStatus);
      //           if (addProductNameEl && generatedName) {
      //               addProductNameEl.value = generatedName.replace(/"/g, '').trim();
      //           }
      //       } catch (error) {
      //           console.error("Failed to generate product name:", error);
      //       }
      //   });
      // }


      function resetAddProductForm() {
          currentEditingProductSku = null;
          addProductForm.reset();
          updateAddSku();
          if (addProductTitle) addProductTitle.textContent = '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö)'; // Updated title
          if (submitProductBtn) {
              submitProductBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
              submitProductBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
              submitProductBtn.classList.add('bg-green-600', 'hover:bg-green-700');
          }
          if (cancelEditProductBtn) cancelEditProductBtn.classList.add('hidden');
          if (addSkuEl) addSkuEl.readOnly = true;
          if (editingProductIdField) editingProductIdField.value = '';
          if (addProductStatus) addProductStatus.textContent = '';
          if (aiProductNameStatus) aiProductNameStatus.textContent = '';
      }

      function populateProductFormForEdit(product) {
          if (!product) {
              resetAddProductForm();
              return;
          }
          currentEditingProductSku = String(product['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim();
          if (editingProductIdField) editingProductIdField.value = String(product['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim();

          if (addAbbrevEl) addAbbrevEl.value = String(product['‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î'] || '').trim();
          if (addCodeEl) addCodeEl.value = String(product['‡∏£‡∏´‡∏±‡∏™'] || '').trim();
          if (addSpecsEl) addSpecsEl.value = String(product['‡∏Ç‡∏ô‡∏≤‡∏î, ‡∏™‡∏µ, ‡∏à‡∏≥‡πÄ‡∏û‡∏≤‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ'] || '').trim();
          if (addSkuEl) {
              addSkuEl.value = String(product['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || '').trim();
              addSkuEl.readOnly = true;
          }
          if (addProductNameEl) addProductNameEl.value = String(product['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || '').trim();
          if (addUnitEl) addUnitEl.value = String(product['‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö'] || '').trim();
          if (addMinQtyEl) addMinQtyEl.value = String(product['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥'] || '0').trim();

          if (addProductTitle) addProductTitle.textContent = `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${String(product['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim()}`;
          if (submitProductBtn) {
              submitProductBtn.textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
              submitProductBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
              submitProductBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
          }
          if (cancelEditProductBtn) cancelEditProductBtn.classList.remove('hidden');
          if (addProductStatus) addProductStatus.textContent = '';
          if (aiProductNameStatus) aiProductNameStatus.textContent = '';
      }

      if (cancelEditProductBtn) {
          cancelEditProductBtn.addEventListener('click', resetAddProductForm);
      }

      function renderManageProducts(searchQuery = '') {
        if (!manageProductsTableBody) return;
        manageProductsTableBody.innerHTML = '';
        const lowerCaseQuery = searchQuery.toLowerCase().trim();

        const filteredProducts = cache.products.filter(product => {
            const sku = (String(product['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || '')).toLowerCase();
            const name = (String(product['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || '')).toLowerCase();
            return sku.includes(lowerCaseQuery) || name.includes(lowerCaseQuery);
        });

        if (filteredProducts.length === 0) {
          manageProductsTableBody.innerHTML = '<tr><td class="px-4 py-3 text-gray-400" colspan="5">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td></tr>';
          return;
        }

        filteredProducts.forEach(product => {
          const tr = document.createElement('tr');
          tr.className = 'border-t border-gray-700/60';
          tr.innerHTML = `
            <td class="px-4 py-3">${String(product['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || '').trim()}</td>
            <td class="px-4 py-3">${String(product['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || '').trim()}</td>
            <td class="px-4 py-3">${String(product['‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö'] || '').trim()}</td>
            <td class="px-4 py-3 text-right">${Number(product['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥'] || 0).toLocaleString('th-TH')}</td>
            <td class="px-4 py-3 text-center">
              <button class="edit-product-btn px-3 py-1 mr-2 rounded bg-yellow-600 hover:bg-yellow-700 text-white text-xs font-medium" data-sku="${String(product['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || '').trim()}">
                ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
              </button>
              <button class="delete-product-btn px-3 py-1 rounded bg-red-600 hover:bg-red-700 text-white text-xs font-medium" data-sku="${String(product['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || '').trim()}">
                ‡∏•‡∏ö
              </button>
            </td>
          `;
          manageProductsTableBody.appendChild(tr);
        });

        document.querySelectorAll('.edit-product-btn').forEach(button => {
          button.addEventListener('click', (e) => {
            const sku = e.target.dataset.sku;
            const productToEdit = cache.products.find(p => String(p['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim() === sku);
            if (productToEdit) {
              populateProductFormForEdit(productToEdit);
              setActiveTab('add-product');
            }
          });
        });

        document.querySelectorAll('.delete-product-btn').forEach(button => {
          button.addEventListener('click', async (e) => {
            const sku = e.target.dataset.sku;
            const productName = cache.products.find(p => String(p['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim() === sku)?.['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || sku;
            
            const confirmed = await showCustomConfirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ "${String(productName||'').trim()}" ‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`);
            if (confirmed) {
                const payload = {
                    actionType: 'deleteProduct',
                    data: { '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤': sku }
                };
                try {
                    const result = await sendToAppsScript(payload, addProductStatus);
                    loadAll();
                } catch (error) {
                    console.error('Error deleting product:', error);
                }
            }
          });
        });
      }

      if (manageProductsSearch) {
        manageProductsSearch.addEventListener('input', (e) => {
          renderManageProducts(e.target.value);
        });
      }


      if (addProductForm) { 
        addProductForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          if (addProductStatus) addProductStatus.textContent = '';

          const productData = {
            '‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î': (String(addAbbrevEl ? addAbbrevEl.value : '')).trim(),
            '‡∏£‡∏´‡∏±‡∏™': (String(addCodeEl ? addCodeEl.value : '')).trim(),
            '‡∏Ç‡∏ô‡∏≤‡∏î, ‡∏™‡∏µ, ‡∏à‡∏≥‡πÄ‡∏û‡∏≤‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ': (String(addSpecsEl ? addSpecsEl.value : '')).trim(),
            '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤': (String(addSkuEl ? addSkuEl.value : '')).trim(), 
            '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤': (String(addProductNameEl ? addProductNameEl.value : '')).trim(),
            '‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö': (String(addUnitEl ? addUnitEl.value : '')).trim(),
            '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥': parseFloat(addMinQtyEl ? addMinQtyEl.value || '0' : '0'), 
          };

          let payload;
          if (currentEditingProductSku) {
            payload = {
              actionType: 'editProduct',
              data: {
                originalSku: currentEditingProductSku,
                newProductData: productData
              }
            };
          } else {
            payload = {
              actionType: 'addProduct',
              data: productData
            };
          }

          try {
            await sendToAppsScript(payload, addProductStatus);
            loadAll();
            resetAddProductForm();
          } catch(err) {
          }
        });
      }

      // =========================
      // Add/Edit/Delete Vendor Code
      // =========================
      const addVendorForm = document.getElementById('addVendorForm');
      const addVendorStatus = document.getElementById('addVendorStatus');
      const addVendorTitle = document.getElementById('addVendorTitle');
      const submitVendorBtn = document.getElementById('submitVendorBtn');
      const cancelEditVendorBtn = document.getElementById('cancelEditVendorBtn');
      const editingVendorIdField = document.getElementById('editingVendorId');

      const addVendorCodeEl = document.getElementById('addVendorCode');
      const addVendorNameEl = document.getElementById('addVendorName');
      const addVendorAddressEl = document.getElementById('addVendorAddress');
      const addVendorPhoneEl = document.getElementById('addVendorPhone');
      const addVendorRegTypeEl = document.getElementById('addVendorRegType');
      const manageVendorsTableBody = document.getElementById('manageVendorsTableBody');
      const manageVendorsSearch = document.getElementById('manageVendorsSearch');

      let currentEditingVendorCode = null;

      function resetAddVendorForm() {
          currentEditingVendorCode = null;
          addVendorForm.reset();
          if (addVendorCodeEl) addVendorCodeEl.value = cache.nextVendorCode;
          if (addVendorTitle) addVendorTitle.textContent = '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢ (‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö)'; // Updated title
          if (submitVendorBtn) {
              submitVendorBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢';
              submitVendorBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
              submitVendorBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
          }
          if (cancelEditVendorBtn) cancelEditVendorBtn.classList.add('hidden');
          if (addVendorCodeEl) addVendorCodeEl.readOnly = true;
          if (editingVendorIdField) editingVendorIdField.value = '';
          if (addVendorStatus) addVendorStatus.textContent = '';
      }

      function populateVendorFormForEdit(vendor) {
          if (!vendor) {
              resetAddVendorForm();
              return;
          }
          currentEditingVendorCode = String(vendor['‡∏£‡∏´‡∏±‡∏™ Vendors']||'').trim();
          if (editingVendorIdField) editingVendorIdField.value = String(vendor['‡∏£‡∏´‡∏±‡∏™ Vendors']||'').trim();

          if (addVendorCodeEl) addVendorCodeEl.value = String(vendor['‡∏£‡∏´‡∏±‡∏™ Vendors'] || '').trim();
          if (addVendorNameEl) addVendorNameEl.value = String(vendor['Vender'] || '').trim();
          if (addVendorAddressEl) addVendorAddressEl.value = String(vendor['‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà'] || '').trim();
          if (addVendorPhoneEl) addVendorPhoneEl.value = String(vendor['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£'] || '').trim();
          if (addVendorRegTypeEl) addVendorRegTypeEl.value = String(vendor['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏à‡∏î‡∏ó‡∏ö.'] || '').trim();

          if (addVendorTitle) addVendorTitle.textContent = `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢: ${String(vendor['Vender']||'').trim()}`;
          if (submitVendorBtn) {
              submitVendorBtn.textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢';
              submitVendorBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
              submitVendorBtn.classList.add('bg-purple-600', 'hover:bg-purple-700');
          }
          if (cancelEditVendorBtn) cancelEditVendorBtn.classList.remove('hidden');
          if (addVendorStatus) addVendorStatus.textContent = '';
      }

      if (cancelEditVendorBtn) {
          cancelEditVendorBtn.addEventListener('click', resetAddVendorForm);
      }

      function renderManageVendors(searchQuery = '') {
        if (!manageVendorsTableBody) return;
        manageVendorsTableBody.innerHTML = '';
        const lowerCaseQuery = searchQuery.toLowerCase().trim();

        const filteredVendors = cache.vendors.filter(vendor => {
            const code = (String(vendor['‡∏£‡∏´‡∏±‡∏™ Vendors'] || '')).toLowerCase();
            const name = (String(vendor['Vender'] || '')).toLowerCase();
            return code.includes(lowerCaseQuery) || name.includes(lowerCaseQuery);
        });

        if (filteredVendors.length === 0) {
          manageVendorsTableBody.innerHTML = '<tr><td class="px-4 py-3 text-gray-400" colspan="6">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</td></tr>';
          return;
        }

        filteredVendors.forEach(vendor => {
          const tr = document.createElement('tr');
          tr.className = 'border-t border-gray-700/60';
          tr.innerHTML = `
            <td class="px-4 py-3">${String(vendor['‡∏£‡∏´‡∏±‡∏™ Vendors'] || '').trim()}</td>
            <td class="px-4 py-3">${String(vendor['Vender'] || '').trim()}</td>
            <td class="px-4 py-3">${String(vendor['‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà'] || '').trim()}</td>
            <td class="px-4 py-3">${String(vendor['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£'] || '').trim()}</td>
            <td class="px-4 py-3">${String(vendor['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏à‡∏î‡∏ó‡∏ö.'] || '').trim()}</td>
            <td class="px-4 py-3 text-center">
              <button class="edit-vendor-btn px-3 py-1 mr-2 rounded bg-purple-600 hover:bg-purple-700 text-white text-xs font-medium" data-vendor-code="${String(vendor['‡∏£‡∏´‡∏±‡∏™ Vendors'] || '').trim()}">
                ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
              </button>
              <button class="delete-vendor-btn px-3 py-1 rounded bg-red-600 hover:bg-red-700 text-white text-xs font-medium" data-vendor-code="${String(vendor['‡∏£‡∏´‡∏±‡∏™ Vendors'] || '').trim()}">
                ‡∏•‡∏ö
              </button>
            </td>
          `;
          manageVendorsTableBody.appendChild(tr);
        });

        document.querySelectorAll('.edit-vendor-btn').forEach(button => {
          button.addEventListener('click', (e) => {
            const vendorCode = e.target.dataset.vendorCode;
            const vendorToEdit = cache.vendors.find(v => String(v['‡∏£‡∏´‡∏±‡∏™ Vendors']||'').trim() === vendorCode);
            if (vendorToEdit) {
              populateVendorFormForEdit(vendorToEdit);
              setActiveTab('add-vendor');
            }
          });
        });

        document.querySelectorAll('.delete-vendor-btn').forEach(button => {
          button.addEventListener('click', async (e) => {
            const vendorCode = e.target.dataset.vendorCode;
            const vendorName = cache.vendors.find(v => String(v['‡∏£‡∏´‡∏±‡∏™ Vendors']||'').trim() === vendorCode)?.['Vender'] || vendorCode;
            
            const confirmed = await showCustomConfirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢ "${String(vendorName||'').trim()}" ‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`);
            if (confirmed) {
                const payload = {
                    actionType: 'deleteVendor',
                    data: { '‡∏£‡∏´‡∏±‡∏™ Vendors': vendorCode }
                };
                try {
                    const result = await sendToAppsScript(payload, addVendorStatus);
                    loadAll();
                } catch (error) {
                    console.error('Error deleting vendor:', error);
                }
            }
          });
        });
      }

      if (manageVendorsSearch) {
        manageVendorsSearch.addEventListener('input', (e) => {
          renderManageVendors(e.target.value);
        });
      }


      if (addVendorForm) { 
        addVendorForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (addVendorStatus) addVendorStatus.textContent = '';

            const vendorData = {
                '‡∏£‡∏´‡∏±‡∏™ Vendors': (String(addVendorCodeEl ? addVendorCodeEl.value : '')).trim(), 
                'Vender': (String(addVendorNameEl ? addVendorNameEl.value : '')).trim(),
                '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà': (String(addVendorAddressEl ? addVendorAddressEl.value : '')).trim(),
                '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£': (String(addVendorPhoneEl ? addVendorPhoneEl.value : '')).trim(), 
                '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏à‡∏î‡∏ó‡∏ö.': (String(addVendorRegTypeEl ? addVendorRegTypeEl.value : '')).trim()
            };

            let payload;
            if (currentEditingVendorCode) {
                payload = {
                    actionType: 'editVendor',
                    data: {
                        originalVendorCode: currentEditingVendorCode,
                        newVendorData: vendorData
                    }
                };
            } else {
                payload = {
                    actionType: 'addVendor',
                    data: vendorData
                };
            }
            
            try {
                await sendToAppsScript(payload, addVendorStatus);
                loadAll(); 
                resetAddVendorForm();
            } catch(err) {
            }
        });
      }


      // =========================
      // Add/Edit/Delete Project Code
      // =========================
      const addProjectForm = document.getElementById('addProjectForm');
      const addProjectStatus = document.getElementById('addProjectStatus');
      const addProjectTitle = document.getElementById('addProjectTitle');
      const submitProjectBtn = document.getElementById('submitProjectBtn');
      const cancelEditProjectBtn = document.getElementById('cancelEditProjectBtn');
      const editingProjectIdField = document.getElementById('editingProjectId');
      const addProjectCustomerEl = document.getElementById('addProjectCustomer');
      const addProjectNameEl = document.getElementById('addProjectName');
      const addProjectShortNameEl = document.getElementById('addProjectShortName');
      const addProjectCodeNumEl = document.getElementById('addProjectCodeNum');
      const addProjectTypeEl = document.getElementById('addProjectType');
      const addProjectCodeTextEl = document.getElementById('addProjectCodeText');
      const addProjectPhaseEl = document.getElementById('addProjectPhase');
      const addProjectAlleyEl = document.getElementById('addProjectAlley');
      const addProjectHouseNoEl = document.getElementById('addProjectHouseNo');
      const addProjectDetailEl = document.getElementById('addProjectDetail');
      const addProjectCombinedCodeEl = document.getElementById('addProjectCombinedCode');
      const manageProjectsTableBody = document.getElementById('manageProjectsTableBody');
      const manageProjectsSearch = document.getElementById('manageProjectsSearch');
      const aiProjectDetailStatus = document.getElementById('aiProjectDetailStatus');

      let currentEditingProjectCombinedCode = null;

      // Helper function to pad numbers with leading zeros to 3 digits (NO LONGER USED FOR addProjectCodeNum)
      function padThreeDigits(num) {
          // This function is now mostly for illustrative purposes or if other fields might need it.
          // For addProjectCodeNum, padding is removed as per user request.
          let strNum = String(num);
          if (!isNaN(parseInt(strNum)) && strNum.length < 3) {
            return strNum.padStart(3, '0');
          }
          return strNum;
      }

      function updateProjectCombinedCode() {
        const customer = (String(addProjectCustomerEl?.value || '')).trim();
        const codeNum = (String(addProjectCodeNumEl?.value || '')).trim();
        const phase = (String(addProjectPhaseEl?.value || '')).trim();
        const alley = (String(addProjectAlleyEl?.value || '')).trim();
        const houseNo = (String(addProjectHouseNoEl?.value || '')).trim(); 

        const parts = [customer, codeNum, phase, alley, houseNo].filter(s => s).join('-');
        if (addProjectCombinedCodeEl) addProjectCombinedCodeEl.value = parts;
      }

      // NEW: Event listener for addProjectCodeNum to only remove non-digit characters
      if (addProjectCodeNumEl) {
        addProjectCodeNumEl.addEventListener('input', (event) => {
            let value = event.target.value;
            // Remove non-digit characters, but DO NOT limit length
            value = value.replace(/\D/g, '');
            event.target.value = value;
            updateProjectCombinedCode(); // Update combined code after filtering characters
        });

        // ‡∏•‡∏ö blur event ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏¥‡∏° 0 ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å‡∏Å‡∏µ‡πà‡∏ï‡∏±‡∏ß‡∏Å‡πá‡πÑ‡∏î‡πâ
        // addProjectCodeNumEl.addEventListener('blur', (event) => { /* Removed */ });
      }


      if (addProjectCustomerEl) addProjectCustomerEl.addEventListener('input', updateProjectCombinedCode);
      if (addProjectPhaseEl) addProjectPhaseEl.addEventListener('input', updateProjectCombinedCode);
      if (addProjectAlleyEl) addProjectAlleyEl.addEventListener('input', updateProjectCombinedCode);
      if (addProjectHouseNoEl) addProjectHouseNoEl.addEventListener('input', updateProjectCombinedCode);

      function resetAddProjectForm() {
          currentEditingProjectCombinedCode = null;
          addProjectForm.reset();
          if (addProjectCodeNumEl) addProjectCodeNumEl.value = ''; // Clear value
          updateProjectCombinedCode(); // Update combined code
          if (addProjectTitle) addProjectTitle.textContent = '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö)'; // Updated title
          if (submitProjectBtn) {
              submitProjectBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£';
              submitProjectBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
              submitProjectBtn.classList.add('bg-purple-600', 'hover:bg-purple-700');
          }
          if (cancelEditProjectBtn) cancelEditProjectBtn.classList.add('hidden');
          if (addProjectCodeNumEl) addProjectCodeNumEl.readOnly = false; // Ensure it's editable
          if (addProjectCombinedCodeEl) addProjectCombinedCodeEl.readOnly = true; // Keep combined code readonly
          if (editingProjectIdField) editingProjectIdField.value = '';
          if (addProjectStatus) addProjectStatus.textContent = '';
          if (aiProjectDetailStatus) aiProjectDetailStatus.textContent = '';
      }

      function populateProjectFormForEdit(project) {
          if (!project) {
              resetAddProjectForm();
              return;
          }
          currentEditingProjectCombinedCode = String(project['‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∏‡∏î']||'').trim();
          if (editingProjectIdField) editingProjectIdField.value = String(project['‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∏‡∏î']||'').trim();
          if (addProjectCustomerEl) addProjectCustomerEl.value = String(project['Customer'] || '').trim();
          if (addProjectNameEl) addProjectNameEl.value = String(project['‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£'] || '').trim();
          if (addProjectShortNameEl) addProjectShortNameEl.value = String(project['‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠'] || '').trim();
          if (addProjectHouseNoEl) addProjectHouseNoEl.value = String(project['‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà'] || '').trim();
          if (addProjectCodeNumEl) {
            // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ '‡∏£‡∏´‡∏±‡∏™' ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£ padding
            addProjectCodeNumEl.value = String(project['‡∏£‡∏´‡∏±‡∏™'] || '').trim();
            addProjectCodeNumEl.readOnly = false; // Ensure it's editable when editing an existing project
          }
          if (addProjectTypeEl) addProjectTypeEl.value = String(project['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó'] || '').trim();
          if (addProjectCodeTextEl) addProjectCodeTextEl.value = String(project['CODE'] || '').trim();
          if (addProjectPhaseEl) addProjectPhaseEl.value = String(project['‡πÄ‡∏ü‡∏™'] || '').trim();
          if (addProjectAlleyEl) addProjectAlleyEl.value = String(project['‡∏ã‡∏≠‡∏¢'] || '').trim();
          if (addProjectHouseNoEl) addProjectHouseNoEl.value = String(project['‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà'] || '').trim();
          if (addProjectDetailEl) addProjectDetailEl.value = String(project['‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'] || '').trim();
          if (addProjectCombinedCodeEl) {
            addProjectCombinedCodeEl.value = String(project['‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∏‡∏î'] || '').trim();
            addProjectCombinedCodeEl.readOnly = true;
          }

          if (addProjectTitle) addProjectTitle.textContent = `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£: ${String(project['‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£']||'').trim()}`;
          if (submitProjectBtn) {
              submitProjectBtn.textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£';
              submitProjectBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
              submitProjectBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
          }
          if (cancelEditProjectBtn) cancelEditProjectBtn.classList.remove('hidden');
          if (addProjectStatus) addProjectStatus.textContent = '';
          if (aiProjectDetailStatus) aiProjectDetailStatus.textContent = '';
      }

      if (cancelEditProjectBtn) {
          cancelEditProjectBtn.addEventListener('click', resetAddProjectForm);
      }

      function renderManageProjects(searchQuery = '') {
        if (!manageProjectsTableBody) return;
        manageProjectsTableBody.innerHTML = '';
        const lowerCaseQuery = searchQuery.toLowerCase().trim();

        const filteredProjects = cache.projects.filter(project => {
            const code = (String(project['‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∏‡∏î'] || '')).toLowerCase();
            const name = (String(project['‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£'] || '')).toLowerCase();
            const customer = (String(project['Customer'] || '')).toLowerCase();
            const shortName = (String(project['‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠'] || '')).toLowerCase();
            const codeNum = (String(project['‡∏£‡∏´‡∏±‡∏™'] || '')).toLowerCase();
            const type = (String(project['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó'] || '')).toLowerCase();
            const CODE = (String(project['CODE'] || '')).toLowerCase();
            const phase = (String(project['‡πÄ‡∏ü‡∏™'] || '')).toLowerCase();
            const alley = (String(project['‡∏ã‡∏≠‡∏¢'] || '')).toLowerCase();
            const houseNo = (String(project['‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà'] || '')).toLowerCase 
            return code.includes(lowerCaseQuery) || name.includes(lowerCaseQuery) || customer.includes(lowerCaseQuery) || shortName.includes(lowerCaseQuery);
        });

        if (filteredProjects.length === 0) {
          manageProjectsTableBody.innerHTML = '<tr><td class="px-4 py-3 text-gray-400" colspan="4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</td></tr>';
          return;
        }

        filteredProjects.forEach(project => {
          const tr = document.createElement('tr');
          tr.className = 'border-t border-gray-700/60';
          tr.innerHTML = `
            <td class="px-4 py-3">${String(project['‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∏‡∏î'] || '').trim()}</td>
            <td class="px-4 py-3">${String(project['‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£'] || '').trim()}</td>
            <td class="px-4 py-3">${String(project['Customer'] || '').trim()}</td>
            <td class="px-4 py-3">${String(project['‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠'] || '').trim()}</td>
            <td class="px-4 py-3">${String(project['‡∏£‡∏´‡∏±‡∏™'] || '').trim()}</td>
            <td class="px-4 py-3">${String(project['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó'] || '').trim()}</td>
            <td class="px-4 py-3">${String(project['CODE'] || '').trim()}</td>
            <td class="px-4 py-3">${String(project['‡πÄ‡∏ü‡∏™'] || '').trim()}</td>
            <td class="px-4 py-3">${String(project['‡∏ã‡∏≠‡∏¢'] || '').trim()}</td>
            <td class="px-4 py-3">${String(project['‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà'] || '').trim()}</td>
            <td class="px-4 py-3 text-center">
              <button class="edit-project-btn px-3 py-1 mr-2 rounded bg-purple-600 hover:bg-purple-700 text-white text-xs font-medium" data-project-code="${String(project['‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∏‡∏î'] || '').trim()}">
                ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
              </button>
              <button class="delete-project-btn px-3 py-1 rounded bg-red-600 hover:bg-red-700 text-white text-xs font-medium" data-project-code="${String(project['‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∏‡∏î'] || '').trim()}">
                ‡∏•‡∏ö
              </button>
            </td>
          `;
          manageProjectsTableBody.appendChild(tr);
        });

        document.querySelectorAll('.edit-project-btn').forEach(button => {
          button.addEventListener('click', (e) => {
            const projectCode = e.target.dataset.projectCode;
            const projectToEdit = cache.projects.find(p => String(p['‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∏‡∏î']||'').trim() === projectCode);
            if (projectToEdit) {
              populateProjectFormForEdit(projectToEdit);
              setActiveTab('add-project');
            }
          });
        });

        document.querySelectorAll('.delete-project-btn').forEach(button => {
          button.addEventListener('click', async (e) => {
            const projectCode = e.target.dataset.projectCode;
            const projectName = cache.projects.find(p => String(p['‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∏‡∏î']||'').trim() === projectCode)?.['‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£'] || projectCode;
            
            const confirmed = await showCustomConfirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ "${String(projectName||'').trim()}" ‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`);
            if (confirmed) {
                const payload = {
                    actionType: 'deleteProject',
                    data: { '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∏‡∏î': projectCode }
                };
                try {
                    const result = await sendToAppsScript(payload, addProjectStatus);
                    loadAll();
                } catch (error) {
                    console.error('Error deleting project:', error);
                }
            }
          });
        });
      }

      if (manageProjectsSearch) {
        manageProjectsSearch.addEventListener('input', (e) => {
          renderManageProjects(e.target.value);
        });
      }
      function exportVendorHistoryToExcel(vendor) {
        const purchases = (cache.lots || []).filter(lot => 
        String(lot['‡∏£‡∏´‡∏±‡∏™ Vender'] || '').trim() === String(vendor['‡∏£‡∏´‡∏±‡∏™ Vendors'] || '').trim()
    );
    if (purchases.length === 0) {
        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Å‡∏±‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ');
        return;
    }
    const header = ['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ (‡∏ö‡∏≤‡∏ó)', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠'];
    const rows = purchases.map(lot => [
        `"${String(lot['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || '')}"`, // <<-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        `"${(lot['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').replace(/"/g, '""')}"`,
        Number(lot['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠']||0),
        Number(lot['‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°']||0).toFixed(2),
        lot['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']||''
    ]);
    const csvContent = '\uFEFF' + [header, ...rows].map(r => r.join(',')).join('\r\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠_${vendor['Vender']||vendor['‡∏£‡∏´‡∏±‡∏™ Vendors']}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
function renderVendorMultiSelect() {
  const select = document.getElementById('vendorMultiSelect');
  if (!select) return;
  select.innerHTML = '';
  cache.vendors.forEach(v => {
    const opt = document.createElement('option');
    opt.value = String(v['‡∏£‡∏´‡∏±‡∏™ Vendors'] || '').trim();
    opt.textContent = `${String(v['‡∏£‡∏´‡∏±‡∏™ Vendors'] || '').trim()} ‚Äî ${String(v['Vender'] || '').trim()}`;
    select.appendChild(opt);
  });
}

function showMultiVendorPurchaseModal(vendorCodes) {
  const modal = document.getElementById('vendorPurchaseModal');
  const title = document.getElementById('vendorPurchaseModalTitle');
  const list = document.getElementById('vendorPurchaseList');
  if (!modal || !title || !list) return;

  // ‡∏£‡∏ß‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢
  const names = vendorCodes.map(code => {
    const v = cache.vendors.find(v => String(v['‡∏£‡∏´‡∏±‡∏™ Vendors']||'').trim() === code);
    return v ? `${v['Vender']} (${v['‡∏£‡∏´‡∏±‡∏™ Vendors']})` : code;
  }).join(', ');

  title.textContent = `‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Å‡∏±‡∏ö: ${names}`;

  // ‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å vendor ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡πÑ‡∏°‡πà filter ‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠)
  const purchases = (cache.lots || []).filter(lot =>
    vendorCodes.includes(String(lot['‡∏£‡∏´‡∏±‡∏™ Vender'] || '').trim())
  );

  if (purchases.length === 0) {
    list.innerHTML = `<div class="text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>`;
  } else {
    list.innerHTML = purchases.map(lot => `
      <div class="bg-gray-700 border border-gray-600 rounded-md p-3">
        <div><span class="font-bold text-white">${lot['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']}</span></div>
        <div class="text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: <span class="text-blue-300">${Number(lot['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠']||0).toLocaleString('th-TH')}</span> | 
          ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤: <span class="text-green-300">${Number(lot['‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°']||0).toLocaleString('th-TH', {minimumFractionDigits:2})} ‡∏ö‡∏≤‡∏ó</span>
        </div>
        <div class="text-xs text-gray-400">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠: ${lot['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] || '-'}</div>
      </div>
    `).join('');
  }
  modal.classList.remove('hidden');
}
      if (addProjectForm) { 
        addProjectForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (addProjectStatus) addProjectStatus.textContent = '';
            const projectData = {
                'Customer': (String(addProjectCustomerEl?.value || '')).trim(),
                '‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£': (String(addProjectNameEl?.value || '')).trim(),
                '‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠': (String(addProjectShortNameEl?.value || '')).trim(),
                '‡∏£‡∏´‡∏±‡∏™': (String(addProjectCodeNumEl?.value || '')).trim(), // ‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô String ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏Å
                '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó': (String(addProjectTypeEl?.value || '')).trim(),
                'CODE': (String(addProjectCodeTextEl?.value || '')).trim(),
                '‡πÄ‡∏ü‡∏™': (String(addProjectPhaseEl?.value || '')).trim(),
                '‡∏ã‡∏≠‡∏¢': (String(addProjectAlleyEl?.value || '')).trim(),
                '‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà': (String(addProjectHouseNoEl?.value || '')).trim(),
                '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î': (String(addProjectDetailEl?.value || '')).trim(),
                '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∏‡∏î': (String(addProjectCombinedCodeEl?.value || '')).trim()
            };
            
            let payload;
            if (currentEditingProjectCombinedCode) {
              payload = {
                actionType: 'editProject',
                data: {
                  originalProjectCode: currentEditingProjectCombinedCode,
                  newProjectData: projectData
                }
              };
            } else {
              payload = {
                actionType: 'addProject',
                data: projectData // Send projectData with manually entered '‡∏£‡∏´‡∏±‡∏™'
              };
            }

          try {
            await sendToAppsScript(payload, addProjectStatus);
            loadAll();
            resetAddProjectForm();
          } catch (err) {

          }
        });
      }
      // =========================
      // Project Expenditure Report Code
      // =========================
      const dashboardProjectExpenditureSelect = document.getElementById('dashboardProjectExpenditureSelect');
      const projectReportProductSearch = document.getElementById('projectReportProductSearch'); // New search input
      const viewProjectExpenditureBtn = document.getElementById('viewProjectExpenditureBtn');
      const projectExpenditureResult = document.getElementById('projectExpenditureResult');
      const exportProjectExpenditureBtn = document.getElementById('exportProjectExpenditureBtn');
      
      if (viewProjectExpenditureBtn) { 
        viewProjectExpenditureBtn.addEventListener('click', async () => {
            if (projectExpenditureResult) projectExpenditureResult.innerHTML = `<span class="inline-flex items-center gap-2 text-gray-200"><span class="w-4 h-4 border-2 border-white/60 border-t-transparent rounded-full spin"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>`;
            
            const productSearchQuery = (String(projectReportProductSearch ? projectReportProductSearch.value : '')).toLowerCase().trim(); // Get search query

            if (!projectCode) {
                if (projectExpenditureResult) projectExpenditureResult.innerHTML = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£';
                return;
            }

            try {
                const payload = {
                    actionType: 'getDashboardProjectExpenditure',
                    data: { projectCode: projectCode }
                };
                const result = await sendToAppsScript(payload, projectExpenditureResult);
                if (result && result.projectExpenditure) {
                    const expenditure = result.projectExpenditure;
                    let itemsListHtml = '<ul class="list-disc list-inside text-xs mt-2">';
                    if (exportProjectExpenditureBtn) exportProjectExpenditureBtn.classList.remove('hidden'); // <<-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ

                    // Filter itemsIssued based on productSearchQuery
                    const filteredItems = expenditure.itemsIssued.filter(item => {
                        const productName = (String(item.productName || '')).toLowerCase();
                        const productCode = (String(item.productCode || '')).toLowerCase();
                        return productName.includes(productSearchQuery) || productCode.includes(productSearchQuery);
                    });

                    if (filteredItems && filteredItems.length > 0) {
                        filteredItems.forEach(item => {
                            itemsListHtml += `<li>${String(item.productName||'').trim()} (${String(item.productCode||'').trim()}): ${Number(item.qty).toLocaleString('th-TH')} ‡∏ä‡∏¥‡πâ‡∏ô (‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ ${Number(item.value).toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó)</li>`;
                        });
                    } else {
                        itemsListHtml += `<li>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ${productSearchQuery ? ` (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "${productSearchQuery}")` : ''}</li>`;
                    }
                    itemsListHtml += '</ul>';

                    if (projectExpenditureResult) { 
                        projectExpenditureResult.innerHTML = `
                            <div class="font-medium text-cyan-400">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£: ${String(expenditure.projectCode||'').trim()}</div>
                            <div class="mt-2">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å‡πÑ‡∏õ: <span class="text-blue-400 font-bold text-lg">${Number(expenditure.totalProjectCost).toLocaleString('th-TH', {minimumFractionDigits: 2})}</span> ‡∏ö‡∏≤‡∏ó</div>
                            <div class="mt-3 text-sm text-gray-300">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å:</div>
                            ${itemsListHtml}
                        `;
                    }
                } else {
                    if (projectExpenditureResult) projectExpenditureResult.innerHTML = `<span class="text-red-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</span>`;
                }
            } catch (error) {
                if (projectExpenditureResult) projectExpenditureResult.innerHTML = `<span class="text-red-400">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ'}</span>`;
            }
        });
        if (exportProjectExpenditureBtn) {
          exportProjectExpenditureBtn.addEventListener('click', async () => {
            const productSearchQuery = (String(projectReportProductSearch ? projectReportProductSearch.value : '')).toLowerCase().trim();
        
            if (!projectCode) {
              alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel');
              return;
            }
        
            try {
              const payload = {
                actionType: 'getDashboardProjectExpenditure',
                data: { projectCode: projectCode }
              };
              const result = await sendToAppsScript(payload);
              if (result && result.projectExpenditure) {
                const expenditure = result.projectExpenditure;
                // Filter itemsIssued ‡∏ï‡∏≤‡∏° productSearchQuery ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π
                const filteredItems = expenditure.itemsIssued.filter(item => {
                  const productName = (String(item.productName || '')).toLowerCase();
                  const productCode = (String(item.productCode || '')).toLowerCase();
                  return productName.includes(productSearchQuery) || productCode.includes(productSearchQuery);
                });
        
                const header = ['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å', '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)'];
                const rows = filteredItems.map(item => [
                  `"${String(item.productCode||'')}"`,
                  `"${String(item.productName||'')}"`,
                  Number(item.qty||0),
                  Number(item.value||0).toFixed(2)
                ]);
                const csvContent = '\uFEFF' + [header, ...rows].map(r => r.join(',')).join('\r\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£_${projectCode}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
              } else {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ');
              }
            } catch (error) {
              alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel');
            }
          });
        }
      }


      // Initial load
    loadAll();
    loadAll().then(() => {
      populateProductDatalist();
      populateVendorDatalist();
      populateIssueProductDatalist();
      populateIssueProjectDatalist();
      // ...‡∏≠‡∏∑‡πà‡∏ô‡πÜ...
    });
            // ‡∏´‡∏•‡∏±‡∏á loadAll() ‡πÄ‡∏™‡∏£‡πá‡∏à
      loadAll().then(() => {
        renderBudgetEstimate();
      });
      const selectAllBudgetEstimate = document.getElementById('selectAllBudgetEstimate');
      const exportSelectedBudgetEstimateBtn = document.getElementById('exportSelectedBudgetEstimateBtn');
      
      function updateExportBudgetEstimateButtonVisibility() {
        const checked = document.querySelectorAll('.budget-estimate-checkbox:checked');
        if (exportSelectedBudgetEstimateBtn) exportSelectedBudgetEstimateBtn.classList.toggle('hidden', checked.length === 0);
      }
      
      let selectedBudgetEstimateIds = new Set();
      document.addEventListener('change', function(e) {
        if (e.target.classList.contains('budget-estimate-checkbox')) {
          const lotId = e.target.value;
          if (e.target.checked) {
            selectedBudgetEstimateIds.add(lotId);
          } else {
            selectedBudgetEstimateIds.delete(lotId);
          }
          updateExportBudgetEstimateButtonVisibility();
        }
        if (e.target.id === 'selectAllBudgetEstimate') {
          const checked = e.target.checked;
          document.querySelectorAll('.budget-estimate-checkbox').forEach(cb => {
            cb.checked = checked;
            if (checked) {
              selectedBudgetEstimateIds.add(cb.value);
            } else {
              selectedBudgetEstimateIds.delete(cb.value);
            }
          });
          updateExportBudgetEstimateButtonVisibility();
        }
      });
      // ...‡∏´‡∏•‡∏±‡∏á renderBudgetEstimate() ‡πÅ‡∏•‡∏∞ updateExportBudgetEstimateButtonVisibility()...

      if (exportSelectedBudgetEstimateBtn) {
        exportSelectedBudgetEstimateBtn.addEventListener('click', function() {
          const selectedLots = (cache.lots || []).filter(lot => selectedBudgetEstimateIds.has(lot.lotId));
          if (selectedLots.length === 0) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel');
            return;
          }
          exportBudgetEstimateToExcel(selectedLots);
        });
      }
      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel
            function exportBudgetEstimateToExcel(lots) {
        // ‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        const groupByProduct = {};
        lots.forEach(lot => {
          const code = lot['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || '-';
          if (!groupByProduct[code]) groupByProduct[code] = [];
          groupByProduct[code].push(lot);
        });
      
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á summary rows
        const summaryRows = [];
        Object.entries(groupByProduct).forEach(([code, items]) => {
          const name = items[0]['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || '-';
          const totalQty = items.reduce((sum, l) => sum + (+l['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠'] || 0), 0);
          const totalValue = items.reduce((sum, l) => sum + (+l['‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°'] || 0), 0);
          const prices = items.map(l => +l['‡∏£‡∏≤‡∏Ñ‡∏≤'] || 0).filter(p => p > 0);
          const minPrice = prices.length ? Math.min(...prices) : 0;
          const maxPrice = prices.length ? Math.max(...prices) : 0;
          const avgPrice = totalQty > 0 ? (totalValue / totalQty) : 0;
          const count = items.length;
          const remain = items.reduce((sum, l) => sum + (+l['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠'] || 0), 0);
          summaryRows.push([
            code,
            name,
            totalQty,
            totalValue.toFixed(2),
            avgPrice.toFixed(2),
            minPrice.toFixed(2),
            maxPrice.toFixed(2),
            count,
            remain
          ]);
        });
      
        // Header
        const header = [
          '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
          '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
          '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
          '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
          '‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (Average)',
          '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î (Min)',
          '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (Max)',
          '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠',
          '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠'
        ];
      
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå CSV
        const csvContent = '\uFEFF' + [header, ...summaryRows].map(r => r.join(',')).join('\r\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      //‡∏à‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel

      const budgetEstimateProductSearch = document.getElementById('budgetEstimateProductSearch');
      const budgetEstimateVendorSearch = document.getElementById('budgetEstimateVendorSearch');
      const budgetEstimateProjectSearch = document.getElementById('budgetEstimateProjectSearch');
      const budgetEstimateSummary = document.getElementById('budgetEstimateSummary');
      const budgetEstimateTableBody = document.getElementById('budgetEstimateTableBody');

      if (budgetEstimateProductSearch) {
        budgetEstimateProductSearch.addEventListener('input', () => renderBudgetEstimate());
      }
      if (budgetEstimateVendorSearch) {
        budgetEstimateVendorSearch.addEventListener('input', () => renderBudgetEstimate());
      }
      if (budgetEstimateProjectSearch) {
        budgetEstimateProjectSearch.addEventListener('input', () => renderBudgetEstimate());
      }
      function renderBudgetEstimate(query = '') {
        const qProduct = (budgetEstimateProductSearch?.value || '').toLowerCase().trim();
        const qVendor = (budgetEstimateVendorSearch?.value || '').toLowerCase().trim();
        const qProject = (budgetEstimateProjectSearch?.value || '').toLowerCase().trim();
        
        const filteredLots = (cache.lots || []).filter(lot => {
          const productCode = String(lot['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || '').toLowerCase();
          const productName = String(lot['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || '').toLowerCase();
          const vendorCode = String(lot['‡∏£‡∏´‡∏±‡∏™ Vender'] || '').toLowerCase();
          const vendorObj = cache.vendors.find(v => String(v['‡∏£‡∏´‡∏±‡∏™ Vendors']||'').trim() === String(lot['‡∏£‡∏´‡∏±‡∏™ Vender']||'').trim());
          const vendorName = vendorObj ? String(vendorObj['Vender'] || '').toLowerCase() : '';
          const projectShort = String(lot['‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠'] || '').toLowerCase();
          const projectPhase = String(lot['‡πÄ‡∏ü‡∏™'] || '').toLowerCase();
          const projectAlley = String(lot['‡∏ã‡∏≠‡∏¢'] || '').toLowerCase();
          const projectHouseNo = String(lot['‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà'] || '').toLowerCase();
          const projectCode = String(lot['‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∏‡∏î'] || '').toLowerCase();
          
          const productMatch = !qProduct || productCode.includes(qProduct) || productName.includes(qProduct);
          const vendorMatch = !qVendor || vendorCode.includes(qVendor) || vendorName.includes(qVendor);
          const projectMatch = !qProject ||
            projectShort.includes(qProject) ||
            projectPhase.includes(qProject) ||
            projectAlley.includes(qProject) ||
            projectHouseNo.includes(qProject) ||
            projectCode.includes(qProject);
          return productMatch && vendorMatch && projectMatch;

        });

        if (filteredLots.length === 0) {
          budgetEstimateTableBody.innerHTML = '<tr><td class="px-4 py-3 text-gray-400" colspan="6">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ</td></tr>';
          budgetEstimateSummary.innerHTML = '';
          return;
        }
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
        const totalQty = filteredLots.reduce((sum, lot) => sum + (+lot['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠'] || 0), 0);
        const totalValue = filteredLots.reduce((sum, lot) => sum + (+lot['‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°'] || 0), 0);
        const prices = filteredLots.map(lot => +lot['‡∏£‡∏≤‡∏Ñ‡∏≤'] || 0).filter(p => p > 0);
        const minPrice = prices.length ? Math.min(...prices) : 0;
        const maxPrice = prices.length ? Math.max(...prices) : 0;
        const avgPrice = totalQty > 0 ? (totalValue / totalQty) : 0;
        const totalRemain = filteredLots.reduce((sum, lot) => sum + (+lot['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠'] || 0), 0);
      
        budgetEstimateSummary.innerHTML = `
          <div>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span class="text-blue-400 font-bold">${totalQty.toLocaleString('th-TH')}</span> ‡∏´‡∏ô‡πà‡∏ß‡∏¢</div>
          <div>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span class="text-green-400 font-bold">${totalValue.toLocaleString('th-TH', {minimumFractionDigits:2})}</span> ‡∏ö‡∏≤‡∏ó</div>
          <div>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <span class="text-green-400 font-bold">${totalRemain.toLocaleString('th-TH')}</span> ‡∏´‡∏ô‡πà‡∏ß‡∏¢</div>
          <div>‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (Average): <span class="text-yellow-400 font-bold">${avgPrice.toLocaleString('th-TH', {minimumFractionDigits:2})}</span> ‡∏ö‡∏≤‡∏ó/‡∏´‡∏ô‡πà‡∏ß‡∏¢</div>
          <div>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î (Min): <span class="text-green-400 font-bold">${minPrice.toLocaleString('th-TH', {minimumFractionDigits:2})}</span> ‡∏ö‡∏≤‡∏ó/‡∏´‡∏ô‡πà‡∏ß‡∏¢</div>
          <div>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (Max): <span class="text-red-400 font-bold">${maxPrice.toLocaleString('th-TH', {minimumFractionDigits:2})}</span> ‡∏ö‡∏≤‡∏ó/‡∏´‡∏ô‡πà‡∏ß‡∏¢</div>
          <div>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠: <span class="text-cyan-400 font-bold">${filteredLots.length}</span> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
        `;
        function getVendorName(vendorCode) {
          const v = cache.vendors.find(v => String(v['‡∏£‡∏´‡∏±‡∏™ Vendors']||'').trim() === String(vendorCode||'').trim());
          return v ? v['Vender'] : (vendorCode || '-');
        }
        
        function getVendorName(vendorCode) {
          const v = cache.vendors.find(v => String(v['‡∏£‡∏´‡∏±‡∏™ Vendors']||'').trim() === String(vendorCode||'').trim());
          return v ? v['Vender'] : (vendorCode || '-');
        }

        function formatDateOnly(dateStr) {
          if (!dateStr) return '-';
          let d = dateStr;
          if (dateStr.includes('T')) d = dateStr.split('T')[0];
          if (/^\d{4}-\d{2}-\d{2}$/.test(d)) {
            const [y, m, day] = d.split('-');
            return `${day}/${m}/${y}`;
          } 
          return d;
}
        console.log(filteredLots);
        const summaryRow = `
          
        `;
        budgetEstimateTableBody.innerHTML =
        summaryRow +
        filteredLots.map((lot, idx) =>`
          <tr>
            <td class="px-4 py-3 text-center">
              <input type="checkbox" class="budget-estimate-checkbox" value="${lot.lotId}" ${selectedBudgetEstimateIds.has(lot.lotId) ? 'checked' : ''}>
            </td>
            <td class="px-4 py-3">${formatDateOnly(lot['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'])}</td>
            <td class="px-4 py-3">${lot['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || '-'}</td>
            <td class="px-4 py-3">${lot['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || '-'}</td>
            <td class="px-4 py-3">${Number(lot['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠'] || 0).toLocaleString('th-TH')}</td>
            <td class="px-4 py-3">${Number(lot['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠'] || 0).toLocaleString('th-TH')}</td>
            <td class="px-4 py-3">${Number(lot['‡∏£‡∏≤‡∏Ñ‡∏≤'] || 0).toLocaleString('th-TH', {minimumFractionDigits:2})}</td>
            <td class="px-4 py-3">${Number(lot['‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°'] || 0).toLocaleString('th-TH', {minimumFractionDigits:2})}</td>
            <td class="px-4 py-3">${getVendorName(lot['‡∏£‡∏´‡∏±‡∏™ Vender'])}</td>
          </tr>
        
        `).join('');
        filteredLots.map((lot, idx) => `
          <tr>
            <td class="px-4 py-3 text-center">
              <input type="checkbox" class="budget-estimate-checkbox" value="${lot.lotId}" ${selectedBudgetEstimateIds.has(lot.lotId) ? 'checked' : ''}>
            </td>
            <!-- ...‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÜ... -->
          </tr>
        `).join('');
        // ...existing code...
      }
            // ...‡∏´‡∏•‡∏±‡∏á loadAll() ‡πÅ‡∏•‡πâ‡∏ß...
      function renderProjectMultiSelect() {
        const box = document.getElementById('projectMultiSelect');
        const search = document.getElementById('projectMultiSearch');
        if (!box) return;
        const q = (search?.value || '').toLowerCase();
        box.innerHTML = '';
        cache.projects
          .filter(p => !q || (String(p['‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£']||'').toLowerCase().includes(q) || String(p['‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∏‡∏î']||'').toLowerCase().includes(q)))
          .forEach(p => {
            const id = String(p['‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∏‡∏î']||'').trim();
            const label = `${id} ‚Äî ${String(p['‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£']||'').trim()}${p['‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠']?' ('+String(p['‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠']||'').trim()+')':''}`;
            box.innerHTML += `<label class="flex items-center gap-2"><input type="checkbox" class="project-multi-checkbox" value="${id}"> ${label}</label>`;
          });
      }
      let selectedProjectReportProductIds = new Set();
            document.addEventListener('change', function(e) {
        if (e.target.classList.contains('product-multi-checkbox')) {
          const productId = e.target.value;
          if (e.target.checked) {
            selectedProjectReportProductIds.add(productId);
          } else {
            selectedProjectReportProductIds.delete(productId);
          }
        }
        if (e.target.id === 'selectAllProducts') {
          const checked = e.target.checked;
          document.querySelectorAll('.product-multi-checkbox').forEach(cb => {
            cb.checked = checked;
            if (checked) {
              selectedProjectReportProductIds.add(cb.value);
            } else {
              selectedProjectReportProductIds.delete(cb.value);
            }
          });
        }
      });
      function renderProductMultiSelect() {
        const box = document.getElementById('productMultiSelect');
        const search = document.getElementById('productMultiSearch');
        if (!box) return;
        const q = (search?.value || '').toLowerCase();
        box.innerHTML = '';
        cache.products
          .filter(p => !q || (String(p['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').toLowerCase().includes(q) || String(p['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').toLowerCase().includes(q)))
          .forEach(p => {
            const id = String(p['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim();
            const label = `${id} ‚Äî ${String(p['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim()}`;
            box.innerHTML += `<label class="flex items-center gap-2"><input type="checkbox" class="product-multi-checkbox" value="${id}" ${selectedProjectReportProductIds.has(id) ? 'checked' : ''}> ${label}</label>`;
          });
      }
      document.getElementById('projectMultiSearch')?.addEventListener('input', renderProjectMultiSelect);
      document.getElementById('productMultiSearch')?.addEventListener('input', renderProductMultiSelect);
      renderProjectMultiSelect();
      renderProductMultiSelect();
      
      // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      document.getElementById('selectAllProjects')?.addEventListener('change', function(e) {
        const checked = e.target.checked;
        document.querySelectorAll('.project-multi-checkbox').forEach(cb => cb.checked = checked);
      });
      document.getElementById('selectAllProducts')?.addEventListener('change', function(e) {
        const checked = e.target.checked;
        document.querySelectorAll('.product-multi-checkbox').forEach(cb => cb.checked = checked);
      });
      
      // ‡∏î‡∏π‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ß‡∏î‡πâ‡∏ß‡∏¢ multi-project)
      document.getElementById('viewProjectExpenditureBtn')?.addEventListener('click', async () => {
        const resultBox = document.getElementById('projectExpenditureResult');
        resultBox.innerHTML = `<span class="inline-flex items-center gap-2 text-gray-200"><span class="w-4 h-4 border-2 border-white/60 border-t-transparent rounded-full spin"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>`;
        const projectCodes = Array.from(document.querySelectorAll('.project-multi-checkbox:checked')).map(cb=>cb.value);
        const productCodes = Array.from(document.querySelectorAll('.product-multi-checkbox:checked')).map(cb=>cb.value.toLowerCase());
        if (!projectCodes.length) {
          resultBox.innerHTML = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£';
          return;
        }
        // ‡∏™‡πà‡∏á request ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ actionType getDashboardMultiProjectExpenditure ‡πÉ‡∏ô Apps Script)
        const payload = { actionType: 'getDashboardMultiProjectExpenditure', data: { projectCodes } };
        const result = await sendToAppsScript(payload, resultBox);
        let html = '';
        if (result && result.multiProjectExpenditure) {
          projectCodes.forEach(projectCode => {
            const project = result.multiProjectExpenditure[projectCode];
            if (!project) return;
            let items = project.itemsIssued;
            if (productCodes.length) {
              items = items.filter(item => productCodes.includes(String(item.productCode||'').toLowerCase()));
            }
            html += `<div class="font-medium text-cyan-400">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£: ${projectCode}</div>
              <div class="mt-2">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å‡πÑ‡∏õ: <span class="text-blue-400 font-bold text-lg">${Number(project.totalProjectCost).toLocaleString('th-TH', {minimumFractionDigits: 2})}</span> ‡∏ö‡∏≤‡∏ó</div>
              <div class="mt-3 text-sm text-gray-300">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å:</div>
              <ul class="list-disc list-inside text-xs mt-2">
              ${items.length ? items.map(item=>`<li>${item.productName} (${item.productCode}): ${Number(item.qty).toLocaleString('th-TH')} ‡∏ä‡∏¥‡πâ‡∏ô (‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ ${Number(item.value).toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó)</li>`).join('') : '<li>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ</li>'}
              </ul>
              <hr class="my-2 border-gray-700">`;
          });
        }
        resultBox.innerHTML = html;
      });
      
      // ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel ‡∏´‡∏•‡∏≤‡∏¢‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£/‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      document.getElementById('exportProjectExpenditureBtn')?.addEventListener('click', async function() {
        const btn = this;
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å...';
        btn.classList.add('opacity-60', 'cursor-not-allowed');

        try {
          const projectCodes = Array.from(document.querySelectorAll('.project-multi-checkbox:checked')).map(cb=>cb.value);
          const productCodes = Array.from(document.querySelectorAll('.product-multi-checkbox:checked')).map(cb=>cb.value.toLowerCase());
          if (!projectCodes.length) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel');
            return;
          }
          const payload = { actionType: 'getDashboardMultiProjectExpenditure', data: { projectCodes } };
          const result = await sendToAppsScript(payload);
          let allRows = [];
          if (result && result.multiProjectExpenditure) {
            projectCodes.forEach(projectCode => {
              const project = result.multiProjectExpenditure[projectCode];
              if (!project) return;
              let items = project.itemsIssued;
              if (productCodes.length) {
                items = items.filter(item => productCodes.includes(String(item.productCode||'').toLowerCase()));
              }
              items.forEach(item => {
                allRows.push([
                  projectCode,
                  String(item.productCode||''),
                  String(item.productName||''),
                  Number(item.qty||0),
                  Number(item.value||0).toFixed(2)
                ]);
              });
            });
          }
          if (allRows.length === 0) {
            alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å');
            return;
          }
              const header = ['‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£', '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å', '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)'];
          const csvContent = '\uFEFF' + [header, ...allRows].map(r => r.join(',')).join('\r\n');
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£_‡∏´‡∏•‡∏≤‡∏¢‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
          btn.classList.remove('opacity-60', 'cursor-not-allowed');
        }
      });
    })
  </script>
</body>
